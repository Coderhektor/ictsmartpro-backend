<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICTSMARTPRO v8.0</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
/* ===== RESET & ROOT ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:        #080b12;
  --surface:   #0e1420;
  --card:      #111827;
  --border:    #1e2d45;
  --border-hi: #2563eb;
  --text:      #e2e8f0;
  --muted:     #64748b;
  --blue:      #2563eb;
  --blue-glow: rgba(37,99,235,0.25);
  --green:     #10b981;
  --green-glow:rgba(16,185,129,0.2);
  --red:       #ef4444;
  --red-glow:  rgba(239,68,68,0.2);
  --amber:     #f59e0b;
  --purple:    #8b5cf6;
  --cyan:      #22d3ee;
  --r:         10px;
  --r-sm:      6px;
  font-size: 14px;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  line-height: 1.5;
  overflow-x: hidden;
}

/* ===== TOPBAR ===== */
#topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(8,11,18,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  padding: 0 20px; height: 56px;
}

#topbar .brand {
  font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em;
  color: #fff; white-space: nowrap;
}
#topbar .brand span { color: var(--blue); }

.pill {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 99px;
  font-family: 'Space Mono', monospace; font-size: 0.72rem; font-weight: 700;
  border: 1px solid;
  transition: all 0.3s;
}
.pill.green  { color: var(--green); border-color: var(--green); background: var(--green-glow); }
.pill.red    { color: var(--red);   border-color: var(--red);   background: var(--red-glow);   }
.pill.blue   { color: var(--blue);  border-color: var(--blue);  background: var(--blue-glow);  }
.pill.muted  { color: var(--muted); border-color: var(--border); background: transparent;       }

.dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: currentColor; animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

#topbar .sep { width: 1px; height: 24px; background: var(--border); flex-shrink: 0; }
#topbar .spacer { flex: 1; }
#topbar .clock { font-family: 'Space Mono',monospace; font-size: 0.78rem; color: var(--muted); }

/* ===== LAYOUT ===== */
#app {
  display: grid;
  grid-template-columns: 1fr 340px;
  grid-template-rows: auto;
  gap: 16px;
  padding: 16px 20px;
  max-width: 1600px;
  margin: 0 auto;
}

@media (max-width: 1024px) {
  #app { grid-template-columns: 1fr; }
}

/* ===== CARD ===== */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow: hidden;
}
.card-head {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700; font-size: 0.8rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--muted);
}
.card-head i { color: var(--blue); font-size: 0.9rem; }
.card-head .badge {
  margin-left: auto;
  background: var(--border); color: var(--text);
  padding: 2px 8px; border-radius: 99px;
  font-size: 0.7rem; font-family: 'Space Mono', monospace;
}
.card-body { padding: 16px; }

/* ===== CONTROLS ===== */
#controls {
  display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
  padding: 12px 16px;
}

select, button {
  font-family: 'Syne', sans-serif;
  outline: none; border: none; cursor: pointer;
}
select {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 8px 12px;
  font-size: 0.85rem; font-weight: 600;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2364748b'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
  transition: border-color 0.2s;
}
select:focus { border-color: var(--blue); }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 20px; border-radius: var(--r-sm);
  font-size: 0.85rem; font-weight: 700;
  transition: all 0.2s; cursor: pointer;
}
.btn-primary {
  background: var(--blue); color: #fff;
  border: 1px solid var(--blue);
}
.btn-primary:hover { background: #1d4ed8; }
.btn-primary:active { transform: scale(0.97); }
.btn-outline {
  background: transparent; color: var(--blue);
  border: 1px solid var(--border);
}
.btn-outline:hover { border-color: var(--blue); background: var(--blue-glow); }

.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== PRICE PANEL ===== */
#pricePanel {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
@media (max-width: 600px) { #pricePanel { grid-template-columns: 1fr; } }

.price-card { position: relative; }
.price-val {
  font-family: 'Space Mono', monospace;
  font-size: 2.4rem; font-weight: 700; line-height: 1;
  background: linear-gradient(135deg, #fff 40%, var(--blue));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  word-break: break-all;
}
@media (max-width: 768px) { .price-val { font-size: 1.8rem; } }

.price-sym { font-size: 0.75rem; font-weight: 700; color: var(--muted); letter-spacing: 0.1em; margin-bottom: 8px; }
.price-chg {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 12px; border-radius: 99px;
  font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700;
  margin-top: 12px; margin-bottom: 16px;
}
.price-chg.up   { color: var(--green); background: var(--green-glow); border: 1px solid var(--green); }
.price-chg.down { color: var(--red);   background: var(--red-glow);   border: 1px solid var(--red);   }
.price-chg.flat { color: var(--muted); background: var(--border);     border: 1px solid var(--border); }

.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
.stat-row:last-child { border-bottom: none; }
.stat-row .label { font-size: 0.78rem; color: var(--muted); }
.stat-row .val   { font-family: 'Space Mono', monospace; font-size: 0.82rem; font-weight: 700; }

.flash { animation: flashAnim 0.4s ease; }
@keyframes flashAnim {
  0%  { color: var(--cyan); }
  100%{ color: inherit; }
}

/* ===== SIGNAL ===== */
.signal-wrap { text-align: center; padding: 8px 0; }
.signal-label {
  display: inline-block;
  padding: 14px 28px; border-radius: var(--r);
  font-size: 1.2rem; font-weight: 800; letter-spacing: 0.06em;
  margin-bottom: 16px; text-transform: uppercase; width: 100%;
  transition: all 0.4s;
}
.sig-STRONG_BUY  { background: linear-gradient(135deg,#10b981,#059669); color:#fff; }
.sig-BUY         { background: linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; }
.sig-NEUTRAL     { background: linear-gradient(135deg,#475569,#334155); color:#fff; }
.sig-SELL        { background: linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
.sig-STRONG_SELL { background: linear-gradient(135deg,#dc2626,#b91c1c); color:#fff; }
.sig-default     { background: var(--border); color: var(--muted); }

.conf-bar-wrap { background: var(--surface); border-radius: 99px; height: 8px; margin: 8px 0; overflow: hidden; }
.conf-bar { height: 100%; border-radius: 99px; background: var(--blue); transition: width 0.6s ease; }
.conf-pct { font-family: 'Space Mono', monospace; font-size: 0.78rem; color: var(--muted); }
.rec-text { font-size: 0.82rem; color: var(--muted); margin-top: 8px; min-height: 20px; line-height: 1.4; }

/* ===== TRADINGVIEW CHART ===== */
#chartSection { margin-bottom: 16px; }

#chartOuter {
  position: relative;
  width: 100%;
  padding-top: 56.25%; /* 16:9 */
  min-height: 350px;
  background: var(--surface);
  border-radius: 0 0 var(--r) var(--r);
  overflow: hidden;
}
@media (min-height: 700px) {
  #chartOuter { padding-top: 0; height: 500px; }
}
@media (max-width: 768px) {
  #chartOuter { padding-top: 0; height: 300px; }
}

#tvContainer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
}

#chartSpinner {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: var(--surface); gap: 12px;
  transition: opacity 0.5s;
  z-index: 5;
}
#chartSpinner .spin-big {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
#chartSpinner p { color: var(--muted); font-size: 0.82rem; }
#chartSpinner.hidden { opacity: 0; pointer-events: none; }

/* ===== INDICATOR ROWS ===== */
.ind-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
@media (max-width: 600px) { .ind-grid { grid-template-columns: 1fr; } }

.ind-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px;
}
.ind-box .ind-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 4px; }
.ind-box .ind-val   { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; }
.ind-box .ind-sub   { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }

.text-green  { color: var(--green) !important; }
.text-red    { color: var(--red)   !important; }
.text-amber  { color: var(--amber) !important; }
.text-blue   { color: var(--blue)  !important; }
.text-muted  { color: var(--muted) !important; }
.text-white  { color: #fff !important; }

/* ===== PATTERNS ===== */
.pattern-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px; }
.chip {
  padding: 4px 10px; border-radius: 99px;
  font-size: 0.73rem; font-weight: 700; letter-spacing: 0.03em;
}
.chip.bull  { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }
.chip.bear  { background: var(--red-glow);   color: var(--red);   border: 1px solid var(--red);   }
.chip.neut  { background: var(--border);     color: var(--muted); border: 1px solid var(--border); }

/* ===== MARKET STRUCTURE ===== */
.ms-rows .ms-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 9px 0; border-bottom: 1px solid var(--border);
}
.ms-rows .ms-row:last-child { border-bottom: none; }
.ms-rows .ms-row .ms-label { font-size: 0.78rem; color: var(--muted); }
.ms-rows .ms-row .ms-val   { font-weight: 700; font-size: 0.85rem; }

/* ===== RIGHT COLUMN ===== */
#rightCol { display: flex; flex-direction: column; gap: 16px; }

/* ===== ML MODELS ===== */
.ml-model { margin-bottom: 12px; }
.ml-model:last-child { margin-bottom: 0; }
.ml-model .ml-row  { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8rem; }
.ml-model .ml-name { color: var(--text); font-weight: 600; }
.ml-model .ml-pct  { font-family: 'Space Mono', monospace; font-weight: 700; }
.ml-bar-bg  { background: var(--surface); border-radius: 99px; height: 6px; overflow: hidden; }
.ml-bar     { height: 100%; border-radius: 99px; transition: width 0.6s ease; }
.ml-bar.info   { background: var(--cyan); }
.ml-bar.succ   { background: var(--green); }
.ml-bar.purp   { background: var(--purple); }
.ml-bar.warn   { background: var(--amber); }

/* ===== DATA POOL ===== */
.pool-stat { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
.pool-stat:last-child { border-bottom: none; }
.pool-stat .ps-label { font-size: 0.78rem; color: var(--muted); }
.pool-stat .ps-val   { font-family: 'Space Mono', monospace; font-size: 0.82rem; font-weight: 700; }
.health-bar { background: var(--surface); border-radius: 99px; height: 8px; margin: 12px 0 8px; overflow: hidden; }
.health-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--blue), var(--green)); transition: width 0.6s ease; }

/* ===== EXCHANGE GRID ===== */
#exchangeGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 6px;
  max-height: 280px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
#exchangeGrid::-webkit-scrollbar { width: 4px; }
#exchangeGrid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.ex-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 8px 4px; text-align: center;
  transition: all 0.2s;
}
.ex-item.ok   { border-color: var(--green); background: var(--green-glow); }
.ex-item.err  { border-color: var(--red);   opacity: 0.55; }
.ex-item .ex-name { font-size: 0.65rem; font-weight: 700; display: block; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }
.ex-item .ex-status { font-size: 0.75rem; }

/* ===== AI CHAT ===== */
#chatBox {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px;
  min-height: 120px; max-height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
  scrollbar-width: thin;
}
.chat-msg {
  background: rgba(37,99,235,0.08);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 10px 12px;
  margin-bottom: 8px;
  font-size: 0.8rem;
  line-height: 1.5;
}
.chat-msg .chat-head { font-weight: 700; color: var(--blue); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.chat-msg .chat-warn { color: var(--amber); font-size: 0.72rem; margin-top: 6px; }
.chat-empty { color: var(--muted); font-size: 0.8rem; }

/* ===== ERROR / EMPTY STATES ===== */
.state-empty { color: var(--muted); font-size: 0.8rem; font-style: italic; }

/* ===== SCROLLBAR ===== */
* { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* ===== RESPONSIVE GRID ===== */
#leftCol { display: flex; flex-direction: column; gap: 16px; }

/* ===== BOTTOM ROW ===== */
#bottomRow {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
#bottomRow2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media (max-width: 600px) {
  #bottomRow, #bottomRow2 { grid-template-columns: 1fr; }
}

/* ===== STATUS ROW ===== */
#statusRow {
  display: flex; align-items: center; gap: 8px;
  padding: 0 20px 12px;
  max-width: 1600px; margin: 0 auto;
}
#statusRow .update-time { font-family:'Space Mono',monospace; font-size:0.72rem; color:var(--muted); margin-left: auto; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="brand">ICT<span>SMART</span>PRO <span style="color:var(--muted);font-size:0.75rem;font-weight:600;">v8.0</span></div>
  <div class="sep"></div>
  <div class="pill green" id="backendPill"><div class="dot"></div><span>BACKEND</span></div>
  <div class="pill muted" id="wsPill"><i class="fas fa-wifi"></i><span id="wsLabel">WS BAƒûLANIYOR</span></div>
  <div class="spacer"></div>
  <div class="clock" id="clockEl"></div>
</div>

<!-- STATUS ROW -->
<div id="statusRow">
  <span id="sourceCountBadge" class="pill blue"><i class="fas fa-server"></i> 0/32 Borsa</span>
  <span id="lastUpdateText" class="update-time">Son g√ºncelleme: ‚Äî</span>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- LEFT COLUMN -->
  <div id="leftCol">

    <!-- Controls -->
    <div class="card">
      <div class="card-head"><i class="fas fa-sliders-h"></i> ANALƒ∞Z KONTROL√ú</div>
      <div id="controls">
        <select id="symbolSelect">
          <option value="BTC">BTC/USDT</option>
          <option value="ETH">ETH/USDT</option>
          <option value="SOL">SOL/USDT</option>
          <option value="BNB">BNB/USDT</option>
          <option value="XRP">XRP/USDT</option>
          <option value="ADA">ADA/USDT</option>
          <option value="DOGE">DOGE/USDT</option>
          <option value="AVAX">AVAX/USDT</option>
        </select>
        <select id="intervalSelect">
          <option value="1m">1 Dakika</option>
          <option value="5m">5 Dakika</option>
          <option value="15m">15 Dakika</option>
          <option value="30m">30 Dakika</option>
          <option value="1h" selected>1 Saat</option>
          <option value="4h">4 Saat</option>
          <option value="1d">1 G√ºn</option>
          <option value="1w">1 Hafta</option>
        </select>
        <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeSymbol()">
          <i class="fas fa-search"></i> ANALƒ∞Z ET
        </button>
      </div>
    </div>

    <!-- Price + Signal -->
    <div id="pricePanel">

      <!-- Price Card -->
      <div class="card price-card">
        <div class="card-head"><i class="fas fa-dollar-sign"></i> CANLI Fƒ∞YAT</div>
        <div class="card-body">
          <div class="price-sym" id="priceSymLabel">BTC / USDT</div>
          <div class="price-val" id="priceEl">‚Äî</div>
          <div class="price-chg flat" id="priceChgEl"><i class="fas fa-minus"></i> 0.00%</div>
          <div class="stat-row" style="margin-top:12px">
            <span class="label">24s Hacim</span>
            <span class="val" id="volEl">‚Äî</span>
          </div>
          <div class="stat-row">
            <span class="label">Kaynak Sayƒ±sƒ±</span>
            <span class="val" id="srcCountEl">‚Äî</span>
          </div>
          <div class="stat-row">
            <span class="label">Y√ºksek / D√º≈ü√ºk</span>
            <span class="val" id="hiLoEl">‚Äî / ‚Äî</span>
          </div>
        </div>
      </div>

      <!-- Signal Card -->
      <div class="card">
        <div class="card-head"><i class="fas fa-brain"></i> ML Sƒ∞NYALƒ∞</div>
        <div class="card-body signal-wrap">
          <div class="signal-label sig-default" id="signalLabel">ANALƒ∞Z BEKLENƒ∞YOR</div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
              <span style="font-size:0.75rem;color:var(--muted)">G√ºven</span>
              <span class="conf-pct" id="confPct">%0</span>
            </div>
            <div class="conf-bar-wrap"><div class="conf-bar" id="confBar" style="width:0%"></div></div>
          </div>
          <div class="rec-text" id="recText">‚Äî</div>
        </div>
      </div>

    </div>

    <!-- TradingView Chart -->
    <div class="card" id="chartSection">
      <div class="card-head">
        <i class="fas fa-chart-candlestick"></i> CANLI GRAFƒ∞K
        <span class="badge" id="chartBadge">TradingView</span>
      </div>
      <div id="chartOuter">
        <div id="tvContainer"></div>
        <div id="chartSpinner">
          <div class="spin-big"></div>
          <p>Grafik y√ºkleniyor...</p>
        </div>
      </div>
    </div>

    <!-- Indicators Row -->
    <div id="bottomRow">
      <!-- Heikin Ashi -->
      <div class="card">
        <div class="card-head"><i class="fas fa-chart-bar"></i> HEƒ∞Kƒ∞N ASHƒ∞</div>
        <div class="card-body">
          <div class="ind-grid">
            <div class="ind-box">
              <div class="ind-label">Trend</div>
              <div class="ind-val" id="haTrend">‚Äî</div>
            </div>
            <div class="ind-box">
              <div class="ind-label">RSI</div>
              <div class="ind-val" id="haRsi">‚Äî</div>
            </div>
            <div class="ind-box">
              <div class="ind-label">G√º√ß</div>
              <div class="ind-val" id="haStr">‚Äî</div>
            </div>
            <div class="ind-box">
              <div class="ind-label">Renk</div>
              <div class="ind-val" id="haColor">‚ö™</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Technical -->
      <div class="card">
        <div class="card-head"><i class="fas fa-flask"></i> TEKNƒ∞K G√ñSTERGELER</div>
        <div class="card-body">
          <div id="techRows">
            <div class="state-empty">Analiz bekleniyor...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Patterns + Market Structure -->
    <div id="bottomRow2">
      <div class="card">
        <div class="card-head"><i class="fas fa-shapes"></i> PATERNLER</div>
        <div class="card-body">
          <div class="pattern-chips" id="patternsEl">
            <span class="state-empty">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><i class="fas fa-water"></i> MARKET YAPISI</div>
        <div class="card-body">
          <div class="ms-rows" id="msRows">
            <div class="ms-row"><span class="ms-label">Trend</span><span class="ms-val" id="msTrend">‚Äî</span></div>
            <div class="ms-row"><span class="ms-label">Yapƒ±</span><span class="ms-val" id="msStruct">‚Äî</span></div>
            <div class="ms-row"><span class="ms-label">Volatilite</span><span class="ms-val" id="msVol">‚Äî</span></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /leftCol -->

  <!-- RIGHT COLUMN -->
  <div id="rightCol">

    <!-- ML Models -->
    <div class="card">
      <div class="card-head"><i class="fas fa-microchip"></i> ML MODELLERƒ∞</div>
      <div class="card-body">
        <div class="ml-model">
          <div class="ml-row"><span class="ml-name">LightGBM</span><span class="ml-pct" id="lgbmPct">0%</span></div>
          <div class="ml-bar-bg"><div class="ml-bar info" id="lgbmBar" style="width:0%"></div></div>
        </div>
        <div class="ml-model">
          <div class="ml-row"><span class="ml-name">XGBoost</span><span class="ml-pct" id="xgbPct">0%</span></div>
          <div class="ml-bar-bg"><div class="ml-bar succ" id="xgbBar" style="width:0%"></div></div>
        </div>
        <div class="ml-model">
          <div class="ml-row"><span class="ml-name">Transformer</span><span class="ml-pct" id="tfPct">0%</span></div>
          <div class="ml-bar-bg"><div class="ml-bar purp" id="tfBar" style="width:0%"></div></div>
        </div>
        <div class="ml-model">
          <div class="ml-row"><span class="ml-name">Random Forest</span><span class="ml-pct" id="rfPct">0%</span></div>
          <div class="ml-bar-bg"><div class="ml-bar warn" id="rfBar" style="width:0%"></div></div>
        </div>
        <button class="btn btn-outline" style="width:100%;margin-top:14px;justify-content:center" id="trainBtn" onclick="trainModels()">
          <i class="fas fa-sync-alt"></i> Modelleri Eƒüit
        </button>
      </div>
    </div>

    <!-- Data Pool -->
    <div class="card">
      <div class="card-head"><i class="fas fa-database"></i> VERƒ∞ HAVUZU</div>
      <div class="card-body">
        <div class="pool-stat"><span class="ps-label">Toplam Borsa</span><span class="ps-val">32</span></div>
        <div class="pool-stat"><span class="ps-label">Aktif Kaynak</span><span class="ps-val text-green" id="poolActive">‚Äî</span></div>
        <div class="pool-stat"><span class="ps-label">Ba≈üarƒ±sƒ±z</span><span class="ps-val text-red" id="poolFail">‚Äî</span></div>
        <div class="pool-stat"><span class="ps-label">Cache TTL</span><span class="ps-val">60s</span></div>
        <div class="health-bar"><div class="health-fill" id="healthFill" style="width:0%"></div></div>
        <div style="font-size:0.72rem;color:var(--muted)" id="poolUpdate">‚Äî</div>
      </div>
    </div>

    <!-- Exchange Status -->
    <div class="card">
      <div class="card-head">
        <i class="fas fa-cloud"></i> BORSA DURUMU
        <span class="badge" id="exActiveBadge">0/32</span>
      </div>
      <div class="card-body" style="padding:10px">
        <div id="exchangeGrid"></div>
      </div>
    </div>

    <!-- AI Assistant -->
    <div class="card">
      <div class="card-head"><i class="fas fa-robot"></i> AI ASƒ∞STAN</div>
      <div class="card-body">
        <div id="chatBox">
          <div class="chat-empty"><i class="fas fa-info-circle"></i> Analiz yaptƒ±ktan sonra "Deƒüerlendir" butonuna tƒ±klayƒ±n.</div>
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="evaluateAI()">
          <i class="fas fa-brain"></i> DEƒûERLENDƒ∞R
        </button>
      </div>
    </div>

  </div><!-- /rightCol -->

</div><!-- /app -->

<script>
// =============================================
//  CONSTANTS
// =============================================
const EXCHANGES = [
  "Binance","Bybit","OKX","KuCoin","Gate.io","MEXC","Kraken",
  "Bitfinex","Huobi","Coinbase","Bitget","BinanceUS","Crypto.com",
  "Gemini","Poloniex","Bittrex","Bitstamp","LBank","AscendEX",
  "BingX","Phemex","WazirX","CoinEx","DigiFinex","XT.com","ProBit",
  "BKEX","Hotbit","ZB.com","Bibox","HitBTC","EXMO"
];

// =============================================
//  STATE
// =============================================
let state = {
  ws: null, wsRetries: 0,
  tvWidget: null, chartReady: false,
  currentData: null,
  lastPrice: null
};

// =============================================
//  UTILS
// =============================================
function fmt(n, d = 2) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  return Number(n).toLocaleString('tr-TR', { minimumFractionDigits: d, maximumFractionDigits: d });
}
function fmtVol(v) {
  if (!v || isNaN(v)) return '‚Äî';
  if (v >= 1e9) return (v / 1e9).toFixed(2) + 'B';
  if (v >= 1e6) return (v / 1e6).toFixed(2) + 'M';
  if (v >= 1e3) return (v / 1e3).toFixed(2) + 'K';
  return Number(v).toFixed(2);
}
function fmtTime(d) {
  d = d || new Date();
  return d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
function fmtPrice(p) {
  if (!p) return '‚Äî';
  if (p >= 10000) return '$' + fmt(p, 0);
  if (p >= 1)     return '$' + fmt(p, 2);
  return '$' + Number(p).toFixed(6);
}
function clamp(v, lo, hi) { return Math.min(hi, Math.max(lo, v)); }

const $ = id => document.getElementById(id);
const set = (id, val) => { const el = $(id); if (el) el.textContent = val; };
const setHTML = (id, val) => { const el = $(id); if (el) el.innerHTML = val; };

// =============================================
//  CLOCK
// =============================================
function tickClock() { $('clockEl').textContent = fmtTime(); }
setInterval(tickClock, 1000); tickClock();

// =============================================
//  EXCHANGE GRID
// =============================================
function buildExchangeGrid() {
  const grid = $('exchangeGrid');
  if (!grid) return;
  grid.innerHTML = EXCHANGES.map(ex => {
    const id = 'ex_' + ex.toLowerCase().replace(/[^a-z0-9]/g, '');
    return `<div class="ex-item" id="${id}">
      <span class="ex-name">${ex}</span>
      <span class="ex-status" id="${id}_s">‚è≥</span>
    </div>`;
  }).join('');
}

function updateExchangeGrid(stats) {
  if (!stats || typeof stats !== 'object') return;
  let active = 0, fail = 0;
  for (const [name, data] of Object.entries(stats)) {
    const id = 'ex_' + name.toLowerCase().replace(/[^a-z0-9]/g, '');
    const el = $(id), st = $(id + '_s');
    if (!el || !st) continue;
    const ok = (data.success || 0) > 0;
    const ko = (data.fail    || 0) > 0 && !ok;
    el.className = 'ex-item' + (ok ? ' ok' : ko ? ' err' : '');
    st.textContent = ok ? '‚úÖ' : ko ? '‚ùå' : '‚è≥';
    if (ok) active++;
    if (ko) fail++;
  }
  $('exActiveBadge').textContent = `${active}/32`;
  $('sourceCountBadge').innerHTML = `<i class="fas fa-server"></i> ${active}/32 Borsa`;
  set('poolActive', active);
  set('poolFail', fail);
  const health = active > 0 ? clamp((active / 32) * 100, 0, 100) : 0;
  $('healthFill').style.width = health + '%';
  $('poolUpdate').textContent = 'G√ºncellendi: ' + fmtTime();
}

// =============================================
//  TRADINGVIEW
// =============================================
const TV_INTERVAL_MAP = {
  '1m':'1','5m':'5','15m':'15','30m':'30',
  '1h':'60','4h':'240','1d':'D','1w':'W'
};

function initTradingView() {
  const sym      = $('symbolSelect').value;
  const interval = TV_INTERVAL_MAP[$('intervalSelect').value] || '60';
  const container = $('tvContainer');
  if (!container) return;

  // Destroy old
  if (state.tvWidget) {
    try { state.tvWidget.remove(); } catch(e) {}
    state.tvWidget = null;
  }
  container.innerHTML = '';
  $('chartSpinner').classList.remove('hidden');
  state.chartReady = false;

  // Guard: wait for TradingView lib
  if (typeof TradingView === 'undefined') {
    setTimeout(initTradingView, 800);
    return;
  }

  try {
    state.tvWidget = new TradingView.widget({
      autosize:         true,
      symbol:           `BINANCE:${sym}USDT`,
      interval:         interval,
      timezone:         'Europe/Istanbul',
      theme:            'dark',
      style:            '1',
      locale:           'tr',
      toolbar_bg:       '#0e1420',
      enable_publishing: false,
      allow_symbol_change: true,
      hide_top_toolbar:  false,
      hide_side_toolbar: false,
      studies: ['RSI@tv-basicstudies','MACD@tv-basicstudies'],
      container_id:     'tvContainer',
      overrides: {
        'paneProperties.background':              '#0e1420',
        'paneProperties.vertGridProperties.color':'#1e2d45',
        'paneProperties.horzGridProperties.color':'#1e2d45',
      },
      disabled_features: [
        'header_saveload','header_undo_redo','header_screenshot',
        'timeframes_toolbar'
      ],
      onready: () => {
        state.chartReady = true;
        setTimeout(() => {
          $('chartSpinner').classList.add('hidden');
        }, 400);
      }
    });
  } catch(e) {
    console.error('TradingView init error:', e);
    $('chartSpinner').classList.add('hidden');
  }

  // Fallback hide spinner
  setTimeout(() => $('chartSpinner').classList.add('hidden'), 6000);
}

// =============================================
//  WEBSOCKET
// =============================================
function connectWS() {
  const sym = $('symbolSelect').value + 'USDT';
  const url = `ws://${location.host}/ws/${sym}`;

  if (state.ws) {
    try { state.ws.close(); } catch(e) {}
    state.ws = null;
  }

  try {
    const ws = new WebSocket(url);
    state.ws = ws;

    ws.onopen = () => {
      state.wsRetries = 0;
      setPill('wsPill','green','BAƒûLANDI');
      set('wsLabel', 'BAƒûLANDI');
    };

    ws.onmessage = (e) => {
      try {
        const d = JSON.parse(e.data);
        if (d.type === 'price_update') renderWSPrice(d);
      } catch {}
    };

    ws.onerror = () => setPill('wsPill','red','HATA');

    ws.onclose = () => {
      setPill('wsPill','muted','KAPALI');
      set('wsLabel','KAPALI');
      if (state.wsRetries < 8) {
        state.wsRetries++;
        setTimeout(connectWS, 3000 + state.wsRetries * 1000);
      }
    };
  } catch(e) {
    console.error('WS error:', e);
  }
}

function setPill(id, cls, label) {
  const el = $(id);
  if (!el) return;
  el.className = 'pill ' + cls;
  const sp = el.querySelector('span');
  if (sp) sp.textContent = label;
}

function renderWSPrice(d) {
  const price = d.price;
  const chgPct = d.change_percent;

  // Flash if changed
  const priceEl = $('priceEl');
  if (state.lastPrice !== price) {
    priceEl.classList.remove('flash');
    void priceEl.offsetWidth;
    priceEl.classList.add('flash');
    state.lastPrice = price;
  }
  priceEl.textContent = fmtPrice(price);

  const chgEl = $('priceChgEl');
  if (chgEl) {
    const up = chgPct >= 0;
    chgEl.className = 'price-chg ' + (up ? 'up' : 'down');
    chgEl.innerHTML = `<i class="fas fa-arrow-${up ? 'up' : 'down'}"></i> ${up ? '+' : ''}${(+chgPct).toFixed(2)}%`;
  }

  if (d.volume) set('volEl', fmtVol(d.volume));
  if (d.source_count !== undefined) set('srcCountEl', d.source_count);

  set('lastUpdateText', 'Son g√ºncelleme: ' + fmtTime());
}

// =============================================
//  ANALYZE
// =============================================
async function analyzeSymbol() {
  const sym      = $('symbolSelect').value + 'USDT';
  const interval = $('intervalSelect').value;
  const btn      = $('analyzeBtn');

  btn.innerHTML = '<div class="spinner"></div> Analiz Ediliyor...';
  btn.disabled = true;

  try {
    const res = await fetch(`/api/analyze/${sym}?interval=${interval}&limit=200`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.detail || 'Ba≈üarƒ±sƒ±z');
    state.currentData = data;
    renderDashboard(data);
  } catch(e) {
    console.error('Analyze error:', e);
    // Show error in signal
    $('signalLabel').textContent = 'HATA: ' + e.message;
    $('signalLabel').className = 'signal-label sig-NEUTRAL';
  } finally {
    btn.innerHTML = '<i class="fas fa-search"></i> ANALƒ∞Z ET';
    btn.disabled = false;
  }
}

// =============================================
//  RENDER DASHBOARD
// =============================================
function renderDashboard(d) {
  if (!d) return;

  // Symbol label
  const sym = (d.symbol || 'BTC/USDT').replace('USDT', ' / USDT');
  set('priceSymLabel', sym);

  // Price
  if (d.price_data) {
    const pd = d.price_data;
    const priceEl = $('priceEl');
    priceEl.textContent = fmtPrice(pd.current);
    priceEl.classList.remove('flash');
    void priceEl.offsetWidth;
    priceEl.classList.add('flash');

    // Change %
    const chg = pd.change_24h ?? null;
    const chgEl = $('priceChgEl');
    if (chgEl && chg !== null) {
      const up = chg >= 0;
      chgEl.className = 'price-chg ' + (up ? 'up' : 'down');
      chgEl.innerHTML = `<i class="fas fa-arrow-${up ? 'up' : 'down'}"></i> ${up ? '+' : ''}${(+chg).toFixed(2)}%`;
    }

    if (pd.volume_24h !== undefined) set('volEl', fmtVol(pd.volume_24h));
    if (pd.source_count !== undefined) set('srcCountEl', pd.source_count);

    const hi = pd.high_24h ? fmtPrice(pd.high_24h) : '‚Äî';
    const lo = pd.low_24h  ? fmtPrice(pd.low_24h)  : '‚Äî';
    set('hiLoEl', `${hi} / ${lo}`);
  }

  // Signal
  if (d.signal) {
    const s = d.signal;
    const sig = (s.signal || 'NEUTRAL').toUpperCase();
    const conf = Number(s.confidence || 0);
    const lbl = $('signalLabel');
    lbl.textContent = sig.replace(/_/g, ' ');
    lbl.className = 'signal-label sig-' + sig;
    $('confBar').style.width = clamp(conf, 0, 100) + '%';
    set('confPct', '%' + Math.round(conf));
    set('recText', s.recommendation || '‚Äî');
  }

  // Heikin Ashi + Technical
  if (d.technical_indicators) {
    const t = d.technical_indicators;

    // HA
    const haColorVal = t.ha_color_change === 1 ? 'üü¢' : t.ha_color_change === -1 ? 'üî¥' : '‚ö™';
    set('haTrend', t.ha_trend || '‚Äî');
    set('haRsi',   t.ha_rsi   ? fmt(t.ha_rsi, 1) : '‚Äî');
    set('haStr',   t.ha_trend_strength ? fmt(t.ha_trend_strength, 0) + '%' : '‚Äî');
    set('haColor', haColorVal);

    // Technical rows
    const rows = [];
    if (t.rsi_value !== undefined)   rows.push(['RSI', fmt(t.rsi_value, 1), rsiColor(t.rsi_value)]);
    if (t.macd_histogram !== undefined) rows.push(['MACD Hist.', (t.macd_histogram >= 0 ? '+' : '') + fmt(t.macd_histogram, 5), t.macd_histogram >= 0 ? 'text-green' : 'text-red']);
    if (t.bb_position !== undefined) rows.push(['Bollinger %', fmt(t.bb_position, 1) + '%', '']);
    if (t.volume_ratio !== undefined) rows.push(['Hacim Oranƒ±', fmt(t.volume_ratio, 2) + 'x', t.volume_ratio > 1.5 ? 'text-green' : '']);
    if (t.stoch_k !== undefined) rows.push(['Stochastic K', fmt(t.stoch_k, 1), '']);
    if (t.atr !== undefined) rows.push(['ATR', fmt(t.atr, 4), 'text-amber']);
    if (t.ema20 !== undefined) rows.push(['EMA 20', fmtPrice(t.ema20), 'text-blue']);
    if (t.ema50 !== undefined) rows.push(['EMA 50', fmtPrice(t.ema50), 'text-blue']);

    if (rows.length) {
      setHTML('techRows', rows.map(([lbl, val, cls]) =>
        `<div class="stat-row"><span class="label">${lbl}</span><span class="val ${cls}">${val}</span></div>`
      ).join(''));
    } else {
      setHTML('techRows', '<span class="state-empty">Veri yok</span>');
    }
  }

  // Patterns
  if (d.patterns && d.patterns.length > 0) {
    setHTML('patternsEl', d.patterns.slice(0, 8).map(p => {
      const cls = p.direction === 'bullish' ? 'bull' : p.direction === 'bearish' ? 'bear' : 'neut';
      return `<span class="chip ${cls}">${p.name}</span>`;
    }).join(''));
  } else {
    setHTML('patternsEl', '<span class="state-empty">Patern bulunamadƒ±</span>');
  }

  // Market structure
  if (d.market_structure) {
    const ms = d.market_structure;
    set('msTrend',  ms.trend      || '‚Äî');
    set('msStruct', ms.structure  || '‚Äî');
    set('msVol',    ms.volatility || '‚Äî');
  }

  // ML stats
  if (d.ml_stats) {
    const ms = d.ml_stats;
    const pairs = [
      ['lgbm', 'lightgbm'], ['xgb', 'xgboost'],
      ['tf', 'transformer'], ['rf', 'random_forest']
    ];
    pairs.forEach(([key, field]) => {
      const v = Number(ms[field] || 0);
      set(`${key}Pct`, fmt(v, 1) + '%');
      $(`${key}Bar`).style.width = clamp(v, 0, 100) + '%';
    });
  }

  // Update time
  set('lastUpdateText', 'Son g√ºncelleme: ' + fmtTime());

  // Fetch exchange stats after analysis
  fetchExchangeStats();
}

function rsiColor(v) {
  if (v >= 70) return 'text-red';
  if (v <= 30) return 'text-green';
  return '';
}

// =============================================
//  EXCHANGE STATS
// =============================================
async function fetchExchangeStats() {
  try {
    const res = await fetch('/api/exchange-stats');
    if (!res.ok) return;
    const d = await res.json();
    if (d.success && d.stats) updateExchangeGrid(d.stats);
  } catch(e) {
    console.error('Exchange stats error:', e);
  }
}

// =============================================
//  TRAIN
// =============================================
async function trainModels() {
  const sym = $('symbolSelect').value + 'USDT';
  const btn = $('trainBtn');
  btn.innerHTML = '<div class="spinner"></div> Eƒüitiliyor...';
  btn.disabled = true;
  try {
    const res = await fetch(`/api/train/${sym}`, { method: 'POST' });
    if (res.ok) {
      btn.innerHTML = '<i class="fas fa-check"></i> Tamamlandƒ±!';
      setTimeout(analyzeSymbol, 1500);
    } else {
      btn.innerHTML = '<i class="fas fa-times"></i> Hata';
    }
  } catch(e) {
    btn.innerHTML = '<i class="fas fa-times"></i> Baƒülantƒ± Hatasƒ±';
  } finally {
    setTimeout(() => {
      btn.innerHTML = '<i class="fas fa-sync-alt"></i> Modelleri Eƒüit';
      btn.disabled = false;
    }, 3000);
  }
}

// =============================================
//  AI EVALUATE
// =============================================
function evaluateAI() {
  const d = state.currentData;
  if (!d) {
    alert('√ñnce analiz yapƒ±n.');
    return;
  }
  const chatBox = $('chatBox');
  const sig     = d.signal?.signal || 'NEUTRAL';
  const conf    = d.signal?.confidence || 0;
  const price   = d.price_data?.current || 0;
  const rsi     = d.technical_indicators?.rsi_value || 50;
  const rec     = d.signal?.recommendation || '';
  const trend   = d.market_structure?.trend || '‚Äî';
  const vol     = d.market_structure?.volatility || '‚Äî';

  let comment = '';
  if (conf > 75) comment = 'Y√ºksek g√ºven seviyesi ‚Äì sinyal g√º√ßl√º g√∂r√ºn√ºyor.';
  else if (conf > 55) comment = 'Orta g√ºven ‚Äì ek teyit √∂nerilir.';
  else comment = 'D√º≈ü√ºk g√ºven ‚Äì temkinli yakla≈üƒ±lmalƒ±.';

  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.innerHTML = `
    <div class="chat-head"><i class="fas fa-robot"></i> AI √ñzeti</div>
    <div><b>Sinyal:</b> ${sig.replace(/_/g,' ')} (%${Math.round(conf)})</div>
    <div><b>Fiyat:</b> ${fmtPrice(price)} | <b>RSI:</b> ${(+rsi).toFixed(1)}</div>
    <div><b>Trend:</b> ${trend} | <b>Volatilite:</b> ${vol}</div>
    ${rec ? `<div><b>√ñneri:</b> ${rec}</div>` : ''}
    <div style="margin-top:6px;color:var(--cyan)">${comment}</div>
    <div class="chat-warn"><i class="fas fa-triangle-exclamation"></i> Bu bir yatƒ±rƒ±m tavsiyesi deƒüildir.</div>
  `;
  // Clear empty state
  const empty = chatBox.querySelector('.chat-empty');
  if (empty) empty.remove();

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// =============================================
//  EVENT LISTENERS
// =============================================
$('symbolSelect').addEventListener('change', () => {
  initTradingView();
  connectWS();
  analyzeSymbol();
});

$('intervalSelect').addEventListener('change', () => {
  initTradingView();
  analyzeSymbol();
});

// =============================================
//  INIT
// =============================================
async function init() {
  // Build exchange grid first
  buildExchangeGrid();

  // Check backend health
  try {
    const r = await fetch('/health');
    if (r.ok) {
      setPill('backendPill', 'green', 'BACKEND');
    } else {
      setPill('backendPill', 'red', 'BACKEND HATA');
    }
  } catch {
    setPill('backendPill', 'red', 'BAƒûLANTI YOK');
  }

  // Init chart (slight delay for DOM settle)
  setTimeout(initTradingView, 100);

  // Connect WS
  connectWS();

  // First analysis
  setTimeout(analyzeSymbol, 800);

  // Periodic exchange stats
  setInterval(fetchExchangeStats, 30_000);
}

window.addEventListener('load', init);
</script>
</body>
</html>
