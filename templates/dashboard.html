<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ ICTSMARTPRO v7.0 ‚Ä¢ 11+ Borsa ‚Ä¢ Ger√ßek Zamanlƒ± Analiz</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- TradingView Library -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #0f1520;
            --bg-card: #141a27;
            --accent-blue: #3b82f6;
            --accent-cyan: #00e5ff;
            --accent-green: #00ff9d;
            --accent-red: #ff3860;
            --accent-purple: #bd00ff;
            --accent-amber: #ffe100;
            --text-primary: #ffffff;
            --text-secondary: #b0b0d0;
            --border-color: rgba(0, 229, 255, 0.2);
            --neon-blue: 0 0 20px rgba(59, 130, 246, 0.5);
            --neon-cyan: 0 0 20px rgba(0, 229, 255, 0.5);
            --neon-green: 0 0 20px rgba(0, 255, 157, 0.5);
            --neon-red: 0 0 20px rgba(255, 56, 96, 0.5);
            --neon-purple: 0 0 20px rgba(189, 0, 255, 0.5);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navbar */
        .navbar {
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--accent-cyan);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.6rem;
            background: linear-gradient(135deg, #fff, var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-badge {
            background: rgba(0, 229, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 50px;
            padding: 0.4rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .connection-badge.connected {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
            padding: 1.2rem 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .card-header i {
            margin-right: 0.8rem;
            color: var(--accent-cyan);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Chart Container - PROPER SIZING */
        .chart-wrapper {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 0;
            height: 600px;
            width: 100%;
            overflow: hidden;
        }

        #tradingview-widget {
            width: 100%;
            height: 100%;
            min-height: 550px;
        }

        /* Price Display */
        .price-large {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1.2;
            background: linear-gradient(135deg, #fff, var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .price-change {
            font-size: 1.4rem;
            font-weight: 700;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            display: inline-block;
        }

        .price-change.up {
            background: rgba(0, 255, 157, 0.15);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .price-change.down {
            background: rgba(255, 56, 96, 0.15);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        /* Signal Badge */
        .signal-badge {
            padding: 1.5rem;
            border-radius: 50px;
            font-weight: 800;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .signal-strong-buy { background: linear-gradient(135deg, #00ff9d, #00b8ff); color: #000; }
        .signal-buy { background: linear-gradient(135deg, #00b8ff, #3b82f6); color: #fff; }
        .signal-neutral { background: linear-gradient(135deg, #bd00ff, #7c4dff); color: #fff; }
        .signal-sell { background: linear-gradient(135deg, #ff3860, #ff1744); color: #fff; }
        .signal-strong-sell { background: linear-gradient(135deg, #ff0000, #ff3860); color: #fff; }

        /* Confidence Bar */
        .confidence-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 50px;
            transition: width 0.5s ease;
        }

        /* Progress Bars */
        .progress {
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            margin: 0.5rem 0;
        }

        .progress-bar {
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bg-buy { background: linear-gradient(90deg, #00ff9d, #00b8ff); }
        .bg-sell { background: linear-gradient(90deg, #ff3860, #ff1744); }
        .bg-neutral { background: linear-gradient(90deg, #bd00ff, #7c4dff); }

        /* Exchange Grid */
        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .exchange-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.85rem;
        }

        .exchange-item.active {
            border-color: var(--accent-green);
            box-shadow: var(--neon-green);
        }

        .exchange-item i {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
            color: var(--accent-cyan);
        }

        /* Indicators */
        .indicator-box {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
        }

        .indicator-box.buy { border-left-color: var(--accent-green); }
        .indicator-box.sell { border-left-color: var(--accent-red); }
        .indicator-box.neutral { border-left-color: var(--accent-purple); }

        /* Pattern Tags */
        .pattern-tag {
            display: inline-block;
            padding: 0.4rem 1rem;
            margin: 0.2rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .pattern-bullish {
            background: rgba(0, 255, 157, 0.15);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .pattern-bearish {
            background: rgba(255, 56, 96, 0.15);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .pattern-neutral {
            background: rgba(189, 0, 255, 0.15);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* Form Controls */
        .form-select {
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            color: #fff;
            font-weight: 600;
            padding: 0.8rem 2.5rem 0.8rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
        }

        .form-select option {
            background: var(--bg-card);
            color: #fff;
        }

        .btn-analyze {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            border: none;
            color: #000;
            font-weight: 800;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: var(--neon-green);
        }

        /* Footer */
        .footer {
            background: rgba(10, 14, 23, 0.95);
            border-top: 2px solid var(--accent-cyan);
            padding: 1.5rem 0;
            margin-top: 3rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border-left: 4px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 1rem 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid rgba(0, 229, 255, 0.3);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .chart-wrapper { height: 450px; }
            .price-large { font-size: 2.5rem; }
        }

        @media (max-width: 768px) {
            .chart-wrapper { height: 350px; }
            .price-large { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="#">
            <i class="fas fa-microchip me-2"></i>
            ICTSMARTPRO v7.0
        </a>
        <div class="d-flex align-items-center gap-3">
            <span class="connection-badge" id="connectionStatus">
                <i class="fas fa-circle me-2" style="color: #ff3860;"></i>
                <span id="statusText">Baƒülanƒ±yor...</span>
            </span>
            <span class="connection-badge">
                <i class="fas fa-users me-2"></i>
                <span id="visitorCount">0</span>
            </span>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <!-- Kontrol Paneli -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sliders-h"></i>
                    ANALƒ∞Z KONTROLLERƒ∞ ‚Ä¢ 11+ BORSA ENTEGRASYONU
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-3">
                            <select class="form-select" id="symbolSelect">
                                <option value="BTC">BTC/USDT</option>
                                <option value="ETH">ETH/USDT</option>
                                <option value="SOL">SOL/USDT</option>
                                <option value="BNB">BNB/USDT</option>
                                <option value="XRP">XRP/USDT</option>
                                <option value="ADA">ADA/USDT</option>
                                <option value="DOGE">DOGE/USDT</option>
                                <option value="LINK">LINK/USDT</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="intervalSelect">
                                <option value="1m">1 Dakika</option>
                                <option value="5m">5 Dakika</option>
                                <option value="15m">15 Dakika</option>
                                <option value="30m">30 Dakika</option>
                                <option value="1h" selected>1 Saat</option>
                                <option value="4h">4 Saat</option>
                                <option value="1d">1 G√ºn</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <button class="btn-analyze flex-grow-1" onclick="analyze()">
                                    <i class="fas fa-chart-line me-2"></i>
                                    ANALƒ∞Z ET
                                </button>
                                <button class="btn-analyze" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));" onclick="trainModel()">
                                    <i class="fas fa-brain"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ana Grid - CHART %60, SAƒû PANEL %40 -->
    <div class="row g-4">
        <!-- SOL KOLON - GRAFƒ∞K AƒûIRLIKLI -->
        <div class="col-lg-7">
            <!-- TradingView Chart - EN B√úY√úK ALAN -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-candlestick"></i>
                    CANLI GRAFƒ∞K ‚Ä¢ BINANCE
                    <span class="ms-2 badge" style="background: var(--accent-cyan); color: #000;" id="tvSymbol">BTCUSDT</span>
                </div>
                <div class="card-body p-0">
                    <div class="chart-wrapper">
                        <div id="tradingview-widget"></div>
                    </div>
                </div>
            </div>

            <!-- Fiyat ve Sinyal √ñzeti -->
            <div class="row g-4 mt-2">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-dollar-sign"></i>
                            CANLI Fƒ∞YAT
                        </div>
                        <div class="card-body text-center">
                            <div class="price-large" id="currentPrice">$---</div>
                            <div id="priceChangeContainer" class="mt-3">
                                <span class="price-change" id="priceChange">0.00%</span>
                            </div>
                            <div class="row mt-4">
                                <div class="col-6">
                                    <small class="text-secondary">Hacim 24s</small>
                                    <div class="fw-bold fs-5" id="volume24h">-</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-secondary">Kaynak</small>
                                    <div class="fw-bold fs-5" id="sourceCount">0/11</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-brain"></i>
                            ML Sƒ∞NYALƒ∞
                        </div>
                        <div class="card-body">
                            <div class="signal-badge" id="signalBadge">
                                <span id="signalText">BEKLƒ∞YOR</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                            </div>
                            <div class="text-center fw-bold fs-4" id="confidenceText">%0</div>
                            <div class="mt-3 small text-secondary" id="recommendation">Analiz bekleniyor...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teknik G√∂stergeler -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-flask"></i>
                    TEKNƒ∞K G√ñSTERGELER
                </div>
                <div class="card-body" id="technicalContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-3 text-secondary">G√∂stergeler hesaplanƒ±yor...</p>
                    </div>
                </div>
            </div>

            <!-- Pattern ve Market Yapƒ±sƒ± -->
            <div class="row g-4 mt-2">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-shapes"></i>
                            MUM PATERNLERƒ∞
                        </div>
                        <div class="card-body" id="patternsContainer">
                            <p class="text-secondary text-center">Veri bekleniyor...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-exchange-alt"></i>
                            MARKET YAPISI
                        </div>
                        <div class="card-body" id="structureContainer">
                            <div class="indicator-box">
                                <div class="d-flex justify-content-between">
                                    <span>Trend</span>
                                    <span class="fw-bold" id="trendValue">-</span>
                                </div>
                            </div>
                            <div class="indicator-box">
                                <div class="d-flex justify-content-between">
                                    <span>Yapƒ±</span>
                                    <span class="fw-bold" id="structureValue">-</span>
                                </div>
                            </div>
                            <div class="indicator-box">
                                <div class="d-flex justify-content-between">
                                    <span>Volatilite</span>
                                    <span class="fw-bold" id="volatilityValue">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAƒû KOLON - PANEL %40 -->
        <div class="col-lg-5">
            <!-- Sinyal Daƒüƒ±lƒ±mƒ± -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    Sƒ∞NYAL DAƒûILIMI ‚Ä¢ 11+ BORSA
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-arrow-up text-green"></i> AL</span>
                            <span class="fw-bold" id="buyPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-buy" id="buyBar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-arrow-down text-red"></i> SAT</span>
                            <span class="fw-bold" id="sellPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-sell" id="sellBar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-minus text-purple"></i> N√ñTR</span>
                            <span class="fw-bold" id="neutralPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-neutral" id="neutralBar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML Modelleri -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-network-wired"></i>
                    MAKƒ∞NE √ñƒûRENMESƒ∞
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>LightGBM</span>
                            <span class="fw-bold" id="lgbmAcc">63.7%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: 63.7%; background: var(--accent-cyan);"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Transformer</span>
                            <span class="fw-bold" id="transformerAcc">65.2%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: 65.2%; background: var(--accent-purple);"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>LSTM</span>
                            <span class="fw-bold" id="lstmAcc">61.4%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: 61.4%; background: var(--accent-green);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Borsa Durumu -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-cloud"></i>
                    11+ BORSA DURUMU
                </div>
                <div class="card-body">
                    <div class="exchange-grid" id="exchangeGrid">
                        <!-- JS ile doldurulacak -->
                    </div>
                </div>
            </div>

            <!-- AI Asistan -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-robot"></i>
                    AI ASƒ∞STAN
                </div>
                <div class="card-body">
                    <div style="max-height: 300px; overflow-y: auto; padding-right: 0.5rem;" id="chatMessages">
                        <div class="indicator-box" style="border-left-color: var(--accent-cyan);">
                            <small class="text-secondary">AI</small>
                            <p class="mb-0 mt-1">Merhaba! Analiz i√ßin bir sembol se√ßin.</p>
                        </div>
                    </div>
                    <button class="btn-analyze w-100 mt-3" onclick="askAI()">
                        <i class="fas fa-magic me-2"></i>
                        SORU SOR
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-12 text-center">
                <p class="mb-0">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Yatƒ±rƒ±m tavsiyesi deƒüildir. Ger√ßek zamanlƒ± veri 11+ borsadan alƒ±nmaktadƒ±r.
                </p>
                <p class="mb-0 mt-2 small">
                    ¬© 2025 ICTSMARTPRO ‚Ä¢ v7.0 ‚Ä¢ Maksimum g√ºven %79 ile sƒ±nƒ±rlƒ±dƒ±r
                </p>
            </div>
        </div>
    </div>
</footer>

<script>
// Configuration
const CONFIG = {
    backendUrl: window.location.origin,
    wsUrl: (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host,
    maxConfidence: 79.0,
    refreshInterval: 30000
};

// State
let currentData = null;
let tvWidget = null;
let ws = null;
let reconnectAttempts = 0;

// Exchange list
const EXCHANGES = [
    { name: 'Binance', icon: 'fa-bitcoin', status: 'active' },
    { name: 'Bybit', icon: 'fa-coins', status: 'active' },
    { name: 'OKX', icon: 'fa-chart-bar', status: 'active' },
    { name: 'KuCoin', icon: 'fa-database', status: 'active' },
    { name: 'Gate.io', icon: 'fa-gem', status: 'active' },
    { name: 'MEXC', icon: 'fa-rocket', status: 'active' },
    { name: 'Kraken', icon: 'fa-fish', status: 'active' },
    { name: 'Bitfinex', icon: 'fa-fire', status: 'active' },
    { name: 'Huobi', icon: 'fa-burn', status: 'active' },
    { name: 'Coinbase', icon: 'fa-shopping-cart', status: 'active' },
    { name: 'Bitget', icon: 'fa-bolt', status: 'active' }
];

// ==================== HELPER FUNCTIONS ====================
function formatNumber(num, decimals = 2) {
    if (num === undefined || num === null) return '-';
    return Number(num).toLocaleString('en-US', { 
        minimumFractionDigits: decimals, 
        maximumFractionDigits: decimals 
    });
}

function formatVolume(v) {
    if (!v || v <= 0) return '-';
    if (v >= 1e9) return `$${(v/1e9).toFixed(2)}B`;
    if (v >= 1e6) return `$${(v/1e6).toFixed(2)}M`;
    if (v >= 1e3) return `$${(v/1e3).toFixed(2)}K`;
    return `$${v.toFixed(0)}`;
}

function showNotification(msg, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification`;
    notification.innerHTML = msg;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    
    if (connected) {
        statusEl.classList.add('connected');
        statusEl.innerHTML = '<i class="fas fa-circle me-2" style="color: #00ff9d;"></i><span id="statusText">Baƒülƒ±</span>';
    } else {
        statusEl.classList.remove('connected');
        statusEl.innerHTML = '<i class="fas fa-circle me-2" style="color: #ff3860;"></i><span id="statusText">Baƒülantƒ± Yok</span>';
    }
}

// ==================== TRADINGVIEW CHART ====================
function initTradingView() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    const interval = document.getElementById('intervalSelect').value;
    
    const intervalMap = {
        '1m': '1', '5m': '5', '15m': '15', '30m': '30',
        '1h': '60', '4h': '240', '1d': 'D', '1w': 'W'
    };
    
    document.getElementById('tvSymbol').textContent = symbol;
    
    if (tvWidget) {
        try { tvWidget.remove(); } catch(e) {}
    }
    
    const container = document.getElementById('tradingview-widget');
    container.innerHTML = '';
    
    tvWidget = new TradingView.widget({
        width: '100%',
        height: '100%',
        symbol: `BINANCE:${symbol}`,
        interval: intervalMap[interval] || '60',
        timezone: 'Etc/UTC',
        theme: 'dark',
        style: '1',
        locale: 'tr',
        toolbar_bg: '#0f1520',
        enable_publishing: false,
        hide_top_toolbar: false,
        hide_side_toolbar: false,
        allow_symbol_change: false,
        container_id: 'tradingview-widget',
        studies: [
            'RSI@tv-basicstudies',
            'MACD@tv-basicstudies',
            'BB@tv-basicstudies'
        ]
    });
}

// ==================== FETCH ANALYSIS ====================
async function analyze() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    const interval = document.getElementById('intervalSelect').value;
    
    showNotification('üìä Analiz yapƒ±lƒ±yor...', 'info');
    
    try {
        const response = await fetch(`${CONFIG.backendUrl}/api/analyze/${symbol}?interval=${interval}&limit=200`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentData = data;
            updateDashboard(data);
            showNotification('‚úÖ Analiz tamamlandƒ±', 'success');
        } else {
            throw new Error('Analiz ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        console.error('Analyze error:', error);
        showNotification('‚ùå Analiz ba≈üarƒ±sƒ±z: ' + error.message, 'error');
    }
}

// ==================== UPDATE DASHBOARD ====================
function updateDashboard(data) {
    // Price
    if (data.price_data) {
        const price = data.price_data.current;
        const change = data.price_data.change_percent || 0;
        
        document.getElementById('currentPrice').textContent = '$' + formatNumber(price, 2);
        
        const changeEl = document.getElementById('priceChange');
        changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
        changeEl.className = 'price-change ' + (change >= 0 ? 'up' : 'down');
        
        document.getElementById('volume24h').textContent = formatVolume(data.price_data.volume_24h);
        document.getElementById('sourceCount').textContent = data.price_data.source_count + '/11';
    }
    
    // Signal
    if (data.signal) {
        const signal = data.signal.signal || 'NEUTRAL';
        const confidence = data.signal.confidence || 50;
        
        const badge = document.getElementById('signalBadge');
        badge.className = 'signal-badge';
        
        if (signal.includes('STRONG_BUY')) badge.classList.add('signal-strong-buy');
        else if (signal.includes('BUY')) badge.classList.add('signal-buy');
        else if (signal.includes('STRONG_SELL')) badge.classList.add('signal-strong-sell');
        else if (signal.includes('SELL')) badge.classList.add('signal-sell');
        else badge.classList.add('signal-neutral');
        
        document.getElementById('signalText').textContent = signal.replace('_', ' ');
        document.getElementById('confidenceFill').style.width = confidence + '%';
        document.getElementById('confidenceText').textContent = '%' + confidence.toFixed(1);
        document.getElementById('recommendation').textContent = data.signal.recommendation || '';
    }
    
    // Signal Distribution
    if (data.signal_distribution) {
        const dist = data.signal_distribution;
        document.getElementById('buyPercent').textContent = dist.buy + '%';
        document.getElementById('buyBar').style.width = dist.buy + '%';
        document.getElementById('buyBar').textContent = dist.buy + '%';
        
        document.getElementById('sellPercent').textContent = dist.sell + '%';
        document.getElementById('sellBar').style.width = dist.sell + '%';
        document.getElementById('sellBar').textContent = dist.sell + '%';
        
        document.getElementById('neutralPercent').textContent = dist.neutral + '%';
        document.getElementById('neutralBar').style.width = dist.neutral + '%';
        document.getElementById('neutralBar').textContent = dist.neutral + '%';
    }
    
    // ML Stats
    if (data.ml_stats) {
        document.getElementById('lgbmAcc').textContent = data.ml_stats.lgbm.toFixed(1) + '%';
        document.getElementById('transformerAcc').textContent = data.ml_stats.transformer.toFixed(1) + '%';
        document.getElementById('lstmAcc').textContent = data.ml_stats.lstm.toFixed(1) + '%';
    }
    
    // Technical Indicators
    if (data.technical_indicators) {
        const tech = data.technical_indicators;
        let html = '<div class="row g-3">';
        
        const indicators = [
            { name: 'RSI (14)', value: tech.rsi_value, unit: '', threshold: 50 },
            { name: 'MACD', value: tech.macd_histogram, unit: '', threshold: 0 },
            { name: 'Bollinger %', value: tech.bb_position, unit: '%', threshold: 50 },
            { name: 'Stoch RSI', value: tech.stoch_rsi * 100, unit: '%', threshold: 50 },
            { name: 'ATR %', value: tech.atr_percent, unit: '%', threshold: 2 },
            { name: 'Hacim Oranƒ±', value: tech.volume_ratio, unit: 'x', threshold: 1 }
        ];
        
        indicators.forEach(ind => {
            const isPositive = ind.value > ind.threshold;
            html += `
                <div class="col-6">
                    <div class="indicator-box ${isPositive ? 'buy' : 'sell'}">
                        <small class="text-secondary">${ind.name}</small>
                        <div class="fw-bold fs-5">${ind.value.toFixed(1)}${ind.unit}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('technicalContainer').innerHTML = html;
    }
    
    // Patterns
    if (data.patterns && data.patterns.length > 0) {
        let html = '';
        data.patterns.slice(0, 8).forEach(p => {
            const type = p.direction === 'bullish' ? 'pattern-bullish' : 
                        p.direction === 'bearish' ? 'pattern-bearish' : 'pattern-neutral';
            html += `<span class="pattern-tag ${type}">${p.name} (${(p.confidence * 100).toFixed(0)}%)</span>`;
        });
        document.getElementById('patternsContainer').innerHTML = html || '<p class="text-secondary">Pattern bulunamadƒ±</p>';
    }
    
    // Market Structure
    if (data.market_structure) {
        const ms = data.market_structure;
        document.getElementById('trendValue').textContent = ms.trend || '-';
        document.getElementById('structureValue').textContent = ms.structure || '-';
        document.getElementById('volatilityValue').textContent = ms.volatility || '-';
    }
}

// ==================== EXCHANGE GRID ====================
function renderExchangeGrid() {
    const grid = document.getElementById('exchangeGrid');
    grid.innerHTML = EXCHANGES.map(ex => `
        <div class="exchange-item active">
            <i class="fas ${ex.icon}"></i>
            <div class="small">${ex.name}</div>
        </div>
    `).join('');
}

// ==================== VISITOR COUNT ====================
async function updateVisitorCount() {
    try {
        const response = await fetch(`${CONFIG.backendUrl}/api/visitors`);
        if (response.ok) {
            const data = await response.json();
            document.getElementById('visitorCount').textContent = data.count || 0;
        }
    } catch (error) {
        console.error('Visitor count error:', error);
    }
}

// ==================== WEBSOCKET ====================
function connectWebSocket() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    
    if (ws) {
        try { ws.close(); } catch(e) {}
    }
    
    ws = new WebSocket(`${CONFIG.wsUrl}/ws/${symbol}`);
    
    ws.onopen = () => {
        console.log('WebSocket connected');
        updateConnectionStatus(true);
        reconnectAttempts = 0;
    };
    
    ws.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'price_update' && data.price) {
                document.getElementById('currentPrice').textContent = '$' + formatNumber(data.price, 2);
                
                if (data.change_percent !== undefined) {
                    const changeEl = document.getElementById('priceChange');
                    changeEl.textContent = (data.change_percent >= 0 ? '+' : '') + data.change_percent.toFixed(2) + '%';
                    changeEl.className = 'price-change ' + (data.change_percent >= 0 ? 'up' : 'down');
                }
            }
        } catch (error) {
            console.error('WebSocket message error:', error);
        }
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateConnectionStatus(false);
    };
    
    ws.onclose = () => {
        console.log('WebSocket closed');
        updateConnectionStatus(false);
        
        if (reconnectAttempts < 5) {
            setTimeout(() => {
                reconnectAttempts++;
                connectWebSocket();
            }, 3000);
        }
    };
}

// ==================== TRAIN MODEL ====================
async function trainModel() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    
    showNotification('üß† Model eƒüitiliyor...', 'info');
    
    try {
        const response = await fetch(`${CONFIG.backendUrl}/api/train/${symbol}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('‚úÖ Model eƒüitildi', 'success');
            setTimeout(() => analyze(), 2000);
        } else {
            throw new Error('Eƒüitim ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        showNotification('‚ùå Eƒüitim ba≈üarƒ±sƒ±z', 'error');
    }
}

// ==================== AI ASK ====================
function askAI() {
    if (!currentData) {
        showNotification('√ñnce analiz yapƒ±n', 'warning');
        return;
    }
    
    const responses = [
        `RSI ${currentData.technical_indicators?.rsi_value?.toFixed(1)} seviyesinde.`,
        `Sinyal: ${currentData.signal?.signal} (G√ºven: %${currentData.signal?.confidence})`,
        `${currentData.patterns?.length || 0} adet mum patterni tespit edildi.`,
        `Trend: ${currentData.market_structure?.trend}`,
        `Volatilite: ${currentData.market_structure?.volatility}`
    ];
    
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    const chat = document.getElementById('chatMessages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'indicator-box mt-2';
    msgDiv.style.borderLeftColor = 'var(--accent-cyan)';
    msgDiv.innerHTML = `
        <small class="text-secondary">AI</small>
        <p class="mb-0 mt-1">${randomResponse}</p>
    `;
    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ ICTSMARTPRO v7.0 ba≈ülatƒ±lƒ±yor...');
    
    // Render UI
    renderExchangeGrid();
    
    // Initialize TradingView
    setTimeout(() => initTradingView(), 500);
    
    // Connect WebSocket
    connectWebSocket();
    
    // Update visitor count
    await updateVisitorCount();
    setInterval(updateVisitorCount, 60000);
    
    // First analysis
    setTimeout(() => analyze(), 1000);
    
    // Auto refresh
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            analyze();
        }
    }, CONFIG.refreshInterval);
    
    // Chart refresh
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            initTradingView();
        }
    }, 300000);
});

// ==================== EVENT LISTENERS ====================
document.getElementById('symbolSelect').addEventListener('change', () => {
    initTradingView();
    connectWebSocket();
    analyze();
});

document.getElementById('intervalSelect').addEventListener('change', () => {
    initTradingView();
    analyze();
});

// ==================== CLEANUP ====================
window.addEventListener('beforeunload', () => {
    if (ws) ws.close();
    if (tvWidget) tvWidget.remove();
});
</script>
</body>
</html>
