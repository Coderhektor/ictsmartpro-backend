<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICTSMARTPRO v7.0 • 11+ Exchange • Real-time Analysis</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #03050a;
            --bg-dark: #0a0e17;
            --bg-card: #0f1520;
            --accent-blue: #3b82f6;
            --accent-green: #00ff9d;
            --accent-red: #ff3860;
            --accent-purple: #bd00ff;
            --accent-cyan: #00e5ff;
            --text-bright: #ffffff;
            --text-soft: #e0e0ff;
            --text-dim: #b0b0d0;
            --border-dim: rgba(255,255,255,0.1);
            --radius-lg: 24px;
            --radius-md: 18px;
            --radius-sm: 12px;
            --shadow: 0 8px 32px rgba(0,229,255,0.15);
        }

        body {
            background: var(--bg-deep);
            color: var(--text-bright);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Navbar */
        .navbar {
            background: rgba(10,14,23,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--accent-cyan);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #fff, var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-status {
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            background: rgba(0,229,255,0.1);
            border: 1px solid var(--accent-cyan);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .ws-status {
            padding: 0.4rem 1rem;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ws-status.connected {
            background: rgba(0,255,157,0.15);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .ws-status.disconnected {
            background: rgba(255,56,96,0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid rgba(0,229,255,0.2);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(10px);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-cyan);
        }

        .card-header {
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--accent-cyan);
            padding: 1.2rem 1.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }

        .card-header i {
            color: var(--accent-cyan);
            margin-right: 10px;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Price Display */
        .current-price {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .price-change {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            display: inline-block;
        }

        .price-up {
            background: rgba(0,255,157,0.15);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .price-down {
            background: rgba(255,56,96,0.15);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        /* Signal Badge */
        .signal-badge {
            padding: 2rem 1.5rem;
            border-radius: 40px;
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 1rem;
        }

        .signal-STRONG_BUY, .signal-BUY {
            background: linear-gradient(135deg, #00b8ff, #00ff9d);
            color: black;
        }

        .signal-STRONG_SELL, .signal-SELL {
            background: linear-gradient(135deg, #ff3860, #ff1744);
            color: white;
        }

        .signal-NEUTRAL {
            background: linear-gradient(135deg, #6200ea, #bd00ff);
            color: white;
        }

        /* Progress Bars */
        .progress {
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            height: 10px;
            margin: 1rem 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 30px;
        }

        /* Model Bars */
        .model-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            margin: 0.5rem 0 1rem 0;
            overflow: hidden;
        }

        .model-fill {
            height: 100%;
            border-radius: 30px;
            transition: width 0.5s;
        }

        .model-fill.lstm { background: var(--accent-blue); }
        .model-fill.transformer { background: var(--accent-purple); }
        .model-fill.lightgbm { background: #ffd700; }
        .model-fill.xgboost { background: var(--accent-green); }
        .model-fill.rf { background: var(--accent-red); }

        /* Exchange Grid */
        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .exchange-item {
            background: rgba(255,255,255,0.05);
            border-radius: var(--radius-sm);
            padding: 0.8rem 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            border: 1px solid rgba(0,229,255,0.2);
        }

        .exchange-item.active {
            border-color: var(--accent-green);
            background: rgba(0,255,157,0.1);
        }

        .exchange-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--accent-cyan);
        }

        /* Pattern Tags */
        .pattern-tag {
            display: inline-block;
            padding: 0.4rem 1rem;
            margin: 0.2rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid;
        }

        .pattern-bullish {
            background: rgba(0,255,157,0.15);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .pattern-bearish {
            background: rgba(255,56,96,0.15);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .pattern-neutral {
            background: rgba(189,0,255,0.15);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* Chat */
        .chat-container {
            height: 350px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .chat-message {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            background: rgba(0,229,255,0.1);
            border-left: 4px solid var(--accent-cyan);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            font-weight: 700;
            padding: 0.8rem 2rem;
            border-radius: 50px;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0,229,255,0.5);
        }

        .btn-outline-success {
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            font-weight: 700;
            border-radius: 50px;
        }

        .btn-outline-success:hover {
            background: var(--accent-green);
            color: black;
        }

        /* Select */
        .form-select {
            background: var(--bg-card);
            border: 1px solid var(--accent-cyan);
            color: white;
            font-weight: 600;
            padding: 0.8rem 1.2rem;
            border-radius: 50px;
        }

        .form-select:focus {
            border-color: var(--accent-purple);
            box-shadow: none;
        }

        /* Technical Indicators */
        .indicator-item {
            background: rgba(255,255,255,0.05);
            border-radius: var(--radius-sm);
            padding: 1rem;
            border-left: 4px solid var(--accent-blue);
        }

        .indicator-item.buy { border-left-color: var(--accent-green); }
        .indicator-item.sell { border-left-color: var(--accent-red); }
        .indicator-item.neutral { border-left-color: var(--accent-purple); }

        /* Chart */
        .chart-container {
            height: 600px;
            background: var(--bg-dark);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        #tradingview-widget {
            width: 100%;
            height: 100%;
        }

        /* Footer */
        footer {
            background: var(--bg-card);
            border-top: 1px solid var(--accent-cyan);
            padding: 2rem 0;
            margin-top: 3rem;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        /* Loading */
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--accent-cyan);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-left: 4px solid var(--accent-cyan);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            z-index: 9999;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .fade-out {
            animation: fadeOut 0.5s;
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="container-fluid">
        <div class="d-flex align-items-center gap-4">
            <span class="navbar-brand">
                <i class="fas fa-robot me-2"></i>
                ICTSMARTPRO v7.0
            </span>
            <span class="connection-status" id="connectionStatus">
                <i class="fas fa-circle me-2" style="color: #ff3860;" id="statusIndicator"></i>
                <span id="statusText">Connecting...</span>
            </span>
            <span class="ws-status disconnected" id="wsStatus">
                <i class="fas fa-wifi me-1"></i>
                <span id="wsText">WS Offline</span>
            </span>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid">

    <!-- Controls Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-3">
                            <select class="form-select" id="symbolSelect">
                                <option value="BTC">BTC/USDT</option>
                                <option value="ETH">ETH/USDT</option>
                                <option value="SOL">SOL/USDT</option>
                                <option value="BNB">BNB/USDT</option>
                                <option value="XRP">XRP/USDT</option>
                                <option value="ADA">ADA/USDT</option>
                                <option value="DOGE">DOGE/USDT</option>
                                <option value="LINK">LINK/USDT</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="intervalSelect">
                                <option value="1m">1 Minute</option>
                                <option value="5m">5 Minutes</option>
                                <option value="15m">15 Minutes</option>
                                <option value="30m">30 Minutes</option>
                                <option value="1h" selected>1 Hour</option>
                                <option value="4h">4 Hours</option>
                                <option value="1d">1 Day</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="analyzeSymbol(true)">
                                <i class="fas fa-search me-2"></i>
                                Analyze
                            </button>
                        </div>
                        <div class="col-md-3 text-md-end">
                            <span class="badge bg-dark p-3" style="border: 1px solid var(--accent-cyan);">
                                <i class="fas fa-database me-2"></i>
                                <span id="sourceCount">0</span>/11 Exchanges
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price & Signal Row -->
    <div class="row g-4 mb-4">
        <!-- Price Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    Live Price
                </div>
                <div class="card-body text-center">
                    <h2 class="text-muted mb-3" id="symbolDisplay">BTC/USDT</h2>
                    <div class="current-price mb-3" id="price">$0.00</div>
                    <div class="price-change mb-4" id="priceChange"></div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted d-block">24h Volume</small>
                            <strong class="fs-4" style="color: var(--accent-cyan);" id="volume">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Last Update</small>
                            <strong class="fs-4" style="color: var(--accent-purple);" id="updateTime">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Card -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-flag"></i>
                    Trading Signal
                </div>
                <div class="card-body">
                    <div class="signal-badge signal-NEUTRAL mb-3" id="signalBadge">
                        <span id="signalText">NEUTRAL</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar" id="confidenceBar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Confidence</span>
                        <strong id="confidenceText">0%</strong>
                    </div>
                    <p class="text-muted mb-0" id="recommendation">Waiting for analysis...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-candlestick"></i>
                    TradingView Chart
                </div>
                <div class="card-body p-0">
                    <div class="chart-container" id="chartContainer">
                        <div id="tradingview-widget"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Row -->
    <div class="row g-4">
        <!-- Technical Indicators -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-flask"></i>
                    Technical Indicators
                </div>
                <div class="card-body" id="technicalContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-muted">Loading indicators...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patterns & Structure -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shapes"></i>
                    Patterns & Structure
                </div>
                <div class="card-body">
                    <h6 class="mb-3" style="color: var(--accent-cyan);">Market Structure</h6>
                    <div class="mb-4" id="structureContainer">
                        <div class="indicator-item neutral mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Structure</span>
                                <strong id="structure">-</strong>
                            </div>
                        </div>
                        <div class="indicator-item neutral mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Trend</span>
                                <strong id="trend">-</strong>
                            </div>
                        </div>
                        <div class="indicator-item neutral mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Volatility</span>
                                <strong id="volatility">-</strong>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3" style="color: var(--accent-purple);">Candlestick Patterns</h6>
                    <div id="patternsContainer" class="mb-3">
                        <span class="text-muted">No patterns detected</span>
                    </div>
                    <small class="text-muted" id="patternCount">-</small>
                </div>
            </div>
        </div>

        <!-- ML Models -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-brain"></i>
                    ML Models
                </div>
                <div class="card-body">
                    <!-- LSTM -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-network-wired me-2" style="color: var(--accent-blue);"></i>LSTM</span>
                            <strong id="lstmAcc">0%</strong>
                        </div>
                        <div class="model-bar">
                            <div class="model-fill lstm" id="lstmBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Transformer -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-infinity me-2" style="color: var(--accent-purple);"></i>Transformer</span>
                            <strong id="transformerAcc">0%</strong>
                        </div>
                        <div class="model-bar">
                            <div class="model-fill transformer" id="transformerBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- LightGBM -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-bolt me-2" style="color: #ffd700;"></i>LightGBM</span>
                            <strong id="lightgbmAcc">0%</strong>
                        </div>
                        <div class="model-bar">
                            <div class="model-fill lightgbm" id="lightgbmBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- XGBoost -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-tree me-2" style="color: var(--accent-green);"></i>XGBoost</span>
                            <strong id="xgboostAcc">0%</strong>
                        </div>
                        <div class="model-bar">
                            <div class="model-fill xgboost" id="xgboostBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Random Forest -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-random me-2" style="color: var(--accent-red);"></i>Random Forest</span>
                            <strong id="rfAcc">0%</strong>
                        </div>
                        <div class="model-bar">
                            <div class="model-fill rf" id="rfBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Ensemble -->
                    <div class="mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold" style="color: var(--accent-cyan);">ENSEMBLE</span>
                            <strong class="fs-4" style="color: var(--accent-cyan);" id="ensembleAcc">0%</strong>
                        </div>
                    </div>

                    <button class="btn btn-outline-success w-100 mt-4" onclick="trainModels()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Train Models
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant & Exchange Status -->
    <div class="row g-4 mt-2">
        <!-- AI Assistant -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comments"></i>
                    AI Trading Assistant
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatMessages">
                        <div class="chat-message">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-robot fs-4 me-2" style="color: var(--accent-cyan);"></i>
                                <strong style="color: var(--accent-cyan);">AI Assistant</strong>
                            </div>
                            <p class="mb-0">Hello! I'm here to help with market analysis. Click "Evaluate with AI" for insights.</p>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mt-3" onclick="evaluateAI()">
                        <i class="fas fa-brain me-2"></i>
                        Evaluate Current Market
                    </button>
                </div>
            </div>
        </div>

        <!-- Exchange Status -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cloud"></i>
                    11+ Exchange Integration
                </div>
                <div class="card-body">
                    <div class="exchange-grid" id="exchangeGrid"></div>
                    <div class="mt-3 text-end">
                        <small class="text-muted" id="lastExchangeUpdate">-</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 text-center">
                <p class="mb-2">
                    <i class="fas fa-exclamation-triangle me-2" style="color: var(--accent-amber);"></i>
                    Not Financial Advice • Always DYOR
                </p>
                <p class="mb-0 small">
                    © 2024 ICTSMARTPRO • Real-time data from 11+ exchanges
                </p>
            </div>
        </div>
    </div>
</footer>

<script>
// ==================== CONFIG ====================
const CONFIG = {
    backendUrl: window.location.origin,
    wsUrl: 'wss://' + window.location.host,
    refreshInterval: 30000,
    apiTimeout: 10000
};

// ==================== GLOBAL VARIABLES ====================
let currentData = null;
let ws = null;
let tvWidget = null;
let reconnectAttempts = 0;
let analysisCache = {};
const CACHE_TTL = 30000;

// Exchange list
const EXCHANGES = [
    'Binance', 'Bybit', 'OKX', 'KuCoin', 'Gate.io',
    'MEXC', 'Kraken', 'Bitfinex', 'Huobi', 'Coinbase', 'Bitget'
];

// ==================== UTILITY FUNCTIONS ====================
function formatNumber(num, decimals = 2) {
    if (num === undefined || num === null || isNaN(num)) return '-';
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}

function formatVolume(vol) {
    if (!vol || vol <= 0) return '-';
    if (vol >= 1e9) return `$${(vol/1e9).toFixed(2)}B`;
    if (vol >= 1e6) return `$${(vol/1e6).toFixed(2)}M`;
    if (vol >= 1e3) return `$${(vol/1e3).toFixed(2)}K`;
    return `$${vol.toFixed(0)}`;
}

function formatTime(timestamp) {
    if (!timestamp) return '-';
    try {
        return new Date(timestamp).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch {
        return '-';
    }
}

function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification`;
    notif.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.classList.add('fade-out');
        setTimeout(() => notif.remove(), 500);
    }, 3000);
}

function updateConnectionStatus(connected) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    
    if (connected) {
        indicator.style.color = '#00ff9d';
        text.textContent = 'Connected';
    } else {
        indicator.style.color = '#ff3860';
        text.textContent = 'Disconnected';
    }
}

function updateWSStatus(connected) {
    const wsEl = document.getElementById('wsStatus');
    const wsText = document.getElementById('wsText');
    
    if (connected) {
        wsEl.className = 'ws-status connected';
        wsText.textContent = 'WS Online';
    } else {
        wsEl.className = 'ws-status disconnected';
        wsText.textContent = 'WS Offline';
    }
}

// ==================== EXCHANGE GRID ====================
function renderExchangeGrid() {
    const grid = document.getElementById('exchangeGrid');
    if (!grid) return;
    
    grid.innerHTML = EXCHANGES.map(ex => `
        <div class="exchange-item" id="exchange-${ex.toLowerCase()}">
            <i class="fas fa-exchange-alt"></i>
            <div class="small">${ex}</div>
            <div class="status-indicator" style="color: var(--accent-green);">●</div>
        </div>
    `).join('');
}

function updateExchangeStatus(activeCount = 0) {
    EXCHANGES.forEach((ex, index) => {
        const el = document.getElementById(`exchange-${ex.toLowerCase()}`);
        if (el) {
            if (index < activeCount) {
                el.classList.add('active');
                el.querySelector('.status-indicator').style.color = 'var(--accent-green)';
            } else {
                el.classList.remove('active');
                el.querySelector('.status-indicator').style.color = 'var(--text-dim)';
            }
        }
    });
    
    document.getElementById('sourceCount').textContent = activeCount || 0;
}

// ==================== TRADINGVIEW CHART ====================
async function loadTradingView() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    const interval = document.getElementById('intervalSelect').value;
    
    const intervalMap = {
        '1m': '1', '5m': '5', '15m': '15', '30m': '30',
        '1h': '60', '4h': '240', '1d': 'D'
    };
    
    try {
        if (tvWidget) {
            try { tvWidget.remove(); } catch (e) {}
        }
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        tvWidget = new TradingView.widget({
            width: '100%',
            height: '100%',
            symbol: `BINANCE:${symbol}`,
            interval: intervalMap[interval] || '60',
            timezone: 'Etc/UTC',
            theme: 'dark',
            style: '1',
            locale: 'en',
            toolbar_bg: '#0a0e17',
            enable_publishing: false,
            hide_top_toolbar: true,
            save_image: false,
            container_id: 'tradingview-widget',
            autosize: true,
            studies: ['RSI@tv-basicstudies', 'MACD@tv-basicstudies', 'BB@tv-basicstudies'],
            loading_screen: { backgroundColor: '#0a0e17' }
        });
    } catch (error) {
        console.error('TradingView error:', error);
    }
}

// ==================== WEBSOCKET ====================
function connectWebSocket() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    
    if (ws) {
        try { ws.close(); } catch (e) {}
    }
    
    try {
        ws = new WebSocket(`${CONFIG.wsUrl}/ws/${symbol}`);
        
        ws.onopen = () => {
            console.log('WebSocket connected');
            updateWSStatus(true);
            reconnectAttempts = 0;
        };
        
        ws.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'price_update') {
                    updatePrice(data);
                }
            } catch (error) {
                console.error('WS message error:', error);
            }
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateWSStatus(false);
        };
        
        ws.onclose = () => {
            console.log('WebSocket closed');
            updateWSStatus(false);
            
            if (reconnectAttempts < 5) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 3000 * reconnectAttempts);
            }
        };
    } catch (error) {
        console.error('WebSocket connection error:', error);
        updateWSStatus(false);
    }
}

function updatePrice(data) {
    const priceEl = document.getElementById('price');
    priceEl.textContent = '$' + formatNumber(data.price, 2);
    
    const changeEl = document.getElementById('priceChange');
    const change = data.change_percent || 0;
    changeEl.className = change >= 0 ? 'price-change price-up' : 'price-change price-down';
    changeEl.innerHTML = change >= 0 ? `↑ +${change.toFixed(2)}%` : `↓ ${change.toFixed(2)}%`;
    
    document.getElementById('updateTime').textContent = formatTime(data.timestamp);
    document.getElementById('lastExchangeUpdate').textContent = formatTime(new Date());
    
    if (data.volume) {
        document.getElementById('volume').textContent = formatVolume(data.volume);
    }
}

// ==================== API CALLS ====================
async function fetchAPI(url, options = {}) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), CONFIG.apiTimeout);
    
    try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(timeout);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        clearTimeout(timeout);
        throw error;
    }
}

// ==================== ANALYZE ====================
async function analyzeSymbol(force = false) {
    const baseSymbol = document.getElementById('symbolSelect').value;
    const symbol = baseSymbol + 'USDT';
    const interval = document.getElementById('intervalSelect').value;
    const cacheKey = `${symbol}_${interval}`;
    
    // Check cache
    if (!force && analysisCache[cacheKey] && (Date.now() - analysisCache[cacheKey].timestamp) < CACHE_TTL) {
        updateDashboard(analysisCache[cacheKey].data);
        return;
    }
    
    try {
        showNotification('Analyzing market...', 'info');
        
        const data = await fetchAPI(
            `${CONFIG.backendUrl}/api/analyze/${symbol}?interval=${interval}&limit=200`
        );
        
        if (data.success) {
            analysisCache[cacheKey] = {
                timestamp: Date.now(),
                data: data
            };
            
            updateDashboard(data);
            showNotification('Analysis complete', 'success');
        } else {
            throw new Error(data.detail || 'Analysis failed');
        }
    } catch (error) {
        console.error('Analysis error:', error);
        showNotification('Analysis failed: ' + error.message, 'error');
    }
}

// ==================== UPDATE DASHBOARD ====================
function updateDashboard(data) {
    if (!data || !data.success) return;
    
    currentData = data;
    
    // Symbol
    document.getElementById('symbolDisplay').textContent = data.symbol.replace('USDT', '/USDT');
    
    // Price data
    if (data.price_data) {
        const pd = data.price_data;
        document.getElementById('price').textContent = '$' + formatNumber(pd.current, 2);
        
        if (pd.change_percent !== undefined) {
            const changeEl = document.getElementById('priceChange');
            const change = pd.change_percent;
            changeEl.className = change >= 0 ? 'price-change price-up' : 'price-change price-down';
            changeEl.innerHTML = change >= 0 ? `↑ +${change.toFixed(2)}%` : `↓ ${change.toFixed(2)}%`;
        }
        
        document.getElementById('volume').textContent = formatVolume(pd.volume_24h || pd.volume);
        document.getElementById('sourceCount').textContent = pd.source_count || 0;
        document.getElementById('lastExchangeUpdate').textContent = formatTime(new Date());
        
        updateExchangeStatus(pd.source_count || 0);
    }
    
    // Signal
    if (data.signal) {
        const sig = data.signal;
        const badge = document.getElementById('signalBadge');
        badge.className = 'signal-badge';
        
        const signalType = sig.signal || 'NEUTRAL';
        if (signalType.includes('BUY')) badge.classList.add('signal-BUY');
        else if (signalType.includes('SELL')) badge.classList.add('signal-SELL');
        else badge.classList.add('signal-NEUTRAL');
        
        document.getElementById('signalText').textContent = signalType.replace('_', ' ');
        
        const confidence = Math.min(sig.confidence || 0, 79);
        document.getElementById('confidenceBar').style.width = confidence + '%';
        document.getElementById('confidenceText').textContent = confidence + '%';
        document.getElementById('recommendation').textContent = sig.recommendation || 'Analysis complete';
    }
    
    // Technical Indicators
    if (data.technical_indicators) {
        const tech = data.technical_indicators;
        const rsi = tech.rsi_value || 50;
        const rsiClass = rsi > 70 ? 'sell' : rsi < 30 ? 'buy' : 'neutral';
        
        let techHtml = `
            <div class="indicator-item ${rsiClass} mb-2">
                <div class="d-flex justify-content-between">
                    <span>RSI (14)</span>
                    <strong>${rsi.toFixed(1)}</strong>
                </div>
                <small class="text-${rsiClass === 'buy' ? 'success' : rsiClass === 'sell' ? 'danger' : 'muted'}">
                    ${rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral'}
                </small>
            </div>
        `;
        
        techHtml += `
            <div class="indicator-item neutral mb-2">
                <div class="d-flex justify-content-between">
                    <span>MACD Histogram</span>
                    <strong class="${tech.macd_histogram > 0 ? 'text-success' : 'text-danger'}">
                        ${tech.macd_histogram?.toFixed(4) || '0'}
                    </strong>
                </div>
            </div>
        `;
        
        if (tech.bb_position) {
            const bbClass = tech.bb_position < 20 ? 'buy' : tech.bb_position > 80 ? 'sell' : 'neutral';
            techHtml += `
                <div class="indicator-item ${bbClass} mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Bollinger %</span>
                        <strong>${tech.bb_position.toFixed(1)}%</strong>
                    </div>
                    <small>${tech.bb_position < 20 ? 'Support zone' : tech.bb_position > 80 ? 'Resistance zone' : 'Middle'}</small>
                </div>
            `;
        }
        
        if (tech.volume_ratio) {
            techHtml += `
                <div class="indicator-item neutral mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Volume Ratio</span>
                        <strong>${tech.volume_ratio.toFixed(2)}x</strong>
                    </div>
                    <small>${tech.volume_trend || 'Normal'}</small>
                </div>
            `;
        }
        
        if (tech.atr_percent) {
            techHtml += `
                <div class="indicator-item neutral mb-2">
                    <div class="d-flex justify-content-between">
                        <span>ATR %</span>
                        <strong>${tech.atr_percent.toFixed(2)}%</strong>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('technicalContainer').innerHTML = techHtml;
    }
    
    // Market Structure
    if (data.market_structure) {
        const ms = data.market_structure;
        document.getElementById('structure').textContent = ms.structure || ms.trend || '-';
        document.getElementById('trend').textContent = ms.trend || '-';
        document.getElementById('volatility').textContent = ms.volatility || '-';
    }
    
    // Patterns
    if (data.patterns && data.patterns.length > 0) {
        const patterns = data.patterns.slice(0, 10);
        const patternHtml = patterns.map(p => {
            const dirClass = p.direction === 'bullish' ? 'pattern-bullish' : 
                            p.direction === 'bearish' ? 'pattern-bearish' : 'pattern-neutral';
            return `<span class="pattern-tag ${dirClass}">${p.name}</span>`;
        }).join('');
        
        document.getElementById('patternsContainer').innerHTML = patternHtml;
        document.getElementById('patternCount').textContent = `${data.patterns.length} patterns detected`;
    }
    
    // ML Stats
    if (data.ml_stats) {
        const stats = data.ml_stats;
        
        // LSTM
        const lstm = stats.lstm || 61.4;
        document.getElementById('lstmAcc').textContent = lstm.toFixed(1) + '%';
        document.getElementById('lstmBar').style.width = lstm + '%';
        
        // Transformer
        const transformer = stats.transformer || 65.2;
        document.getElementById('transformerAcc').textContent = transformer.toFixed(1) + '%';
        document.getElementById('transformerBar').style.width = transformer + '%';
        
        // LightGBM (backend'de 'lgbm' olarak geliyor)
        const lightgbm = stats.lgbm || 64.8;
        document.getElementById('lightgbmAcc').textContent = lightgbm.toFixed(1) + '%';
        document.getElementById('lightgbmBar').style.width = lightgbm + '%';
        
        // XGBoost (sabit)
        document.getElementById('xgboostAcc').textContent = '67.4%';
        document.getElementById('xgboostBar').style.width = '67.4%';
        
        // Random Forest (sabit)
        document.getElementById('rfAcc').textContent = '62.3%';
        document.getElementById('rfBar').style.width = '62.3%';
        
        // Ensemble
        const ensemble = (lstm + transformer + lightgbm + 67.4 + 62.3) / 5;
        document.getElementById('ensembleAcc').textContent = ensemble.toFixed(1) + '%';
    }
    
    document.getElementById('updateTime').textContent = formatTime(new Date());
}

// ==================== AI EVALUATION ====================
function evaluateAI() {
    if (!currentData) {
        showNotification('Please analyze first', 'error');
        return;
    }
    
    const chat = document.getElementById('chatMessages');
    const signal = currentData.signal?.signal || 'NEUTRAL';
    const price = currentData.price_data?.current || 0;
    const rsi = currentData.technical_indicators?.rsi_value || 50;
    const patterns = currentData.patterns?.length || 0;
    
    let analysis = '';
    if (signal.includes('BUY')) {
        analysis = 'Bullish signals detected with strong technical alignment.';
    } else if (signal.includes('SELL')) {
        analysis = 'Bearish pressure building. Consider risk management.';
    } else {
        analysis = 'Market is neutral. Waiting for clearer direction.';
    }
    
    const message = document.createElement('div');
    message.className = 'chat-message';
    message.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="fas fa-robot fs-4 me-2" style="color: var(--accent-cyan);"></i>
            <strong style="color: var(--accent-cyan);">AI Analysis</strong>
            <small class="ms-auto text-muted">${formatTime(new Date())}</small>
        </div>
        <p class="mb-2">Price: $${formatNumber(price, 2)} | RSI: ${rsi.toFixed(1)} | Patterns: ${patterns}</p>
        <p class="mb-0">${analysis} Confidence: ${currentData.signal?.confidence?.toFixed(1) || 0}%</p>
    `;
    
    chat.appendChild(message);
    chat.scrollTop = chat.scrollHeight;
}

// ==================== TRAIN MODELS ====================
async function trainModels() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    
    try {
        showNotification('Training models...', 'info');
        
        const data = await fetchAPI(`${CONFIG.backendUrl}/api/train/${symbol}`, {
            method: 'POST'
        });
        
        if (data.success) {
            showNotification('Models trained successfully', 'success');
            setTimeout(() => analyzeSymbol(true), 2000);
        } else {
            throw new Error('Training failed');
        }
    } catch (error) {
        console.error('Training error:', error);
        showNotification('Training failed: ' + error.message, 'error');
    }
}

// ==================== HEALTH CHECK ====================
async function checkHealth() {
    try {
        const data = await fetchAPI(`${CONFIG.backendUrl}/health`);
        const connected = data.status === 'healthy';
        updateConnectionStatus(connected);
        
        if (connected) {
            analyzeSymbol();
            connectWebSocket();
        }
        
        return connected;
    } catch (error) {
        console.error('Health check error:', error);
        updateConnectionStatus(false);
        return false;
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    console.log('ICTSMARTPRO Frontend v7.0');
    
    renderExchangeGrid();
    updateExchangeStatus(0);
    
    // Check health and start
    checkHealth();
    
    // Load TradingView
    setTimeout(loadTradingView, 1000);
    
    // Periodic refresh
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            analyzeSymbol();
        }
    }, CONFIG.refreshInterval);
    
    // Event listeners
    document.getElementById('symbolSelect').addEventListener('change', () => {
        loadTradingView();
        connectWebSocket();
        analyzeSymbol(true);
    });
    
    document.getElementById('intervalSelect').addEventListener('change', () => {
        loadTradingView();
        analyzeSymbol(true);
    });
});

// Cleanup
window.addEventListener('beforeunload', () => {
    if (ws) ws.close();
    if (tvWidget) tvWidget.remove();
});
</script>
</body>
</html>
