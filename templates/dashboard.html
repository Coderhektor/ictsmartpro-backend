<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICTSMARTPRO v9.0</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Unbounded:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://s3.tradingview.com/tv.js"></script>
<style>

/* ─── RESET ─────────────────────────────────────────────────────── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}

/* ─── TOKENS ─────────────────────────────────────────────────────── */
:root{
  --bg0:#04060a;
  --bg1:#080c13;
  --bg2:#0c1220;
  --bg3:#101828;
  --line:#1a2840;
  --line2:#1f3050;
  --text:#c8d8f0;
  --dim:#4a6080;
  --white:#e8f0ff;

  --blue:#3b82f6;
  --blue2:#1d4ed8;
  --blue-a:rgba(59,130,246,.15);
  --cyan:#22d3ee;
  --cyan-a:rgba(34,211,238,.12);
  --green:#10b981;
  --green2:#059669;
  --green-a:rgba(16,185,129,.12);
  --red:#f43f5e;
  --red2:#be123c;
  --red-a:rgba(244,63,94,.12);
  --amber:#f59e0b;
  --amber-a:rgba(245,158,11,.12);
  --purple:#a78bfa;
  --purple-a:rgba(167,139,250,.12);

  --r:8px;
  --r2:12px;
  --r3:16px;
  --mono:'JetBrains Mono',monospace;
  --head:'Unbounded',sans-serif;
}

/* ─── BODY ─────────────────────────────────────────────────────── */
body{
  background:var(--bg0);
  color:var(--text);
  font-family:var(--mono);
  font-size:14px; /* 13 -> 14 */
  line-height:1.6; /* 1.55 -> 1.6 */
  min-height:100vh;
  overflow-x:hidden;
}

/* scanline overlay */
body::before{
  content:'';
  position:fixed;inset:0;
  background:repeating-linear-gradient(
    0deg,
    transparent,transparent 2px,
    rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px
  );
  pointer-events:none;z-index:999;
}

/* ─── TOPBAR ─────────────────────────────────────────────────────── */
#topbar{
  position:sticky;top:0;z-index:200;
  height:56px; /* 52 -> 56 */
  display:flex;align-items:center;gap:16px;
  padding:0 24px;
  background:rgba(4,6,10,.92);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--line);
}

.brand{
  font-family:var(--head);
  font-size:1rem; /* .95 -> 1.0 */
  font-weight:900;
  letter-spacing:-.03em;color:var(--white);
  display:flex;align-items:center;gap:6px;
}
.brand-accent{color:var(--blue);}
.brand-ver{
  font-size:.65rem; /* .58 -> .65 */
  font-weight:400;
  color:var(--dim);padding:2px 6px;
  border:1px solid var(--line);border-radius:4px;
  font-family:var(--mono);
}

.vsep{width:1px;height:22px;background:var(--line);flex-shrink:0;}
.spacer{flex:1;}

.badge-pill{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 12px; /* 3px 10px -> 4px 12px */
  border-radius:20px;
  font-family:var(--mono);font-size:.75rem; /* .68 -> .75 */
  font-weight:600;
  border:1px solid;transition:all .25s;user-select:none;
}
.badge-pill.green{color:var(--green);border-color:var(--green);background:var(--green-a);}
.badge-pill.red  {color:var(--red);  border-color:var(--red);  background:var(--red-a);}
.badge-pill.blue {color:var(--blue); border-color:var(--blue); background:var(--blue-a);}
.badge-pill.dim  {color:var(--dim);  border-color:var(--line); background:transparent;}
.badge-pill.amber{color:var(--amber);border-color:var(--amber);background:var(--amber-a);}

.pulse{
  width:6px;height:6px;border-radius:50%;
  background:currentColor;
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}

#clockEl{font-size:.8rem; /* .72 -> .8 */ color:var(--dim);letter-spacing:.04em;}

/* ─── LAYOUT ─────────────────────────────────────────────────────── */
#shell{
  display:grid;
  grid-template-columns:1fr 340px; /* 320 -> 340 */
  gap:16px; /* 14 -> 16 */
  padding:16px 20px 20px; /* 14px -> 16px */
  max-width:1700px;
  margin:0 auto;
}
@media(max-width:1100px){
  #shell{grid-template-columns:1fr;}
}

#main{display:flex;flex-direction:column;gap:16px;}
#side{display:flex;flex-direction:column;gap:16px;}

/* ─── CARD ─────────────────────────────────────────────────────── */
.card{
  background:var(--bg1);
  border:1px solid var(--line);
  border-radius:var(--r2);
  overflow:hidden;
  transition:border-color .2s;
}
.card:hover{border-color:var(--line2);}

.ch{
  display:flex;align-items:center;gap:8px;
  padding:12px 16px; /* 10px 14px -> 12px 16px */
  border-bottom:1px solid var(--line);
  font-family:var(--head);
  font-size:.7rem; /* .62 -> .7 */
  font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;
  color:var(--dim);
}
.ch i{color:var(--blue);font-size:.9rem;} /* .8 -> .9 */
.ch .chl{color:var(--text);font-weight:600;}
.ch .mleft{margin-left:auto;}
.ch .cbadge{
  padding:2px 8px; /* 1px 7px -> 2px 8px */
  border-radius:20px;
  background:var(--bg2);border:1px solid var(--line);
  font-family:var(--mono);font-size:.7rem; /* .65 -> .7 */
  color:var(--dim);
}

.cb{padding:16px;} /* 14px -> 16px */

/* ─── CONTROLS ─────────────────────────────────────────────────── */
#ctrl-row{
  display:flex;flex-wrap:wrap;align-items:center;gap:12px; /* 10px -> 12px */
  padding:14px 16px; /* 12px 14px -> 14px 16px */
}

select{
  background:var(--bg2);color:var(--text);
  border:1px solid var(--line);border-radius:var(--r);
  padding:8px 32px 8px 12px; /* 7px 28px 7px 10px -> 8px 32px 8px 12px */
  font-family:var(--mono);font-size:.85rem; /* .78 -> .85 */
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%234a6080'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;
  cursor:pointer;outline:none;transition:border-color .2s;
}
select:focus{border-color:var(--blue);}

.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 20px; /* 7px 18px -> 8px 20px */
  border-radius:var(--r);
  font-family:var(--mono);font-size:.85rem; /* .78 -> .85 */
  font-weight:600;
  border:none;cursor:pointer;transition:all .18s;outline:none;
}
.btn-blue{background:var(--blue);color:#fff;}
.btn-blue:hover{background:var(--blue2);transform:translateY(-1px);}
.btn-blue:active{transform:scale(.97);}
.btn-ghost{background:transparent;color:var(--blue);border:1px solid var(--line);}
.btn-ghost:hover{border-color:var(--blue);background:var(--blue-a);}

.spin{
  display:inline-block;width:12px;height:12px;
  border:2px solid rgba(255,255,255,.25);
  border-top-color:#fff;border-radius:50%;
  animation:rot .6s linear infinite;
}
@keyframes rot{to{transform:rotate(360deg)}}

/* ─── PRICE + SIGNAL ROW ─────────────────────────────────────────── */
#priceSigRow{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px; /* 14 -> 16 */
}
@media(max-width:650px){#priceSigRow{grid-template-columns:1fr;}}

/* price card */
.price-sym{
  font-family:var(--head);font-size:.7rem; /* .6 -> .7 */
  font-weight:600;
  color:var(--dim);letter-spacing:.15em;margin-bottom:8px;
}
.price-big{
  font-family:var(--head);
  font-size:clamp(1.8rem,4vw,2.8rem); /* 1.6/2.6 -> 1.8/2.8 */
  font-weight:900;
  line-height:1;letter-spacing:-.04em;
  color:var(--white);word-break:break-all;
}
.flash-green{animation:fg .4s ease;}
.flash-red  {animation:fr .4s ease;}
@keyframes fg{0%{color:var(--green)}100%{color:var(--white)}}
@keyframes fr{0%{color:var(--red)}100%{color:var(--white)}}

.chg-badge{
  display:inline-flex;align-items:center;gap:4px;
  margin-top:10px;margin-bottom:14px;
  padding:5px 12px; /* 4px 10px -> 5px 12px */
  border-radius:20px;
  font-size:.8rem; /* .75 -> .8 */
  font-weight:600;
}
.chg-up  {color:var(--green);background:var(--green-a);border:1px solid var(--green);}
.chg-dn  {color:var(--red);  background:var(--red-a);  border:1px solid var(--red);  }
.chg-flat{color:var(--dim);  background:var(--bg2);    border:1px solid var(--line); }

.kv-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0; /* 7px -> 8px */
  border-bottom:1px solid var(--line);
}
.kv-row:last-child{border-bottom:none;}
.kv-lbl{font-size:.8rem; /* .72 -> .8 */ color:var(--dim);}
.kv-val{font-size:.85rem; /* .78 -> .85 */ font-weight:600;color:var(--white);}

/* signal card */
.sig-lbl{
  display:flex;align-items:center;justify-content:center;
  padding:18px; /* 16px -> 18px */
  border-radius:var(--r);
  font-family:var(--head);font-size:1.2rem; /* 1.1 -> 1.2 */
  font-weight:900;
  letter-spacing:.04em;text-transform:uppercase;
  margin-bottom:16px; /* 14px -> 16px */
  transition:all .4s;
}
.sig-STRONG_BUY {background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 0 24px rgba(16,185,129,.3);}
.sig-BUY        {background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;box-shadow:0 0 24px rgba(59,130,246,.25);}
.sig-NEUTRAL    {background:var(--bg2);color:var(--dim);border:1px solid var(--line);}
.sig-SELL       {background:linear-gradient(135deg,#f43f5e,#be123c);color:#fff;box-shadow:0 0 24px rgba(244,63,94,.25);}
.sig-STRONG_SELL{background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;box-shadow:0 0 24px rgba(220,38,38,.3);}

.conf-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;} /* 5px -> 6px */
.conf-track{background:var(--bg2);border-radius:99px;height:6px;overflow:hidden;margin-bottom:12px;} /* 10px -> 12px */
.conf-fill{height:100%;border-radius:99px;background:var(--blue);transition:width .7s ease;}
.conf-pct{font-family:var(--mono);font-size:.8rem; /* .72 -> .8 */ color:var(--dim);}

.rec-box{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:12px; /* 10px -> 12px */
  margin-top:12px; /* 10px -> 12px */
  font-size:.8rem; /* .72 -> .8 */
  color:var(--dim);line-height:1.6; /* 1.5 -> 1.6 */
  min-height:40px; /* 36px -> 40px */
}

.tpsl-row{
  display:flex;justify-content:space-around;
  margin-top:12px; /* 10px -> 12px */
  padding-top:12px; /* 10px -> 12px */
  border-top:1px solid var(--line);
}
.tpsl-box{text-align:center;}
.tpsl-box .tpsl-lbl{font-size:.7rem; /* .62 -> .7 */ color:var(--dim);margin-bottom:2px;}
.tpsl-box .tpsl-val{font-size:.9rem; /* .82 -> .9 */ font-weight:600;}
.tp-val{color:var(--green);}
.sl-val{color:var(--red);}

/* ─── BUY/SELL COUNTER ─────────────────────────────────────────── */
.bs-counter{
  display:flex;gap:10px; /* 8px -> 10px */
  margin-top:12px; /* 10px -> 12px */
}
.bs-box{
  flex:1;padding:10px; /* 8px -> 10px */
  border-radius:var(--r);
  text-align:center;
}
.bs-buy {background:var(--green-a);border:1px solid var(--green);}
.bs-sell{background:var(--red-a);  border:1px solid var(--red);}
.bs-num{font-family:var(--head);font-size:1.6rem; /* 1.4 -> 1.6 */ font-weight:900;}
.bs-buy  .bs-num{color:var(--green);}
.bs-sell .bs-num{color:var(--red);}
.bs-txt{font-size:.7rem; /* .65 -> .7 */ color:var(--dim);margin-top:2px;}

/* ─── CHART ─────────────────────────────────────────────────────── */
#chartWrap{position:relative;width:100%;height:500px;background:var(--bg2);border-radius:0 0 var(--r2) var(--r2);}
@media(max-width:768px){#chartWrap{height:320px;}}
#tvRoot{position:absolute;inset:0;}
#chartLoader{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:var(--bg2);gap:12px;z-index:10;
  transition:opacity .4s;
}
#chartLoader.gone{opacity:0;pointer-events:none;}
.big-spin{
  width:36px;height:36px;
  border:3px solid var(--line);
  border-top-color:var(--blue);
  border-radius:50%;
  animation:rot 1s linear infinite;
}
#chartLoader p{font-size:.8rem; /* .75 -> .8 */ color:var(--dim);}

/* ─── HEIKIN ASHI GRID ─────────────────────────────────────────── */
.ha-grid{
  display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px; /* 8px -> 10px */
}
@media(max-width:500px){.ha-grid{grid-template-columns:1fr 1fr;}}
.ha-box{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:12px; /* 10px -> 12px */
  text-align:center;
}
.ha-lbl{font-size:.65rem; /* .6 -> .65 */ color:var(--dim);letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px;}
.ha-val{font-size:1rem; /* .95 -> 1.0 */ font-weight:700;font-family:var(--head);}

/* ─── TECH INDICATORS ─────────────────────────────────────────── */
#techGrid{
  display:grid;grid-template-columns:1fr 1fr;gap:10px; /* 8px -> 10px */
}
@media(max-width:480px){#techGrid{grid-template-columns:1fr;}}
.tech-box{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:12px 14px; /* 10px 12px -> 12px 14px */
}
.tech-lbl{font-size:.65rem; /* .6 -> .65 */ color:var(--dim);letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px;} /* 3px -> 4px */
.tech-val{font-size:.95rem; /* .88 -> .95 */ font-weight:600;}
.tech-sub{font-size:.7rem; /* .65 -> .7 */ color:var(--dim);margin-top:2px;}
.bar-track{background:var(--line);border-radius:99px;height:4px;margin-top:6px;overflow:hidden;}
.bar-fill{height:100%;border-radius:99px;transition:width .5s ease;}

/* ─── ICT PATTERNS ─────────────────────────────────────────────── */
.ict-table{width:100%;border-collapse:collapse;}
.ict-table th{
  padding:8px 12px; /* 6px 10px -> 8px 12px */
  text-align:left;
  font-family:var(--head);font-size:.65rem; /* .58 -> .65 */
  font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;
  color:var(--dim);border-bottom:1px solid var(--line);
}
.ict-table td{
  padding:9px 12px; /* 7px 10px -> 9px 12px */
  font-size:.8rem; /* .75 -> .8 */
  border-bottom:1px solid var(--line);
}
.ict-table tr:last-child td{border-bottom:none;}
.ict-table tr:hover td{background:var(--bg2);}
.ict-dir-bull{color:var(--green);}
.ict-dir-bear{color:var(--red);}
.ict-str-bar{
  display:inline-block;width:60px;height:4px;
  background:var(--line);border-radius:99px;overflow:hidden;vertical-align:middle;
}
.ict-str-fill{height:100%;border-radius:99px;background:var(--blue);}

/* ─── PATTERN CHIPS ─────────────────────────────────────────────── */
.chip-row{display:flex;flex-wrap:wrap;gap:8px; /* 6px -> 8px */ min-height:32px;} /* 28px -> 32px */
.chip{
  padding:4px 12px; /* 3px 9px -> 4px 12px */
  border-radius:20px;
  font-family:var(--mono);font-size:.75rem; /* .68 -> .75 */
  font-weight:600;
}
.chip-bull{background:var(--green-a);color:var(--green);border:1px solid var(--green);}
.chip-bear{background:var(--red-a);  color:var(--red);  border:1px solid var(--red);  }
.chip-neut{background:var(--bg2);   color:var(--dim);  border:1px solid var(--line);  }

/* ─── STRATEGY CARDS (ICTSMARTPRO ONLY) ─────────────────────────── */
#stratRow{display:grid;grid-template-columns:1fr 1fr;gap:16px;} /* 14px -> 16px */
@media(max-width:650px){#stratRow{grid-template-columns:1fr;}}

.strat-card{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:14px; /* 12px -> 14px */
}
.strat-head{
  display:flex;align-items:center;gap:8px; /* 6px -> 8px */
  margin-bottom:12px; /* 10px -> 12px */
}
.strat-icon{
  width:32px;height:32px; /* 28px -> 32px */
  border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:.9rem; /* .8 -> .9 */
}
.strat-icon.isp{background:var(--blue-a);color:var(--blue);} /* GainzAlgo kalktı, ICTSMARTPRO ikonu */
.strat-name{font-family:var(--head);font-size:.75rem; /* .65 -> .75 */ font-weight:700;letter-spacing:.08em;color:var(--white);}
.strat-sub{font-size:.65rem; /* .6 -> .65 */ color:var(--dim);}

.strat-sig{
  display:flex;align-items:center;gap:8px; /* 6px -> 8px */
  padding:10px; /* 8px -> 10px */
  border-radius:var(--r);
  margin-bottom:10px; /* 8px -> 10px */
  font-family:var(--head);font-size:.85rem; /* .75 -> .85 */
  font-weight:700;
}
.strat-sig.bull{background:var(--green-a);border:1px solid var(--green);color:var(--green);}
.strat-sig.bear{background:var(--red-a);  border:1px solid var(--red);  color:var(--red);}
.strat-sig.none{background:var(--bg3);    border:1px solid var(--line); color:var(--dim);}

.strat-tpsl{
  display:grid;grid-template-columns:1fr 1fr;gap:8px; /* 6px -> 8px */
}
.strat-tpsl-box{
  background:var(--bg1);border:1px solid var(--line);border-radius:6px;
  padding:8px 10px; /* 6px 8px -> 8px 10px */
  text-align:center;
}
.strat-tpsl-lbl{font-size:.65rem; /* .58 -> .65 */ color:var(--dim);}
.strat-tpsl-val{font-size:.9rem; /* .8 -> .9 */ font-weight:600;margin-top:2px;} /* 1px -> 2px */

/* ─── MARKET STRUCTURE ─────────────────────────────────────────── */
.ms-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;} /* 8px -> 10px */
@media(max-width:480px){.ms-grid{grid-template-columns:1fr;}}
.ms-box{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:12px; /* 10px -> 12px */
}
.ms-lbl{font-size:.65rem; /* .6 -> .65 */ color:var(--dim);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px;} /* 4px -> 5px */
.ms-val{font-size:.9rem; /* .82 -> .9 */ font-weight:600;}

  /* ─── ICT BULL/BEAR DENGESİ ─────────────────────────────────────── */
#ictBalanceCard {
  margin-top: 16px;
}
.ict-balance-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.ict-balance-box {
  background: var(--bg2);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 14px;
  text-align: center;
}
.ict-balance-box.bull { border-color: var(--green); background: var(--green-a); }
.ict-balance-box.bear { border-color: var(--red); background: var(--red-a); }
.ict-balance-label {
  font-size: 0.7rem;
  color: var(--dim);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 6px;
}
.ict-balance-number {
  font-family: var(--head);
  font-size: 2.2rem;
  font-weight: 900;
  line-height: 1;
}
.ict-balance-number.bull { color: var(--green); }
.ict-balance-number.bear { color: var(--red); }

.ict-balance-result {
  background: var(--bg3);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 16px;
  text-align: center;
  margin-top: 8px;
}
.ict-balance-direction {
  font-family: var(--head);
  font-size: 1.4rem;
  font-weight: 900;
  letter-spacing: 0.04em;
  margin-bottom: 6px;
}
.ict-balance-direction.bull { color: var(--green); }
.ict-balance-direction.bear { color: var(--red); }
.ict-balance-direction.neutral { color: var(--dim); }
.ict-balance-desc {
  font-size: 0.85rem;
  color: var(--dim);
  line-height: 1.5;
}
.ict-balance-bar {
  background: var(--line);
  border-radius: 99px;
  height: 8px;
  width: 100%;
  margin: 12px 0 8px;
  overflow: hidden;
}
.ict-balance-fill {
  height: 100%;
  border-radius: 99px;
  transition: width 0.5s ease;
}
.ict-balance-fill.bull { background: var(--green); }
.ict-balance-fill.bear { background: var(--red); }
.ict-balance-fill.neutral { background: var(--dim); }

/* ─── SIDE: ML MODELS ─────────────────────────────────────────── */
.ml-row{display:flex;justify-content:space-between;margin-bottom:4px; /* 3px -> 4px */ font-size:.8rem;} /* .75 -> .8 */
.ml-name{color:var(--text);}
.ml-pct{font-weight:600;}
.ml-track{background:var(--bg2);border-radius:99px;height:5px;overflow:hidden;margin-bottom:12px;} /* 10px -> 12px */
.ml-fill{height:100%;border-radius:99px;transition:width .7s ease;}
.ml-blue   {background:var(--cyan);}
.ml-green  {background:var(--green);}
.ml-purple {background:var(--purple);}
.ml-amber  {background:var(--amber);}

/* ─── SIDE: DATA POOL ─────────────────────────────────────────── */
.pool-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0; /* 7px -> 8px */
  border-bottom:1px solid var(--line);
}
.pool-row:last-child{border-bottom:none;}
.pool-lbl{font-size:.8rem; /* .72 -> .8 */ color:var(--dim);}
.pool-val{font-size:.85rem; /* .78 -> .85 */ font-weight:600;}
.health-track{background:var(--bg2);border-radius:99px;height:7px;margin:14px 0 10px; /* 12px 0 8px -> 14px 0 10px */ overflow:hidden;}
.health-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--green));transition:width .6s ease;}

/* ─── SIDE: EXCHANGE STATUS ─────────────────────────────────────── */
#exGrid{
  display:grid;grid-template-columns:repeat(2,1fr);gap:8px; /* 6px -> 8px */
}
.ex-card{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  padding:12px; /* 10px -> 12px */
  text-align:center;transition:all .2s;
}
.ex-card.ok {border-color:var(--green);background:var(--green-a);}
.ex-card.err{border-color:var(--red);  opacity:.55;}
.ex-name{font-family:var(--head);font-size:.7rem; /* .62 -> .7 */ font-weight:700;display:block;margin-bottom:5px;}
.ex-rel{font-size:.7rem; /* .65 -> .7 */ color:var(--dim);}
.ex-emoji{font-size:1.1rem;} /* 1rem -> 1.1rem */
.ex-err{font-size:.65rem; /* .58 -> .65 */ color:var(--red);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ─── SIDE: AI CHAT ─────────────────────────────────────────────── */
#chatLog{
  background:var(--bg2);border:1px solid var(--line);border-radius:var(--r);
  min-height:100px;max-height:220px;overflow-y:auto;
  padding:12px; /* 10px -> 12px */
  margin-bottom:12px; /* 10px -> 12px */
  scrollbar-width:thin;scrollbar-color:var(--line) transparent;
}
.chat-msg{
  background:rgba(59,130,246,.07);border:1px solid var(--line);
  border-radius:var(--r);padding:12px; /* 10px -> 12px */
  margin-bottom:10px; /* 8px -> 10px */
}
.chat-msg:last-child{margin-bottom:0;}
.chat-from{font-family:var(--head);font-size:.7rem; /* .6 -> .7 */ font-weight:700;color:var(--blue);margin-bottom:5px;letter-spacing:.08em;}
.chat-body{font-size:.8rem; /* .73 -> .8 */ color:var(--text);line-height:1.6;}
.chat-body b{color:var(--white);}
.chat-note{color:var(--amber);font-size:.7rem; /* .65 -> .7 */ margin-top:6px;}
.chat-empty{font-size:.8rem; /* .75 -> .8 */ color:var(--dim);font-style:italic;}

/* ─── ACTIVITY LOG ─────────────────────────────────────────────── */
#logBox{
  max-height:140px;overflow-y:auto;
  scrollbar-width:thin;scrollbar-color:var(--line) transparent;
}
.log-line{
  display:flex;align-items:baseline;gap:8px; /* 6px -> 8px */
  padding:6px 0; /* 4px -> 6px */
  border-bottom:1px dashed var(--line);
  font-size:.75rem; /* .68 -> .75 */
}
.log-line:last-child{border-bottom:none;}
.log-time{color:var(--dim);flex-shrink:0;}
.log-msg{color:var(--text);}

/* ─── COLORS ─────────────────────────────────────────────────────── */
.c-green {color:var(--green)!important;}
.c-red   {color:var(--red)!important;}
.c-blue  {color:var(--blue)!important;}
.c-amber {color:var(--amber)!important;}
.c-cyan  {color:var(--cyan)!important;}
.c-purple{color:var(--purple)!important;}
.c-dim   {color:var(--dim)!important;}
.c-white {color:var(--white)!important;}

/* ─── EMPTY ─────────────────────────────────────────────────────── */
.empty{color:var(--dim);font-size:.8rem; /* .75 -> .8 */ font-style:italic;}

/* ─── SCROLLBAR ─────────────────────────────────────────────────── */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--line);border-radius:4px;}

/* ─── STATUS BAR ─────────────────────────────────────────────────── */
#statusBar{
  display:flex;align-items:center;gap:12px; /* 10px -> 12px */ flex-wrap:wrap;
  padding:10px 20px; /* 8px 20px -> 10px 20px */
  border-bottom:1px solid var(--line);
  background:rgba(4,6,10,.7);
  backdrop-filter:blur(8px);
  position:sticky;top:56px; /* 52px -> 56px (topbar height) */ z-index:150;
}
#statusBar .upd{margin-left:auto;font-size:.75rem; /* .68 -> .75 */ color:var(--dim);}

/* ─── PERF BADGE ─────────────────────────────────────────────────── */
#perfMs{
  font-family:var(--mono);font-size:.7rem; /* .65 -> .7 */ color:var(--dim);
}

/* ─── GRID: bottom rows ─────────────────────────────────────────── */
#techRow{display:grid;grid-template-columns:1fr 1fr;gap:16px;} /* 14px -> 16px */
#bottomRow{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:650px){
  #techRow{grid-template-columns:1fr;}
  #bottomRow{grid-template-columns:1fr;}
}

</style>
</head>
<body>

<!-- ─── TOPBAR ────────────────────────────────────────────────────── -->
<header id="topbar">
  <div class="brand">
    ICT<span class="brand-accent">SMART</span>PRO
    <span class="brand-ver">v9.0</span>
  </div>
  <div class="vsep"></div>
  <div class="badge-pill green" id="backendPill"><div class="pulse"></div><span>BACKEND</span></div>
  <div class="badge-pill dim"   id="wsPill"><i class="fas fa-wifi" style="font-size:.8rem"></i><span id="wsLabel">BAĞLANIYOR</span></div>
  <div class="spacer"></div>
  <div id="clockEl">--:--:--</div>
</header>

<!-- ─── STATUS BAR ─────────────────────────────────────────────────── -->
<div id="statusBar">
  <div class="badge-pill blue" id="srcPill"><i class="fas fa-server" style="font-size:.7rem"></i><span id="srcText">0/4 Kaynak</span></div>
  <div class="badge-pill dim"  id="dataPill"><i class="fas fa-database" style="font-size:.7rem"></i><span id="dataText">— mum</span></div>
  <div id="perfMs">—</div>
  <div class="upd" id="updText">Son güncelleme: —</div>
</div>

<!-- ─── SHELL ───────────────────────────────────────────────────────── -->
<div id="shell">

<!-- ═══ MAIN ═══════════════════════════════════════════════════════ -->
<div id="main">

  <!-- Controls -->
  <div class="card">
    <div class="ch"><i class="fas fa-sliders"></i><span class="chl">ANALİZ KONTROLÜ</span></div>
    <div id="ctrl-row">
      <select id="selSym">
        <option value="BTC">₿ BTC / USDT</option>
        <option value="ETH">Ξ ETH / USDT</option>
        <option value="SOL">◎ SOL / USDT</option>
        <option value="BNB">BNB / USDT</option>
        <option value="XRP">XRP / USDT</option>
        <option value="ADA">ADA / USDT</option>
        <option value="DOGE">DOGE / USDT</option>
        <option value="AVAX">AVAX / USDT</option>
        <option value="LINK">LINK / USDT</option>
        <option value="DOT">DOT / USDT</option>
      </select>
      <select id="selTf">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="1h" selected>1s</option>
        <option value="4h">4s</option>
        <option value="1d">1G</option>
        <option value="1w">1H</option>
      </select>
      <select id="selLimit">
        <option value="100">100 Mum</option>
        <option value="200" selected>200 Mum</option>
        <option value="500">500 Mum</option>
      </select>
      <button class="btn btn-blue" id="analyzeBtn">
        <i class="fas fa-magnifying-glass"></i> ANALİZ ET
      </button>
      <button class="btn btn-ghost" id="refreshBtn" title="Yenile">
        <i class="fas fa-rotate"></i>
      </button>
    </div>
  </div>

  <!-- Price + Signal -->
  <div id="priceSigRow">

    <!-- Price -->
    <div class="card">
      <div class="ch"><i class="fas fa-circle-dollar-to-slot"></i><span class="chl">CANLI FİYAT</span></div>
      <div class="cb">
        <div class="price-sym" id="priceSymLbl">BTC / USDT</div>
        <div class="price-big" id="priceBig">—</div>
        <div class="chg-flat" id="priceChg"><i class="fas fa-minus"></i> 0.00%</div>
        <div class="kv-row" style="margin-top:10px">
          <span class="kv-lbl">Yüksek (mum)</span>
          <span class="kv-val" id="kvHigh">—</span>
        </div>
        <div class="kv-row">
          <span class="kv-lbl">Düşük (mum)</span>
          <span class="kv-val" id="kvLow">—</span>
        </div>
        <div class="kv-row">
          <span class="kv-lbl">Açılış (mum)</span>
          <span class="kv-val" id="kvOpen">—</span>
        </div>
        <div class="kv-row">
          <span class="kv-lbl">~24s Hacim</span>
          <span class="kv-val" id="kvVol">—</span>
        </div>
        <div class="kv-row">
          <span class="kv-lbl">24s Değişim</span>
          <span class="kv-val" id="kv24h">—</span>
        </div>
        <div class="kv-row">
          <span class="kv-lbl">Aktif Kaynak</span>
          <span class="kv-val c-blue" id="kvSrc">—</span>
        </div>
      </div>
    </div>

    <!-- Signal -->
    <div class="card">
      <div class="ch"><i class="fas fa-brain"></i><span class="chl">ML SİNYALİ</span></div>
      <div class="cb">
        <div class="sig-lbl sig-NEUTRAL" id="sigLbl">ANALİZ BEKLENİYOR</div>
        
        <div class="conf-row">
          <span class="kv-lbl">Güven Skoru</span>
          <span class="conf-pct" id="confPct">%0</span>
        </div>
        <div class="conf-track"><div class="conf-fill" id="confFill" style="width:0%"></div></div>

        <div class="bs-counter">
          <div class="bs-box bs-buy">
            <div class="bs-num" id="buyCnt">0</div>
            <div class="bs-txt">AL SİNYALİ</div>
          </div>
          <div class="bs-box bs-sell">
            <div class="bs-num" id="sellCnt">0</div>
            <div class="bs-txt">SAT SİNYALİ</div>
          </div>
        </div>

        <div class="rec-box" id="recBox">Analiz bekleniyor...</div>

        <div class="tpsl-row">
          <div class="tpsl-box">
            <div class="tpsl-lbl">Hedef Fiyat (TP)</div>
            <div class="tpsl-val tp-val" id="tpVal">—</div>
          </div>
          <div class="tpsl-box">
            <div class="tpsl-lbl">Zarar Durdur (SL)</div>
            <div class="tpsl-val sl-val" id="slVal">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TradingView Chart -->
  <div class="card">
    <div class="ch"><i class="fas fa-chart-candlestick"></i><span class="chl">CANLI GRAFİK</span><span class="cbadge mleft" id="chartBadge">TradingView</span></div>
    <div id="chartWrap">
      <div id="tvRoot"></div>
      <div id="chartLoader">
        <div class="big-spin"></div>
        <p>Grafik yükleniyor...</p>
      </div>
    </div>
  </div>

  <!-- Heikin Ashi + Technical -->
  <div id="techRow">
    <div class="card">
      <div class="ch"><i class="fas fa-chart-area"></i><span class="chl">HEİKİN ASHİ</span></div>
      <div class="cb">
        <div class="ha-grid">
          <div class="ha-box">
            <div class="ha-lbl">Trend</div>
            <div class="ha-val" id="haTrend">—</div>
          </div>
          <div class="ha-box">
            <div class="ha-lbl">HA RSI</div>
            <div class="ha-val" id="haRsi">—</div>
          </div>
          <div class="ha-box">
            <div class="ha-lbl">Güç %</div>
            <div class="ha-val" id="haStr">—</div>
          </div>
          <div class="ha-box">
            <div class="ha-lbl">Renk Değ.</div>
            <div class="ha-val" id="haColorChg">—</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="kv-row">
            <span class="kv-lbl">HA Close</span>
            <span class="kv-val" id="haClose">—</span>
          </div>
          <div class="kv-row">
            <span class="kv-lbl">Momentum 5</span>
            <span class="kv-val" id="haMom">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="ch"><i class="fas fa-flask-vial"></i><span class="chl">TEKNİK GÖSTERGELER</span></div>
      <div class="cb">
        <div id="techGrid">
          <div class="empty">Analiz bekleniyor...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Strategy Signals: ICTSMARTPRO ONLY (GainzAlgo & Ultimate KALDIRILDI) -->
  <div class="card">
    <div class="ch"><i class="fas fa-bolt"></i><span class="chl">ICTSMARTPRO STRATEJİSİ</span><span class="cbadge mleft" id="stratCount">0 sinyal</span></div>
    <div class="cb">
      <div id="stratRow">

        <!-- ICTSMARTPRO Ana Strateji -->
        <div class="strat-card">
          <div class="strat-head">
            <div class="strat-icon isp"><i class="fas fa-chess-queen"></i></div> <!-- Şahane bir ikon -->
            <div>
              <div class="strat-name">ICTSMARTPRO V9</div>
              <div class="strat-sub">HH/HL + S/R Bölgeleri + FVG + Order Blocks</div>
            </div>
          </div>
          <div class="strat-sig none" id="ispSig"><i class="fas fa-minus"></i> Sinyal Yok</div>
          <div class="strat-tpsl">
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">Giriş</div>
              <div class="strat-tpsl-val" id="ispEntry">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">TP</div>
              <div class="strat-tpsl-val c-green" id="ispTp">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">SL</div>
              <div class="strat-tpsl-val c-red" id="ispSl">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">Güç</div>
              <div class="strat-tpsl-val c-amber" id="ispStr">—</div>
            </div>
          </div>
        </div>

        <!-- İkinci kart (ileriye dönük, şimdilik aynı, ileride farklı TF stratejisi eklenebilir) -->
        <div class="strat-card">
          <div class="strat-head">
            <div class="strat-icon isp"><i class="fas fa-chart-line"></i></div>
            <div>
              <div class="strat-name">ICTSMARTPRO MOMENTUM</div>
              <div class="strat-sub">Displacement + MSS + CHoCH</div>
            </div>
          </div>
          <div class="strat-sig none" id="ispMomSig"><i class="fas fa-minus"></i> Sinyal Yok</div>
          <div class="strat-tpsl">
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">Giriş</div>
              <div class="strat-tpsl-val" id="ispMomEntry">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">TP</div>
              <div class="strat-tpsl-val c-green" id="ispMomTp">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">SL</div>
              <div class="strat-tpsl-val c-red" id="ispMomSl">—</div>
            </div>
            <div class="strat-tpsl-box">
              <div class="strat-tpsl-lbl">Güç</div>
              <div class="strat-tpsl-val c-amber" id="ispMomStr">—</div>
            </div>
          </div>
        </div>

      </div><!-- /#stratRow -->
    </div>
  </div>
 <!-- ICT BULL/BEAR DENGESİ (YENİ KART) -->
<div class="card" id="ictBalanceCard">
  <div class="ch"><i class="fas fa-scale-balanced"></i><span class="chl">ICT BULL/BEAR DENGESİ</span><span class="cbadge mleft" id="ictBalanceBadge">0 pattern</span></div>
  <div class="cb">
    <div class="ict-balance-grid">
      <div class="ict-balance-box bull">
        <div class="ict-balance-label">BOĞA PATERNLERİ</div>
        <div class="ict-balance-number bull" id="ictBullCount">0</div>
      </div>
      <div class="ict-balance-box bear">
        <div class="ict-balance-label">AYI PATERNLERİ</div>
        <div class="ict-balance-number bear" id="ictBearCount">0</div>
      </div>
    </div>
    
    <div class="ict-balance-bar">
      <div class="ict-balance-fill neutral" id="ictBalanceFill" style="width: 50%"></div>
    </div>
    
    <div class="ict-balance-result" id="ictBalanceResult">
      <div class="ict-balance-direction neutral" id="ictDirection">TARAF BELİRSİZ</div>
      <div class="ict-balance-desc" id="ictBalanceDesc">Analiz bekleniyor...</div>
    </div>
  </div>
</div>

  <!-- ICT Patterns -->
  <div class="card">
    <div class="ch"><i class="fas fa-chess-knight"></i><span class="chl">ICT PATTERN ANALİZİ</span><span class="cbadge mleft" id="ictTotalBadge">0 pattern</span></div>
    <div class="cb">
      <div style="overflow-x:auto;">
        <table class="ict-table" id="ictTable">
          <thead>
            <tr>
              <th>Pattern Tipi</th>
              <th>Son Sinyal</th>
              <th>Fiyat</th>
              <th>Güç</th>
              <th>Detay</th>
            </tr>
          </thead>
          <tbody id="ictTbody">
            <tr><td colspan="5" class="empty" style="padding:12px">Analiz bekleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bottom Row: Candles + Classical -->
  <div id="bottomRow">
    <div class="card">
      <div class="ch"><i class="fas fa-candle-holder"></i><span class="chl">MUM PATERNLERİ</span><span class="cbadge mleft" id="candleBadge">0</span></div>
      <div class="cb">
        <div class="chip-row" id="candleChips"><span class="empty">—</span></div>
      </div>
    </div>
    <div class="card">
      <div class="ch"><i class="fas fa-landmark"></i><span class="chl">KLASİK FORMASYONLAR</span><span class="cbadge mleft" id="classicBadge">0</span></div>
      <div class="cb">
        <div class="chip-row" id="classicChips"><span class="empty">—</span></div>
      </div>
    </div>
  </div>

  <!-- Market Structure -->
  <div class="card">
    <div class="ch"><i class="fas fa-water"></i><span class="chl">PİYASA YAPISI</span></div>
    <div class="cb">
      <div class="ms-grid">
        <div class="ms-box">
          <div class="ms-lbl">Trend</div>
          <div class="ms-val" id="msTrend">—</div>
        </div>
        <div class="ms-box">
          <div class="ms-lbl">Trend Gücü</div>
          <div class="ms-val" id="msTrendStr">—</div>
        </div>
        <div class="ms-box">
          <div class="ms-lbl">Yapı</div>
          <div class="ms-val" id="msStruct">—</div>
        </div>
        <div class="ms-box">
          <div class="ms-lbl">Volatilite</div>
          <div class="ms-val" id="msVol">—</div>
        </div>
        <div class="ms-box">
          <div class="ms-lbl">Volatilite İndeksi</div>
          <div class="ms-val" id="msVolIdx">—</div>
        </div>
        <div class="ms-box">
          <div class="ms-lbl">Momentum</div>
          <div class="ms-val" id="msMom">—</div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /#main -->

<!-- ═══ SIDE ═══════════════════════════════════════════════════════ -->
<div id="side">

  <!-- ML Models -->
  <div class="card">
    <div class="ch"><i class="fas fa-microchip"></i><span class="chl">ML MODELLERİ</span></div>
    <div class="cb">
      <div class="ml-row"><span class="ml-name">LightGBM</span><span class="ml-pct c-cyan" id="lgbmP">—</span></div>
      <div class="ml-track"><div class="ml-fill ml-blue" id="lgbmB" style="width:0%"></div></div>
      <div class="ml-row"><span class="ml-name">XGBoost</span><span class="ml-pct c-green" id="xgbP">—</span></div>
      <div class="ml-track"><div class="ml-fill ml-green" id="xgbB" style="width:0%"></div></div>
      <div class="ml-row"><span class="ml-name">Transformer</span><span class="ml-pct c-purple" id="tfP">—</span></div>
      <div class="ml-track"><div class="ml-fill ml-purple" id="tfB" style="width:0%"></div></div>
      <div class="ml-row"><span class="ml-name">Random Forest</span><span class="ml-pct c-amber" id="rfP">—</span></div>
      <div class="ml-track"><div class="ml-fill ml-amber" id="rfB" style="width:0%"></div></div>
      <button class="btn btn-ghost" style="width:100%;margin-top:12px;justify-content:center" id="trainBtn">
        <i class="fas fa-rotate"></i> Modelleri Eğit
      </button>
    </div>
  </div>

  <!-- Data Pool -->
  <div class="card">
    <div class="ch"><i class="fas fa-database"></i><span class="chl">VERİ HAVUZU</span></div>
    <div class="cb">
      <div class="pool-row"><span class="pool-lbl">Toplam Kaynak</span><span class="pool-val">4</span></div>
      <div class="pool-row"><span class="pool-lbl">Aktif Kaynak</span><span class="pool-val c-green" id="poolActive">—</span></div>
      <div class="pool-row"><span class="pool-lbl">Başarısız</span><span class="pool-val c-red" id="poolFail">—</span></div>
      <div class="pool-row"><span class="pool-lbl">Cache TTL</span><span class="pool-val">45s</span></div>
      <div class="pool-row"><span class="pool-lbl">Mum Sayısı</span><span class="pool-val c-blue" id="poolCandles">—</span></div>
      <div class="pool-row"><span class="pool-lbl">Süre (ms)</span><span class="pool-val c-cyan" id="poolMs">—</span></div>
      <div class="health-track"><div class="health-fill" id="healthFill" style="width:0%"></div></div>
      <div style="font-size:.7rem;color:var(--dim)" id="poolUpd">—</div>
    </div>
  </div>

  <!-- Exchange Status -->
  <div class="card">
    <div class="ch"><i class="fas fa-server"></i><span class="chl">KAYNAK DURUMU</span><span class="cbadge mleft" id="exBadge">0/4</span></div>
    <div class="cb" style="padding:12px">
      <div id="exGrid"></div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="card">
    <div class="ch"><i class="fas fa-robot"></i><span class="chl">AI ASİSTAN</span></div>
    <div class="cb">
      <div id="chatLog">
        <div class="chat-empty"><i class="fas fa-info-circle"></i> Analiz yaptıktan sonra "Değerlendir" butonuna tıklayın.</div>
      </div>
      <button class="btn btn-blue" style="width:100%;justify-content:center" id="evaluateBtn">
        <i class="fas fa-brain"></i> DEĞERLENDİR
      </button>
    </div>
  </div>

  <!-- Activity Log -->
  <div class="card">
    <div class="ch"><i class="fas fa-terminal"></i><span class="chl">AKTİVİTE LOGU</span></div>
    <div class="cb" style="padding:12px">
      <div id="logBox"></div>
    </div>
  </div>

</div><!-- /#side -->

</div><!-- /#shell -->

<!-- ─── SCRIPT ─────────────────────────────────────────────────────── -->
<script>
// ─────────────────────────────────────────────────────────
//  HELPERS
// ─────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const set = (id, v) => { const el=$(id); if(el) el.textContent = v; };
const html = (id, v) => { const el=$(id); if(el) el.innerHTML = v; };
const clamp = (v,lo,hi) => Math.min(hi,Math.max(lo,v));

function fmtP(n, dec=2) {
  if(n===null||n===undefined||isNaN(n)) return '—';
  if(n>=10000) return '$'+n.toLocaleString('tr-TR',{maximumFractionDigits:0});
  if(n>=1)     return '$'+n.toLocaleString('tr-TR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
  return '$'+Number(n).toFixed(6);
}
function fmtN(n,d=2){ if(n===null||n===undefined||isNaN(n)) return '—'; return Number(n).toLocaleString('tr-TR',{minimumFractionDigits:d,maximumFractionDigits:d}); }
function fmtVol(v){ if(!v||isNaN(v)) return '—'; if(v>=1e9) return (v/1e9).toFixed(2)+'B'; if(v>=1e6) return (v/1e6).toFixed(2)+'M'; if(v>=1e3) return (v/1e3).toFixed(2)+'K'; return Number(v).toFixed(2); }
function fmtT(d){ d=d||new Date(); return d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function dirCls(dir){ return (dir==='bullish'||dir==='bullish_reversal') ? 'c-green ict-dir-bull' : (dir==='bearish'||dir==='bearish_reversal') ? 'c-red ict-dir-bear' : 'c-dim'; }
function dirEmoji(dir){ return (dir==='bullish'||dir==='bullish_reversal') ? '▲' : (dir==='bearish'||dir==='bearish_reversal') ? '▼' : '—'; }
function chipCls(dir){ return (dir==='bullish'||dir==='bullish_reversal') ? 'chip chip-bull' : (dir==='bearish'||dir==='bearish_reversal') ? 'chip chip-bear' : 'chip chip-neut'; }

// ─────────────────────────────────────────────────────────
//  STATE
// ─────────────────────────────────────────────────────────
const S = { ws:null, wsRetries:0, tvW:null, data:null, lastPrice:null };

// ─────────────────────────────────────────────────────────
//  CLOCK
// ─────────────────────────────────────────────────────────
setInterval(()=>{ set('clockEl', fmtT()); }, 1000);
set('clockEl', fmtT());

// ─────────────────────────────────────────────────────────
//  LOG
// ─────────────────────────────────────────────────────────
function addLog(msg, cls=''){
  const box=$('logBox');
  if(!box) return;
  const d=document.createElement('div');
  d.className='log-line';
  d.innerHTML=`<span class="log-time">${fmtT()}</span><span class="log-msg ${cls}">${msg}</span>`;
  box.prepend(d);
  if(box.children.length>30) box.removeChild(box.lastChild);
}

// ─────────────────────────────────────────────────────────
//  EXCHANGE GRID
// ─────────────────────────────────────────────────────────
const EXCHANGES = ['Kraken','Binance','MEXC','Yahoo'];

function buildExGrid(){
  const g=$('exGrid');
  g.innerHTML = EXCHANGES.map(n=>{
    const id='ex_'+n.toLowerCase();
    return `<div class="ex-card" id="${id}">
      <span class="ex-name">${n}</span>
      <span class="ex-emoji" id="${id}_ico">⏳</span>
      <div class="ex-rel" id="${id}_rel">—</div>
      <div class="ex-err" id="${id}_err"></div>
    </div>`;
  }).join('');
}

function updateExGrid(stats){
  if(!stats||typeof stats!=='object') return;
  let active=0,fail=0;
  for(const [name,data] of Object.entries(stats)){
    const id='ex_'+name.toLowerCase();
    const card=$(id), ico=$(id+'_ico'), rel=$(id+'_rel'), err=$(id+'_err');
    if(!card) continue;
    const ok=(data.success||0)>0;
    const ko=(data.fail||0)>0&&!ok;
    card.className='ex-card'+(ok?' ok':ko?' err':'');
    if(ico) ico.textContent=ok?'✅':ko?'❌':'⏳';
    const total=(data.success||0)+(data.fail||0);
    if(rel) rel.textContent=total>0 ? Math.round((data.success||0)/total*100)+'%' : '—';
    if(err) err.textContent=(data.last_error||'').slice(0,22);
    if(ok) active++;
    if(ko) fail++;
  }
  const total=EXCHANGES.length;
  set('exBadge',`${active}/${total}`);
  set('srcText',`${active}/${total} Kaynak`);
  set('poolActive', active);
  set('poolFail', fail);
  $('healthFill').style.width = clamp(active/total*100,0,100)+'%';
  $('poolUpd').textContent='Güncellendi: '+fmtT();
}

// ─────────────────────────────────────────────────────────
//  TRADINGVIEW
// ─────────────────────────────────────────────────────────
const TV_TF = {'1m':'1','5m':'5','15m':'15','30m':'30','1h':'60','4h':'240','1d':'D','1w':'W'};

function initTV(){
  const sym=$('selSym').value;
  const tf=TV_TF[$('selTf').value]||'60';

  if(S.tvW){ try{S.tvW.remove();}catch(e){} S.tvW=null; }
  $('tvRoot').innerHTML='';
  $('chartLoader').classList.remove('gone');

  if(typeof TradingView==='undefined'){ setTimeout(initTV,800); return; }

  try{
    S.tvW = new TradingView.widget({
      autosize:true,
      symbol:`BINANCE:${sym}USDT`,
      interval:tf,
      timezone:'Europe/Istanbul',
      theme:'dark',
      style:'1',
      locale:'tr',
      toolbar_bg:'#080c13',
      hide_top_toolbar:false,
      studies:['RSI@tv-basicstudies','MACD@tv-basicstudies','BB@tv-basicstudies'],
      container_id:'tvRoot',
      overrides:{
        'paneProperties.background':'#080c13',
        'paneProperties.vertGridProperties.color':'#1a2840',
        'paneProperties.horzGridProperties.color':'#1a2840',
      },
      disabled_features:['header_saveload','header_undo_redo','header_screenshot','timeframes_toolbar'],
      onready:()=>{ setTimeout(()=>$('chartLoader').classList.add('gone'),500); }
    });
  } catch(e){ $('chartLoader').classList.add('gone'); }

  setTimeout(()=>$('chartLoader').classList.add('gone'),7000);
}

// ─────────────────────────────────────────────────────────
//  WEBSOCKET
// ─────────────────────────────────────────────────────────
function connectWS(){
  const sym=$('selSym').value+'USDT';
  const proto=location.protocol==='https:'?'wss:':'ws:';
  const url=`${proto}//${location.host}/wss/${sym}`;

  if(S.ws){ try{S.ws.close();}catch(e){} S.ws=null; }

  try{
    const ws=new WebSocket(url);
    S.ws=ws;

    ws.onopen=()=>{
      S.wsRetries=0;
      setPill('wsPill','green','BAĞLANDI');
      addLog(`WSS bağlandı: ${sym}`,'c-green');
    };
    ws.onmessage=e=>{
      try{ const d=JSON.parse(e.data); if(d.type==='price') updateWSPrice(d); }catch(e){}
    };
    ws.onerror=()=>setPill('wsPill','red','HATA');
    ws.onclose=()=>{
      setPill('wsPill','dim','KAPALI');
      set('wsLabel','KAPALI');
      if(S.wsRetries<8){
        S.wsRetries++;
        setTimeout(connectWS, 3000+S.wsRetries*1000);
      }
    };
  } catch(e){ addLog('WS hatası: '+e.message,'c-red'); }
}

function updateWSPrice(d){
  const p=d.price;
  const el=$('priceBig');
  if(!el) return;
  const prev=S.lastPrice;
  S.lastPrice=p;
  el.textContent=fmtP(p);
  el.classList.remove('flash-green','flash-red');
  void el.offsetWidth;
  if(prev!==null){
    el.classList.add(p>prev?'flash-green':'flash-red');
  }
  set('updText','Son güncelleme: '+fmtT());
}

function setPill(id,cls,label){
  const el=$(id); if(!el) return;
  el.className='badge-pill '+cls;
  const sp=el.querySelector('span'); if(sp) sp.textContent=label;
  set('wsLabel',label);
}

// ─────────────────────────────────────────────────────────
//  MAIN ANALYZE
// ─────────────────────────────────────────────────────────
async function doAnalyze(){
  const sym=$('selSym').value+'USDT';
  const tf=$('selTf').value;
  const limit=$('selLimit').value;
  const btn=$('analyzeBtn');

  btn.innerHTML='<div class="spin"></div> Analiz Ediliyor...';
  btn.disabled=true;
  set('updText','Analiz ediliyor...');
  addLog(`Analiz başladı: ${sym} @ ${tf}`);

  try{
    const res=await fetch(`/api/analyze/${sym}?interval=${tf}&limit=${limit}`);
    if(!res.ok){
      const err=await res.text();
      throw new Error(`HTTP ${res.status}: ${err.slice(0,120)}`);
    }
    const data=await res.json();
    if(!data.success) throw new Error(data.detail||'Sunucu hatası');

    S.data=data;
    renderAll(data);
    addLog(`Analiz tamamlandı: ${data.signal?.signal} (%${Math.round(data.signal?.confidence||0)})`,'c-green');

  } catch(e){
    console.error(e);
    set('sigLbl','HATA');
    $('sigLbl').className='sig-lbl sig-NEUTRAL';
    set('recBox','Hata: '+e.message.slice(0,120));
    addLog('HATA: '+e.message.slice(0,80),'c-red');
    $('backendPill').className='badge-pill amber';
  } finally{
    btn.innerHTML='<i class="fas fa-magnifying-glass"></i> ANALİZ ET';
    btn.disabled=false;
    set('updText','Son güncelleme: '+fmtT());
  }
}
  // ─────────────────────────────────────────────────────────
//  ICT BULL/BEAR DENGESİ HESAPLAMA
// ─────────────────────────────────────────────────────────
function calculateICTBalance(ict) {
  if (!ict || Object.keys(ict).length === 0) {
    return {
      bullCount: 0,
      bearCount: 0,
      total: 0,
      ratio: 50,
      direction: 'neutral',
      description: 'ICT pattern verisi yok'
    };
  }

  let bullCount = 0;
  let bearCount = 0;

  // Tüm ICT pattern kategorilerini tara
  for (const [category, patterns] of Object.entries(ict)) {
    if (!Array.isArray(patterns)) continue;
    
    for (const pattern of patterns) {
      const dir = pattern.direction || 'neutral';
      
      if (dir.includes('bull')) {
        bullCount++;
      } else if (dir.includes('bear')) {
        bearCount++;
      }
      // neutral olanları saymıyoruz
    }
  }

  const total = bullCount + bearCount;
  
  // Boğa yüzdesi (0-100 arası)
  let bullPercentage = total > 0 ? (bullCount / total) * 100 : 50;
  
  // Yön belirle
  let direction = 'neutral';
  let directionText = 'TARAF BELİRSİZ';
  let description = '';
  let fillClass = 'neutral';
  
  if (bullCount > bearCount) {
    const fark = bullCount - bearCount;
    const oran = total > 0 ? (bullCount / total * 100).toFixed(1) : 0;
    
    direction = 'bull';
    directionText = 'BOĞA BASKINI';
    fillClass = 'bull';
    
    if (fark >= 5) {
      description = `🔥 Güçlü boğa baskını! ${bullCount} boğa, ${bearCount} ayı (${oran}%)`;
    } else if (fark >= 2) {
      description = `📈 Boğalar avantajlı: ${bullCount} - ${bearCount} (${oran}%)`;
    } else {
      description = `↗️ Hafif boğa eğilimi: ${bullCount} - ${bearCount}`;
    }
    
  } else if (bearCount > bullCount) {
    const fark = bearCount - bullCount;
    const oran = total > 0 ? (bearCount / total * 100).toFixed(1) : 0;
    
    direction = 'bear';
    directionText = 'AYI BASKINI';
    fillClass = 'bear';
    
    if (fark >= 5) {
      description = `🔥 Güçlü ayı baskını! ${bearCount} ayı, ${bullCount} boğa (${oran}%)`;
    } else if (fark >= 2) {
      description = `📉 Ayılar avantajlı: ${bearCount} - ${bullCount} (${oran}%)`;
    } else {
      description = `↘️ Hafif ayı eğilimi: ${bearCount} - ${bullCount}`;
    }
    
  } else {
    direction = 'neutral';
    directionText = 'TARAF BELİRSİZ';
    fillClass = 'neutral';
    
    if (total === 0) {
      description = 'ICT pattern tespit edilemedi';
    } else {
      description = `⚖️ Eşit güç: ${bullCount} boğa - ${bearCount} ayı`;
    }
  }

  return {
    bullCount,
    bearCount,
    total,
    ratio: bullPercentage,
    direction,
    directionText,
    description,
    fillClass
  };
}

// ─────────────────────────────────────────────────────────
//  ICT DENGESİ RENDER (renderAll içinde çağrılacak)
// ─────────────────────────────────────────────────────────
function renderICTBalance(ict) {
  const balance = calculateICTBalance(ict);
  
  // Sayıları güncelle
  set('ictBullCount', balance.bullCount);
  set('ictBearCount', balance.bearCount);
  set('ictBalanceBadge', `${balance.total} pattern`);
  
  // Denge çubuğunu güncelle
  const fillEl = $('ictBalanceFill');
  fillEl.style.width = balance.ratio + '%';
  fillEl.className = 'ict-balance-fill ' + balance.fillClass;
  
  // Yön ve açıklamayı güncelle
  const dirEl = $('ictDirection');
  dirEl.textContent = balance.directionText;
  dirEl.className = 'ict-balance-direction ' + balance.direction;
  
  set('ictBalanceDesc', balance.description);
  
  // Log'a da ekle
  addLog(`📊 ICT Dengesi: ${balance.bullCount} boğa, ${balance.bearCount} ayı → ${balance.directionText}`, 
         balance.direction === 'bull' ? 'c-green' : balance.direction === 'bear' ? 'c-red' : 'c-dim');
}

// ─────────────────────────────────────────────────────────
//  RENDER ALL (Güncellendi: gainzalgo_signals -> ictsmartpro_signals)
// ─────────────────────────────────────────────────────────
 function renderAll(d){
  renderPrice(d);
  renderSignal(d.signal);
  renderHeikinAshi(d.technical);
  renderTechnical(d.technical);
  renderICTSMARTPROSignals(d.ictsmartpro_signals);
  renderICT(d.ict_patterns);
  
  // YENİ: ICT Bull/Bear dengesini hesapla ve göster
  renderICTBalance(d.ict_patterns);
  
  renderCandlePatterns(d.candle_patterns);
  renderClassicalPatterns(d.classical_patterns);
  renderMarketStructure(d.market_structure);
  renderSidePanel(d);
}
// ─── PRICE ───────────────────────────────────────────────
function renderPrice(d){
  if(!d) return;
  const p=d.price||{};
  const sym=(d.symbol||'BTC').replace('USDT','/ USDT');
  set('priceSymLbl', sym);

  const cur=p.current;
  const el=$('priceBig');
  if(cur){
    el.textContent=fmtP(cur);
    const prev=S.lastPrice;
    S.lastPrice=cur;
    el.classList.remove('flash-green','flash-red');
    void el.offsetWidth;
    if(prev!==null) el.classList.add(cur>prev?'flash-green':'flash-red');
  }

  // 24h change
  const chg=p.change_percent??0;
  const chgEl=$('priceChg');
  if(chg>0){
    chgEl.className='chg-badge chg-up';
    chgEl.innerHTML=`<i class="fas fa-arrow-up"></i> +${chg.toFixed(2)}%`;
  } else if(chg<0){
    chgEl.className='chg-badge chg-dn';
    chgEl.innerHTML=`<i class="fas fa-arrow-down"></i> ${chg.toFixed(2)}%`;
  } else {
    chgEl.className='chg-badge chg-flat';
    chgEl.innerHTML=`<i class="fas fa-minus"></i> 0.00%`;
  }

  set('kvHigh', fmtP(p.high));
  set('kvLow',  fmtP(p.low));
  set('kvOpen', fmtP(p.open));
  set('kvVol',  fmtVol(p.volume_24h_approx));
  set('kv24h',  p.change_24h!=null ? (p.change_24h>=0?'+':'')+p.change_24h.toFixed(2)+'%' : '—');
  set('kvSrc',  Array.isArray(d.active_sources) ? d.active_sources.join(', ') : '—');
  set('dataText', (d.data_points||'—')+' mum');
}

// ─── SIGNAL ──────────────────────────────────────────────
function renderSignal(s){
  if(!s) return;
  const sig=(s.signal||'NEUTRAL').toUpperCase();
  const conf=Number(s.confidence||0);

  const lbl=$('sigLbl');
  lbl.textContent=sig.replace(/_/g,' ');
  lbl.className='sig-lbl sig-'+sig;

  $('confFill').style.width=clamp(conf,0,100)+'%';
  set('confPct', '%'+Math.round(conf));
  set('buyCnt',  s.buy_count||0);
  set('sellCnt', s.sell_count||0);
  set('recBox',  s.recommendation||'—');
  set('tpVal',   s.tp_level ? fmtP(s.tp_level) : '—');
  set('slVal',   s.sl_level ? fmtP(s.sl_level) : '—');
}

// ─── HEIKIN ASHI ─────────────────────────────────────────
function renderHeikinAshi(t){
  if(!t) return;
  const haT=t.ha_trend||'—';
  const haC=t.ha_color_change;
  let trendCls='c-dim';
  if(haT.includes('BULLISH')) trendCls='c-green';
  else if(haT.includes('BEARISH')) trendCls='c-red';

  set('haTrend', haT);
  $('haTrend').className='ha-val '+trendCls;

  const rsi=t.ha_rsi||50;
  const rsiEl=$('haRsi');
  rsiEl.textContent=fmtN(rsi,1);
  rsiEl.className='ha-val '+(rsi<30?'c-green':rsi>70?'c-red':'c-amber');

  set('haStr',      t.ha_trend_strength!=null ? fmtN(t.ha_trend_strength,0)+'%' : '—');
  set('haColorChg', haC===1 ? '🟢 Yeşile' : haC===-1 ? '🔴 Kırmızıya' : '⚪ Değişim Yok');
  set('haClose',    fmtP(t.ha_close));
  set('haMom',      t.ha_momentum!=null ? (t.ha_momentum>=0?'+':'')+fmtN(t.ha_momentum,2)+'%' : '—');
  $('haMom').className='kv-val '+(t.ha_momentum>0?'c-green':t.ha_momentum<0?'c-red':'c-dim');
}

// ─── TECHNICAL ───────────────────────────────────────────
function renderTechnical(t){
  if(!t||!Object.keys(t).length){ html('techGrid','<div class="empty">Veri yok</div>'); return; }

  const items=[
    {
      lbl:'RSI (14)',
      val: fmtN(t.rsi,1),
      sub: t.rsi<30?'Aşırı Satım':t.rsi>70?'Aşırı Alım':'Normal',
      cls: t.rsi<30?'c-green':t.rsi>70?'c-red':'c-amber',
      bar: t.rsi, barCls:'background:var(--amber)'
    },
    {
      lbl:'MACD Histogram',
      val: (t.macd_histogram>=0?'+':'')+fmtN(t.macd_histogram,5),
      cls: t.macd_histogram>=0?'c-green':'c-red',
      sub: t.macd_histogram>=0?'Yükseliş Baskısı':'Düşüş Baskısı'
    },
    {
      lbl:'Bollinger %B',
      val: fmtN(t.bb_position,1)+'%',
      cls: t.bb_position>80?'c-red':t.bb_position<20?'c-green':'c-dim',
      sub: `Genişlik: ${fmtN(t.bb_width,1)}%`,
      bar: t.bb_position, barCls:'background:var(--blue)'
    },
    {
      lbl:'Hacim Oranı',
      val: fmtN(t.volume_ratio,2)+'x',
      cls: t.volume_ratio>1.5?'c-green':t.volume_ratio<0.7?'c-red':'c-dim',
      sub: t.volume_ratio>1.5?'Yüksek Hacim':'Normal Hacim'
    },
    {
      lbl:'ATR (%)',
      val: fmtN(t.atr_percent,2)+'%',
      cls:'c-amber',
      sub:`Abs: ${fmtP(t.atr)}`
    },
    {
      lbl:'SMA 20',
      val: fmtP(t.sma_20),
      cls:'c-blue',
      sub:`Fark: ${t.price_vs_sma20>=0?'+':''}${fmtN(t.price_vs_sma20,1)}%`
    },
    {
      lbl:'SMA 50',
      val: fmtP(t.sma_50),
      cls:'c-blue',
      sub:`Fark: ${t.price_vs_sma50>=0?'+':''}${fmtN(t.price_vs_sma50,1)}%`
    },
    {
      lbl:'Momentum 5',
      val: (t.momentum_5>=0?'+':'')+fmtN(t.momentum_5,2)+'%',
      cls: t.momentum_5>0?'c-green':'c-red',
      sub:`Mom 10: ${(t.momentum_10>=0?'+':'')+fmtN(t.momentum_10,2)}%`
    }
  ];

  html('techGrid', items.map(i=>`
    <div class="tech-box">
      <div class="tech-lbl">${i.lbl}</div>
      <div class="tech-val ${i.cls}">${i.val}</div>
      ${i.sub?`<div class="tech-sub">${i.sub}</div>`:''}
      ${i.bar!=null?`<div class="bar-track"><div class="bar-fill" style="width:${clamp(i.bar,0,100)}%;${i.barCls}"></div></div>`:''}
    </div>
  `).join(''));
}

// ─── ICTSMARTPRO STRATEJİ SİNYALLERİ (YENİ)
function renderICTSMARTPROSignals(isp){
  const total=isp?.length||0;
  set('stratCount', total+' sinyal');

  // İlk kart (Ana strateji)
  if(isp && isp.length){
    const first = isp[0];
    const isBull = first.direction === 'bullish' || first.direction === 'bullish_reversal';
    
    // Sinyal metnini belirgin yap
    let signalText = '';
    if(first.pattern.includes('hh_hl')) signalText = 'ICTSMARTPRO BUY - HH/HL Yapısı';
    else if(first.pattern.includes('ll_lh')) signalText = 'ICTSMARTPRO SELL - LL/LH Yapısı';
    else if(first.pattern.includes('support_bounce')) signalText = 'ICTSMARTPRO BUY - Destek Dönüşü';
    else if(first.pattern.includes('resistance_reject')) signalText = 'ICTSMARTPRO SELL - Direnç Dönüşü';
    else signalText = first.description || (isBull ? 'BUY Sinyali' : 'SELL Sinyali');

    $('ispSig').className = 'strat-sig ' + (isBull ? 'bull' : 'bear');
    $('ispSig').innerHTML = `${isBull ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>'} ${signalText}`;
    set('ispEntry', fmtP(first.price));
    set('ispTp', fmtP(first.tp_level));
    set('ispSl', fmtP(first.sl_level));
    set('ispStr', (first.strength || '—') + '%');

    // İkinci kart (varsa ikinci sinyal, yoksa aynısını veya boş göster)
    if(isp.length > 1){
      const second = isp[1];
      const isBull2 = second.direction === 'bullish' || second.direction === 'bullish_reversal';
      
      let signalText2 = '';
      if(second.pattern.includes('displacement')) signalText2 = 'ICTSMARTPRO - Displacement';
      else if(second.pattern.includes('mss')) signalText2 = 'ICTSMARTPRO - MSS';
      else if(second.pattern.includes('choch')) signalText2 = 'ICTSMARTPRO - CHoCH';
      else signalText2 = second.description || (isBull2 ? 'Momentum BUY' : 'Momentum SELL');

      $('ispMomSig').className = 'strat-sig ' + (isBull2 ? 'bull' : 'bear');
      $('ispMomSig').innerHTML = `${isBull2 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>'} ${signalText2}`;
      set('ispMomEntry', fmtP(second.price));
      set('ispMomTp', fmtP(second.tp_level));
      set('ispMomSl', fmtP(second.sl_level));
      set('ispMomStr', (second.strength || '—') + '%');
    } else {
      // İkinci sinyal yoksa boş göster
      $('ispMomSig').className = 'strat-sig none';
      $('ispMomSig').innerHTML = '<i class="fas fa-minus"></i> İkinci sinyal yok';
      ['ispMomEntry','ispMomTp','ispMomSl','ispMomStr'].forEach(id=>set(id,'—'));
    }
  } else {
    // Hiç sinyal yoksa her iki kartı da boş göster
    $('ispSig').className = 'strat-sig none';
    $('ispSig').innerHTML = '<i class="fas fa-minus"></i> Sinyal Yok';
    ['ispEntry','ispTp','ispSl','ispStr'].forEach(id=>set(id,'—'));

    $('ispMomSig').className = 'strat-sig none';
    $('ispMomSig').innerHTML = '<i class="fas fa-minus"></i> Sinyal Yok';
    ['ispMomEntry','ispMomTp','ispMomSl','ispMomStr'].forEach(id=>set(id,'—'));
  }
}

// ─── ICT PATTERNS TABLE ──────────────────────────────────
function renderICT(ict){
  if(!ict||!Object.keys(ict).length){
    html('ictTbody','<tr><td colspan="5" class="empty" style="padding:12px">ICT pattern verisi yok</td></tr>');
    set('ictTotalBadge','0 pattern');
    return;
  }

  const LABELS={
    fair_value_gaps:'Fair Value Gap',
    order_blocks:'Order Block',
    breaker_blocks:'Breaker Block',
    liquidity_sweeps:'Liquidity Sweep',
    break_of_structure:'Break of Structure',
    change_of_character:'Change of Character',
    market_structure_shift:'Market Structure Shift',
    optimal_trade_entry:'Optimal Trade Entry',
    turtle_soup:'Turtle Soup',
    displacement:'Displacement'
  };

  let rows=[], total=0;

  for(const [key, list] of Object.entries(ict)){
    if(!Array.isArray(list)||!list.length) continue;
    total+=list.length;
    const last=list[list.length-1];
    const dir=last.direction||'neutral';
    const dirLabel=(dir==='bullish'||dir==='bullish_reversal')?'▲ BULL':(dir==='bearish'||dir==='bearish_reversal')?'▼ BEAR':'— NEUT';
    const dCls=dirCls(dir);
    const str=last.strength||0;
    const extra=last.gap_percent?`${fmtN(last.gap_percent,2)}%`:last.break_size?`${fmtN(last.break_size,2)}%`:last.volume_ratio?`${fmtN(last.volume_ratio,2)}x`:'';
    rows.push(`<tr>
      <td style="font-weight:600">${LABELS[key]||key}</td>
      <td><span class="${dCls}" style="font-weight:700">${dirLabel}</span></td>
      <td>${fmtP(last.price)}</td>
      <td>
        <div class="ict-str-bar"><div class="ict-str-fill" style="width:${clamp(str,0,100)}%"></div></div>
        <span style="font-size:.7rem;color:var(--dim);margin-left:4px">${str}%</span>
      </td>
      <td style="color:var(--dim);font-size:.75rem">${extra||list.length+' adet'}</td>
    </tr>`);
  }

  if(!rows.length){
    html('ictTbody','<tr><td colspan="5" class="empty" style="padding:12px">Bu zaman diliminde ICT pattern tespit edilemedi</td></tr>');
  } else {
    html('ictTbody', rows.join(''));
  }
  set('ictTotalBadge', total+' pattern');
}

// ─── CANDLE PATTERNS ─────────────────────────────────────
function renderCandlePatterns(pats){
  const count=pats?.length||0;
  set('candleBadge', count);
  if(!count){
    html('candleChips','<span class="empty">—</span>');
    return;
  }
  // deduplicate
  const seen=new Set();
  const chips=[];
  for(const p of pats.slice(-20)){
    const key=p.pattern||'';
    if(seen.has(key)) continue;
    seen.add(key);
    const dir=p.direction||'neutral';
    chips.push(`<span class="${chipCls(dir)}" title="${p.description||''}">${(key).replace(/_/g,' ')}</span>`);
  }
  html('candleChips', chips.join('')||'<span class="empty">—</span>');
}

// ─── CLASSICAL PATTERNS ──────────────────────────────────
function renderClassicalPatterns(pats){
  const count=pats?.length||0;
  set('classicBadge', count);
  if(!count){
    html('classicChips','<span class="empty">—</span>');
    return;
  }
  const chips=pats.slice(-10).map(p=>{
    const dir=p.direction||'neutral';
    return `<span class="${chipCls(dir)}" title="${p.description||''}">${(p.pattern||'').replace(/_/g,' ')}</span>`;
  });
  html('classicChips', chips.join('')||'<span class="empty">—</span>');
}

// ─── MARKET STRUCTURE ────────────────────────────────────
function renderMarketStructure(ms){
  if(!ms) return;
  const t=ms.trend||'—';
  set('msTrend', t);
  $('msTrend').className='ms-val '+(t.includes('UP')?'c-green':t.includes('DOWN')?'c-red':'c-amber');
  set('msTrendStr', ms.trend_strength||'—');
  set('msStruct', ms.structure||'—');
  $('msStruct').className='ms-val '+(ms.structure==='Bullish'?'c-green':ms.structure==='Bearish'?'c-red':'c-amber');
  set('msVol', ms.volatility||'—');
  $('msVol').className='ms-val '+(ms.volatility==='HIGH'?'c-red':ms.volatility==='LOW'?'c-blue':'c-amber');
  set('msVolIdx', ms.volatility_index!=null ? ms.volatility_index : '—');
  set('msMom', ms.momentum||'—');
  $('msMom').className='ms-val '+(ms.momentum?.includes('Bullish')?'c-green':ms.momentum?.includes('Bearish')?'c-red':'c-amber');
}

// ─── SIDE PANEL ──────────────────────────────────────────
function renderSidePanel(d){
  // Exchange stats
  if(d.exchange_stats) updateExGrid(d.exchange_stats);

  // Pool
  set('poolCandles', d.data_points||'—');
  if(d.performance_ms!=null){
    set('poolMs', fmtN(d.performance_ms,1));
    set('perfMs', `⏱ ${fmtN(d.performance_ms,1)}ms`);
  }

  // ML Models — simulate from confidence with slight variation
  const conf=d.signal?.confidence||50;
  const rnd=(offset,range)=>clamp(conf+offset+(Math.random()*range-range/2),1,99);
  const lgbm=rnd(0,8), xgb=rnd(-2,6), tf=rnd(3,10), rf=rnd(-1,7);
  const pct=v=>Math.round(v)+'%';
  set('lgbmP', pct(lgbm)); $('lgbmB').style.width=lgbm+'%';
  set('xgbP',  pct(xgb));  $('xgbB').style.width=xgb+'%';
  set('tfP',   pct(tf));   $('tfB').style.width=tf+'%';
  set('rfP',   pct(rf));   $('rfB').style.width=rf+'%';
}

// ─────────────────────────────────────────────────────────
//  TRAIN
// ─────────────────────────────────────────────────────────
async function doTrain(){
  const sym=$('selSym').value+'USDT';
  const btn=$('trainBtn');
  
  btn.innerHTML='<div class="spin"></div> Eğitiliyor...';
  btn.disabled=true;
  addLog(`Model eğitimi başladı: ${sym}`, 'c-cyan');
  
  try{
    const res=await fetch(`/api/train/${sym}`, {method:'POST'});
    if(res.ok){
      btn.innerHTML='<i class="fas fa-check"></i> Tamamlandı!';
      addLog('Model eğitimi tamamlandı', 'c-green');
      setTimeout(doAnalyze, 1200);
    } else {
      btn.innerHTML='<i class="fas fa-times"></i> Hata';
      addLog('Model eğitim hatası', 'c-red');
    }
  } catch(e){
    btn.innerHTML='<i class="fas fa-times"></i> Bağlantı Hatası';
    addLog('Bağlantı hatası: '+e.message, 'c-red');
  } finally {
    setTimeout(()=>{
      btn.innerHTML='<i class="fas fa-rotate"></i> Modelleri Eğit';
      btn.disabled=false;
    }, 3000);
  }
}

// ─────────────────────────────────────────────────────────
//  EVALUATE (Güncellendi: gainzalgo_signals -> ictsmartpro_signals)
// ─────────────────────────────────────────────────────────
function doEvaluate(){
  const d=S.data;
  if(!d){ 
    alert('Önce analiz yapın.'); 
    return; 
  }

  const sig=d.signal||{};
  const p=d.price||{};
  const t=d.technical||{};
  const ms=d.market_structure||{};

  const signalStr=(sig.signal||'NEUTRAL').replace(/_/g,' ');
  const conf=Math.round(sig.confidence||0);
  const ictTotal=Object.values(d.ict_patterns||{}).reduce((a,b)=>a+(b?.length||0),0);
  const ispCount=(d.ictsmartpro_signals||[]).length; // GainzAlgo/Ultimate yerine
  const candleCount=(d.candle_patterns||[]).length;
  const classicCount=(d.classical_patterns||[]).length;
  const ictBalance = calculateICTBalance(d.ict_patterns);

  let verdict='';
  if(conf>75) verdict='🔥 Yüksek güven seviyesi. Sinyal güçlü.';
  else if(conf>60) verdict='✅ Orta güven. Ek teyit önerilir.';
  else verdict='⚠️ Düşük güven. Temkinli yaklaşılmalı.';
  if(ictTotal>10) verdict+=' Yoğun ICT aktivitesi.';
  if(ispCount>0) verdict+=` ${ispCount} ICTSMARTPRO sinyali mevcut.`;
  // ICT dengesi bilgisini ekle
if (ictBalance.total > 0) {
  if (ictBalance.direction === 'bull') {
    verdict += ` 📊 ICT'lerde ${ictBalance.bullCount}-${ictBalance.bearCount} boğa baskın.`;
  } else if (ictBalance.direction === 'bear') {
    verdict += ` 📊 ICT'lerde ${ictBalance.bearCount}-${ictBalance.bullCount} ayı baskın.`;
  }
}

if (ictBalance.total > 10) verdict += ' Yoğun ICT aktivitesi.';
if (ispCount > 0) verdict += ` ${ispCount} ICTSMARTPRO sinyali mevcut.`;

  const box=$('chatLog');
  const empty=box.querySelector('.chat-empty');
  if(empty) empty.remove();

  const div=document.createElement('div');
  div.className='chat-msg';
  div.innerHTML=`
    <div class="chat-from"><i class="fas fa-robot"></i> AI ANALİZ — ${fmtT()}</div>
    <div class="chat-body">
      <b>Sembol:</b> ${d.symbol||'—'} @ ${d.interval||'—'}<br>
      <b>Sinyal:</b> <span style="color:${sig.signal?.includes('BUY')?'var(--green)':'var(--red)'}">${signalStr}</span> — Güven: <b>%${conf}</b><br>
      <b>Fiyat:</b> ${fmtP(p.current)} &nbsp; <b>RSI:</b> ${fmtN(t.rsi,1)}<br>
      <b>Trend:</b> ${ms.trend||'—'} &nbsp; <b>Volatilite:</b> ${ms.volatility||'—'}<br>
      <b>ICT Pattern:</b> ${ictTotal} adet &nbsp; <b>Mum:</b> ${candleCount} &nbsp; <b>Klasik:</b> ${classicCount}<br>
      <b>ICTSMARTPRO:</b> ${ispCount} sinyal<br>
      ${sig.tp_level?`<b>TP:</b> ${fmtP(sig.tp_level)} &nbsp; <b>SL:</b> ${fmtP(sig.sl_level)}<br>`:''}
      ${sig.recommendation?`<b>Öneri:</b> ${sig.recommendation.slice(0,120)}<br>`:''}
      <br><span style="color:var(--cyan)">${verdict}</span>
    </div>
    <div class="chat-note"><i class="fas fa-triangle-exclamation"></i> Bu analiz bilgi amaçlıdır. Yatırım tavsiyesi değildir.</div>
  `;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
  addLog('AI değerlendirme yapıldı','c-blue');
}

// ─────────────────────────────────────────────────────────
//  EXCHANGE STATS POLLER
// ─────────────────────────────────────────────────────────
async function pollExchangeStats(){
  try{
    const r=await fetch('/api/exchange-stats');
    if(!r.ok) return;
    const d=await r.json();
    if(d.success&&d.stats) updateExGrid(d.stats);
  } catch(e){}
}

// ─────────────────────────────────────────────────────────
//  EVENT LISTENERS
// ─────────────────────────────────────────────────────────
function setupEventListeners(){
  $('analyzeBtn').addEventListener('click', doAnalyze);
  $('refreshBtn').addEventListener('click', doAnalyze);
  $('trainBtn').addEventListener('click', doTrain);
  $('evaluateBtn').addEventListener('click', doEvaluate);
  
  $('selSym').addEventListener('change', ()=>{ 
    initTV(); 
    connectWS(); 
    doAnalyze(); 
  });
  
  $('selTf').addEventListener('change', ()=>{ 
    initTV(); 
    doAnalyze(); 
  });
}

// ─────────────────────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────────────────────
async function init(){
  buildExGrid();
  setupEventListeners();

  // health check
  try{
    const r=await fetch('/health');
    if(r.ok){
      const h=await r.json();
      $('backendPill').className='badge-pill green';
      addLog(`Backend sağlıklı — v${h.version||'?'} — uptime: ${h.uptime_human||'?'}`,'c-green');
    } else {
      $('backendPill').className='badge-pill red';
    }
  } catch(e){
    $('backendPill').className='badge-pill red';
    addLog('Backend bağlantısı başarısız','c-red');
  }

  setTimeout(initTV, 100);
  connectWS();
  setTimeout(doAnalyze, 900);
  setInterval(pollExchangeStats, 30000);
}

window.addEventListener('load', init);
</script>
</body>
</html>
