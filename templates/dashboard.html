// Global TradingView widget referansÄ±
let tradingViewWidget = null;
let currentSymbol = null;
let currentInterval = null;

// TradingView widget'Ä± yÃ¼kleme fonksiyonu - DÃœZELTÄ°LMÄ°Å
function loadTradingView() {
    const container = document.getElementById('tradingview-widget');
    if (!container) return;

    const selectedSymbol = document.getElementById('symbolSelect').value || 'BTCUSDT';
    const selectedInterval = document.getElementById('intervalSelect').value || '1h';

    // AynÄ± sembol ve interval ise tekrar yÃ¼kleme
    if (currentSymbol === selectedSymbol && currentInterval === selectedInterval && tradingViewWidget) {
        console.log('ğŸ“Š TradingView already loaded for this symbol/interval');
        return;
    }

    // Ã–nceki widget varsa temizle
    container.innerHTML = '';
    
    // Loading state gÃ¶ster
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner mb-3" style="width: 48px; height: 48px; border-width: 4px;"></div>
            <p class="text-secondary fs-5">Loading TradingView chart...</p>
            <p class="text-muted mt-2">Symbol: ${selectedSymbol.replace('USDT', '/USDT')}</p>
        </div>
    `;

    // TradingView'un beklediÄŸi formata Ã§evir - KRÄ°TÄ°K DÃœZELTME
    let tvInterval = '60';
    switch(selectedInterval) {
        case '1h': tvInterval = '60'; break;
        case '4h': tvInterval = '240'; break;
        case '1d': tvInterval = 'D'; break;
        case '1w': tvInterval = 'W'; break;
        default: tvInterval = '60';
    }

    console.log(`ğŸ“ˆ Loading TradingView: ${selectedSymbol}, Interval: ${tvInterval}`);

    // TradingView widget'Ä± oluÅŸtur
    try {
        tradingViewWidget = new TradingView.widget({
            "width": "100%",
            "height": "100%",
            "symbol": "BINANCE:" + selectedSymbol,
            "interval": tvInterval,
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "details": true,
            "container_id": "tradingview-widget",
            "library_path": "https://s3.tradingview.com/tvjs/latest/",
            "autosize": true
        });

        // Current state'i gÃ¼ncelle
        currentSymbol = selectedSymbol;
        currentInterval = selectedInterval;

        console.log('âœ… TradingView widget loaded successfully');
    } catch (error) {
        console.error('âŒ TradingView widget error:', error);
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-chart-line"></i>
                <p>TradingView chart could not be loaded</p>
                <p class="text-muted small mt-2">Please refresh the page</p>
            </div>
        `;
    }
}

// Sembol/interval deÄŸiÅŸtiÄŸinde veya sayfa yÃ¼klendiÄŸinde Ã§aÄŸrÄ±lan ana fonksiyon - GÃœNCELLENDÄ°
async function analyzeCurrentSymbol() {
    const symbol = document.getElementById('symbolSelect').value;
    const interval = document.getElementById('intervalSelect').value;

    // UI gÃ¼ncellemeleri
    document.getElementById('currentSymbol').textContent = symbol.replace('USDT', '/USDT');
    document.getElementById('currentPrice').innerHTML = '<span class="spinner"></span>';
    document.getElementById('signalText').textContent = 'ANALYZING';
    document.getElementById('signalBadge').className = 'signal-badge signal-neutral';

    try {
        // GerÃ§ek backend Ã§aÄŸrÄ±sÄ±
        const response = await fetch(`/api/analyze/${symbol}?interval=${interval}`);
        if (!response.ok) {
            throw new Error('API connection failed');
        }
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data);
            // TradingView'Ä± gÃ¼ncelle (sadece sembol/intervalse deÄŸiÅŸtiÄŸinde)
            loadTradingView();
        } else {
            showNotification('No real-time data available', 'info');
            // TradingView yine de yÃ¼klenmeli
            loadTradingView();
        }
    } catch (error) {
        // HATA YÃ–NETÄ°MÄ° Ä°YÄ°LEÅTÄ°RÄ°LMÄ°Å
        console.error('API connection error:', error);
        showNotification('âš ï¸ Veri alÄ±namadÄ±. Sunucuyla baÄŸlantÄ± sorunu var.', 'error');

        // UI'yi hata durumuna getir
        document.getElementById('currentPrice').textContent = 'â€”';
        document.getElementById('priceChange').textContent = 'BaÄŸlantÄ± hatasÄ±';
        document.getElementById('signalText').textContent = 'ERROR';
        document.getElementById('signalBadge').className = 'signal-badge signal-neutral';
        document.getElementById('signalRecommendation').textContent = 'LÃ¼tfen sayfayÄ± yenileyin veya daha sonra tekrar deneyin.';
        
        // TradingView yine de yÃ¼klenmeli
        loadTradingView();
    }
}

// Symbol veya interval deÄŸiÅŸtiÄŸinde sadece TradingView'Ä± yenile
function refreshTradingViewOnly() {
    // Current state'i sÄ±fÄ±rla ki yeniden yÃ¼klensin
    currentSymbol = null;
    currentInterval = null;
    loadTradingView();
}

// Event listeners - GÃœNCELLENDÄ°
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendChatMessage();
});

// Sembol deÄŸiÅŸtiÄŸinde hem analiz hem TradingView
document.getElementById('symbolSelect').addEventListener('change', analyzeCurrentSymbol);

// Sadece interval deÄŸiÅŸtiÄŸinde sadece TradingView yenilensin
document.getElementById('intervalSelect').addEventListener('change', refreshTradingViewOnly);

// Auto-refresh every 60 seconds - TradingView hariÃ§
setInterval(function() {
    // Sadece dashboard'Ä± yenile, TradingView'Ä± yenileme
    const symbol = document.getElementById('symbolSelect').value;
    const interval = document.getElementById('intervalSelect').value;
    
    fetch(`/api/analyze/${symbol}?interval=${interval}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboard(data);
            }
        })
        .catch(error => console.error('Auto-refresh error:', error));
}, 60000);
