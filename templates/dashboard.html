<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üöÄ ICTSMARTPRO v8.0 - 30+ BORSA ‚Ä¢ GER√áEK ZAMANLI</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- TradingView Widget (Y√úKLEME SIRASI √ñNEMLƒ∞!) -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        /* ========== ANA RENKLER ========== */
        :root {
            --bg-deep: #0a0c14;
            --bg-dark: #11131f;
            --bg-card: #1a1d2b;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --text-bright: #ffffff;
            --text-dim: #94a3b8;
            --border-glow: rgba(59, 130, 246, 0.3);
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-glow: 0 0 30px rgba(59, 130, 246, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-deep);
            color: var(--text-bright);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* ========== NAVBAR ========== */
        .navbar {
            background: rgba(17, 19, 31, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--accent-primary);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff, var(--accent-primary), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-badge {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
            padding: 0.4rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .ws-badge {
            padding: 0.4rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .ws-connected {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
        }
        
        .ws-disconnected {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
        }

        /* ========== CARDS ========== */
        .card {
            background: rgba(26, 29, 43, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-glow);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .card-header {
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding: 1rem 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        /* ========== CHART ========== */
        .chart-wrapper {
            background: var(--bg-dark);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            height: 600px;
            min-height: 600px;
            position: relative;
        }

        #tradingview-widget {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-sm);
        }

        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            z-index: 10;
            border-radius: var(--radius-sm);
            gap: 1rem;
        }

        /* ========== Fƒ∞YAT ========== */
        .price-large {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .price-change {
            font-size: 1.3rem;
            font-weight: 700;
            padding: 0.4rem 1.2rem;
            border-radius: 30px;
            display: inline-block;
        }

        .price-up {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }

        .price-down {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }

        /* ========== Sƒ∞NYAL BADGE ========== */
        .signal-badge {
            padding: 1.5rem 1rem;
            border-radius: 40px;
            font-size: 1.8rem;
            font-weight: 800;
            border: 2px solid transparent;
            margin-bottom: 1rem;
        }

        .signal-STRONG_BUY { background: linear-gradient(135deg, #10b981, #059669); }
        .signal-BUY { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .signal-NEUTRAL { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .signal-SELL { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .signal-STRONG_SELL { background: linear-gradient(135deg, #dc2626, #b91c1c); }

        /* ========== EXCHANGE GRID ========== */
        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .exchange-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-sm);
            padding: 0.6rem 0.3rem;
            text-align: center;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .exchange-item.success {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .exchange-item.fail {
            border-color: var(--accent-danger);
            opacity: 0.6;
        }

        .exchange-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* ========== ƒ∞LERLEME √áUBUKLARI ========== */
        .progress {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            height: 8px;
            margin: 0.5rem 0;
        }

        .progress-bar {
            border-radius: 30px;
            transition: width 0.5s ease;
        }

        /* ========== MOBƒ∞L ========== */
        @media (max-width: 768px) {
            .price-large { font-size: 2.2rem; }
            .chart-wrapper { height: 400px; min-height: 400px; }
            .signal-badge { font-size: 1.2rem; padding: 1rem; }
        }

        /* ========== ANƒ∞MASYONLAR ========== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-pulse {
            animation: pulse 1.5s infinite;
        }

        .price-flash {
            animation: flash 0.3s ease;
        }

        @keyframes flash {
            0% { text-shadow: 0 0 0 var(--accent-primary); }
            50% { text-shadow: 0 0 30px var(--accent-primary); }
            100% { text-shadow: 0 0 0 var(--accent-primary); }
        }
    </style>
</head>
<body>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <a class="navbar-brand">
                <i class="fas fa-robot me-2" style="color: var(--accent-primary);"></i>
                ICTSMARTPRO v8.0
            </a>
            <span class="connection-badge" id="backendStatus">
                <i class="fas fa-circle me-2" style="color: var(--accent-success); font-size: 0.6rem;"></i>
                BAƒûLANDI
            </span>
            <span class="ws-badge ms-2" id="wsStatus">
                <i class="fas fa-wifi me-1"></i>
                <span id="wsStatusText">WS</span>
            </span>
        </div>
    </div>
</nav>

<div class="container-fluid px-4 py-3">
    <div class="row g-4">
        
        <!-- ========== SOL KOLON (ANA ƒ∞√áERƒ∞K) ========== -->
        <div class="col-lg-8">
            
            <!-- Kontrol Paneli -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sliders-h me-2"></i>
                    ANALƒ∞Z KONTROL√ú
                    <span class="badge bg-primary ms-2" id="sourceCount">0/32</span>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <select id="symbolSelect" class="form-select" style="width: 150px; background: var(--bg-dark); color: white; border: 1px solid var(--accent-primary);">
                            <option value="BTC">BTC/USDT</option>
                            <option value="ETH">ETH/USDT</option>
                            <option value="SOL">SOL/USDT</option>
                            <option value="BNB">BNB/USDT</option>
                            <option value="XRP">XRP/USDT</option>
                            <option value="ADA">ADA/USDT</option>
                        </select>
                        
                        <select id="intervalSelect" class="form-select" style="width: 130px; background: var(--bg-dark); color: white; border: 1px solid var(--accent-primary);">
                            <option value="1m">1 Dakika</option>
                            <option value="5m">5 Dakika</option>
                            <option value="15m">15 Dakika</option>
                            <option value="30m">30 Dakika</option>
                            <option value="1h" selected>1 Saat</option>
                            <option value="4h">4 Saat</option>
                            <option value="1d">1 G√ºn</option>
                            <option value="1w">1 Hafta</option>
                        </select>
                        
                        <button class="btn btn-primary" onclick="analyzeSymbol()" style="background: var(--accent-primary); border: none; padding: 0.6rem 2rem; border-radius: 30px;">
                            <i class="fas fa-search me-2"></i>
                            ANALƒ∞Z ET
                        </button>
                        
                        <span class="ms-auto text-muted small" id="lastUpdate">
                            <i class="fas fa-clock me-1"></i> G√ºncelleniyor...
                        </span>
                    </div>
                </div>
            </div>

            <!-- Fiyat ve ML Sinyali -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-dollar-sign me-2"></i>
                            CANLI Fƒ∞YAT
                        </div>
                        <div class="card-body text-center">
                            <div class="text-muted small mb-2" id="currentSymbol">BTC/USDT</div>
                            <div class="price-large" id="currentPrice">$0.00</div>
                            <div class="mt-3" id="priceChange"></div>
                            <div class="row mt-4">
                                <div class="col-6">
                                    <div class="text-muted small">24s Hacim</div>
                                    <div class="fw-bold" id="volume24h">‚Äî</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted small">Kaynak</div>
                                    <div class="fw-bold" id="priceSourceCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="fas fa-brain me-2"></i>
                            ML Sƒ∞NYALƒ∞
                        </div>
                        <div class="card-body">
                            <div class="signal-badge text-center mb-3" id="signalBadge">
                                <span id="signalText">ANALƒ∞Z BEKLENƒ∞YOR</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-primary" id="confidenceBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mb-2 fw-bold" id="confidenceText">%0</div>
                            <div class="small text-muted" id="recommendation">‚Äî</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TradingView Chart -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line me-2"></i>
                    CANLI GRAFƒ∞K
                    <span class="badge bg-success ms-2" id="chartStatus">TradingView</span>
                </div>
                <div class="card-body p-0">
                    <div class="chart-wrapper" id="chartContainer">
                        <div id="tradingview-widget"></div>
                        <div class="chart-loading" id="chartLoading" style="display: none;">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <p>Grafik y√ºkleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heikin Ashi ve Teknik G√∂stergeler -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-simple me-2"></i>
                            HEIKIN ASHI
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="p-2" style="background: rgba(0,0,0,0.3); border-radius: 12px;">
                                        <div class="text-muted small">Trend</div>
                                        <div class="fw-bold fs-5" id="haTrend">‚Äî</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2" style="background: rgba(0,0,0,0.3); border-radius: 12px;">
                                        <div class="text-muted small">RSI</div>
                                        <div class="fw-bold fs-5" id="haRsi">‚Äî</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2" style="background: rgba(0,0,0,0.3); border-radius: 12px;">
                                        <div class="text-muted small">G√º√ß</div>
                                        <div class="fw-bold fs-5" id="haStrength">‚Äî</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2" style="background: rgba(0,0,0,0.3); border-radius: 12px;">
                                        <div class="text-muted small">Renk</div>
                                        <div class="fw-bold fs-5" id="haColor">‚ö™</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-flask me-2"></i>
                            TEKNƒ∞K G√ñSTERGELER
                        </div>
                        <div class="card-body">
                            <div id="technicalIndicators">
                                <div class="text-center py-3 loading-pulse">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Bekleniyor...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern ve Market Yapƒ±sƒ± -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-shapes me-2"></i>
                            PATERNLER
                        </div>
                        <div class="card-body">
                            <div id="patterns" class="d-flex flex-wrap gap-2">
                                <span class="text-muted">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-water me-2"></i>
                            MARKET YAPISI
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Trend:</span>
                                <span class="fw-bold" id="trend">‚Äî</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Yapƒ±:</span>
                                <span class="fw-bold" id="structure">‚Äî</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Volatilite:</span>
                                <span class="fw-bold" id="volatility">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SAƒû KOLON (ƒ∞STATƒ∞STƒ∞KLER) ========== -->
        <div class="col-lg-4">
            
            <!-- ML Modelleri -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-microchip me-2"></i>
                    ML MODELLERƒ∞
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">LightGBM</span>
                            <span class="fw-bold" id="mlLgbm">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" id="mlLgbmBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">XGBoost</span>
                            <span class="fw-bold" id="mlXgboost">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="mlXgboostBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Transformer</span>
                            <span class="fw-bold" id="mlTransformer">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-purple" id="mlTransformerBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Random Forest</span>
                            <span class="fw-bold" id="mlRf">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" id="mlRfBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-primary w-100 mt-3" onclick="trainModels()">
                        <i class="fas fa-sync-alt me-2"></i>Modelleri Eƒüit
                    </button>
                </div>
            </div>

            <!-- Veri Havuzu ƒ∞statistikleri -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-database me-2"></i>
                    VERƒ∞ HAVUZU
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Toplam Borsa:</span>
                        <span class="fw-bold" id="poolExchanges">32</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Aktif Kaynak:</span>
                        <span class="fw-bold text-success" id="poolActive">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Cache TTL:</span>
                        <span class="fw-bold" id="poolTtl">60s</span>
                    </div>
                    
                    <div class="progress mb-3">
                        <div class="progress-bar bg-primary" id="poolHealthBar" style="width: 0%"></div>
                    </div>
                    
                    <div class="small text-muted" id="poolLastUpdate">
                        <i class="fas fa-clock me-1"></i> Son: ‚Äî
                    </div>
                </div>
            </div>

            <!-- 30+ Borsa Durumu -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cloud me-2"></i>
                    30+ BORSA DURUMU
                    <span class="badge bg-primary ms-2" id="exchangeActiveCount">0/32</span>
                </div>
                <div class="card-body">
                    <div class="exchange-grid" id="exchangeGrid"></div>
                </div>
            </div>

            <!-- AI Asistan -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-robot me-2"></i>
                    AI ASƒ∞STAN
                </div>
                <div class="card-body">
                    <div id="chatMessages" style="min-height: 150px; max-height: 200px; overflow-y: auto;" class="mb-3">
                        <div class="text-muted small">
                            <i class="fas fa-info-circle me-2"></i>Analiz i√ßin "DEƒûERLENDƒ∞R" butonuna tƒ±klayƒ±n.
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="evaluateAI()">
                        <i class="fas fa-brain me-2"></i>
                        DEƒûERLENDƒ∞R
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== GLOBAL DEƒûƒ∞≈ûKENLER ====================
let currentData = null;
let ws = null;
let reconnectAttempts = 0;
let lastPrice = 0;
let tvWidget = null;
let chartRetryCount = 0;

// Borsa listesi (main.py'deki EXCHANGES listesi ile aynƒ±)
const EXCHANGES = [
    "Binance", "Bybit", "OKX", "KuCoin", "Gate.io", "MEXC", "Kraken", 
    "Bitfinex", "Huobi", "Coinbase", "Bitget", "BinanceUS", "Crypto.com",
    "Gemini", "Poloniex", "Bittrex", "Bitstamp", "LBank", "AscendEX",
    "BingX", "Phemex", "WazirX", "CoinEx", "DigiFinex", "XT.com", "ProBit",
    "BKEX", "Hotbit", "ZB.com", "Bibox", "HitBTC", "EXMO"
];

// ==================== YARDIMCI FONKSƒ∞YONLAR ====================
function formatNumber(num, decimals = 2) {
    if (num === undefined || num === null || isNaN(num)) return '‚Äî';
    return Number(num).toFixed(decimals);
}

function formatVolume(vol) {
    if (!vol) return '‚Äî';
    if (vol >= 1e9) return (vol / 1e9).toFixed(2) + 'B';
    if (vol >= 1e6) return (vol / 1e6).toFixed(2) + 'M';
    if (vol >= 1e3) return (vol / 1e3).toFixed(2) + 'K';
    return vol.toFixed(2);
}

function formatTime(timestamp) {
    if (!timestamp) return '‚Äî';
    try {
        return new Date(timestamp).toLocaleTimeString('tr-TR');
    } catch {
        return '‚Äî';
    }
}

function showNotification(msg, type = 'info') {
    // Basit bildirim - console'a yaz
    console.log(`[${type.toUpperCase()}] ${msg}`);
}

// ==================== BORSA GRID'ƒ∞Nƒ∞ OLU≈ûTUR ====================
function renderExchangeGrid() {
    const grid = document.getElementById('exchangeGrid');
    if (!grid) return;
    
    grid.innerHTML = EXCHANGES.map(ex => {
        const id = ex.toLowerCase().replace(/[^a-z]/g, '');
        return `
            <div class="exchange-item" id="ex-${id}">
                <div class="exchange-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="small fw-bold">${ex}</div>
                <div class="exchange-status" id="status-${id}">‚ö™</div>
            </div>
        `;
    }).join('');
}

// ==================== BORSA ƒ∞STATƒ∞STƒ∞KLERƒ∞Nƒ∞ G√úNCELLE ====================
function updateExchangeStats(stats) {
    if (!stats) return;
    
    let active = 0;
    
    Object.entries(stats).forEach(([name, data]) => {
        const id = name.toLowerCase().replace(/[^a-z]/g, '');
        const el = document.getElementById(`ex-${id}`);
        const statusEl = document.getElementById(`status-${id}`);
        
        if (el && statusEl) {
            if (data.success > 0) {
                el.classList.add('success');
                el.classList.remove('fail');
                statusEl.innerHTML = '‚úÖ';
                statusEl.style.color = '#10b981';
                active++;
            } else if (data.fail > 0) {
                el.classList.add('fail');
                el.classList.remove('success');
                statusEl.innerHTML = '‚ùå';
                statusEl.style.color = '#ef4444';
            } else {
                el.classList.remove('success', 'fail');
                statusEl.innerHTML = '‚è≥';
                statusEl.style.color = '#94a3b8';
            }
        }
    });
    
    document.getElementById('exchangeActiveCount').textContent = `${active}/${EXCHANGES.length}`;
    document.getElementById('poolActive').textContent = active;
}

// ==================== TRADINGVIEW CHART ====================
function initTradingView() {
    const symbol = document.getElementById('symbolSelect').value;
    const interval = document.getElementById('intervalSelect').value;
    
    const intervalMap = {
        '1m': '1', '5m': '5', '15m': '15', '30m': '30',
        '1h': '60', '4h': '240', '1d': 'D', '1w': 'W'
    };
    
    const container = document.getElementById('tradingview-widget');
    if (!container) return;
    
    // Widget'ƒ± temizle
    container.innerHTML = '';
    
    // Loading g√∂ster
    document.getElementById('chartLoading').style.display = 'flex';
    
    try {
        tvWidget = new TradingView.widget({
            width: '100%',
            height: '100%',
            symbol: `BINANCE:${symbol}USDT`,
            interval: intervalMap[interval] || '60',
            timezone: 'Europe/Istanbul',
            theme: 'dark',
            style: '1',
            locale: 'tr',
            toolbar_bg: '#11131f',
            enable_publishing: false,
            hide_top_toolbar: false,
            hide_legend: false,
            save_image: false,
            container_id: 'tradingview-widget',
            studies: [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "MASimple@tv-basicstudies"
            ],
            disabled_features: [
                "header_symbol_search",
                "header_saveload",
                "header_undo_redo",
                "left_toolbar",
                "control_bar",
                "timeframes_toolbar"
            ],
            overrides: {
                "paneProperties.background": "#11131f",
                "paneProperties.vertGridProperties.color": "#1a1d2b",
                "paneProperties.horzGridProperties.color": "#1a1d2b"
            }
        });
        
        // Widget y√ºklendiƒüinde loading'i kaldƒ±r
        setTimeout(() => {
            document.getElementById('chartLoading').style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('TradingView error:', error);
        document.getElementById('chartLoading').style.display = 'none';
        container.innerHTML = '<div class="text-center text-danger p-5">Grafik y√ºklenemedi</div>';
    }
}

// ==================== WEBSOCKET BAƒûLANTISI ====================
function connectWebSocket() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    const wsUrl = `ws://${window.location.host}/ws/${symbol}`;
    
    if (ws) {
        try { ws.close(); } catch (e) {}
    }
    
    try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            console.log('WebSocket baƒülandƒ±');
            document.getElementById('wsStatus').className = 'ws-badge ws-connected';
            document.getElementById('wsStatusText').textContent = 'BAƒûLANDI';
            reconnectAttempts = 0;
        };
        
        ws.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'price_update') {
                    updatePriceFromWS(data);
                }
            } catch (error) {
                console.error('WS mesaj hatasƒ±:', error);
            }
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket hatasƒ±:', error);
            document.getElementById('wsStatus').className = 'ws-badge ws-disconnected';
            document.getElementById('wsStatusText').textContent = 'HATA';
        };
        
        ws.onclose = () => {
            document.getElementById('wsStatus').className = 'ws-badge ws-disconnected';
            document.getElementById('wsStatusText').textContent = 'KAPALI';
            
            if (reconnectAttempts < 5) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 3000);
            }
        };
        
    } catch (error) {
        console.error('WebSocket baƒülantƒ± hatasƒ±:', error);
    }
}

// ==================== Fƒ∞YAT G√úNCELLEME ====================
function updatePriceFromWS(data) {
    const priceEl = document.getElementById('currentPrice');
    priceEl.classList.add('price-flash');
    setTimeout(() => priceEl.classList.remove('price-flash'), 300);
    
    lastPrice = data.price;
    priceEl.textContent = '$' + formatNumber(data.price);
    
    const changeEl = document.getElementById('priceChange');
    changeEl.className = data.change_percent >= 0 ? 'price-change price-up' : 'price-change price-down';
    changeEl.innerHTML = data.change_percent >= 0 
        ? `‚Üë +${data.change_percent.toFixed(2)}%` 
        : `‚Üì ${data.change_percent.toFixed(2)}%`;
    
    document.getElementById('volume24h').textContent = formatVolume(data.volume);
    document.getElementById('priceSourceCount').textContent = data.source_count || 0;
    document.getElementById('lastUpdate').innerHTML = `<i class="fas fa-clock me-1"></i> ${formatTime(new Date())}`;
}

// ==================== ANALƒ∞Z ====================
async function analyzeSymbol() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    const interval = document.getElementById('intervalSelect').value;
    
    showNotification('Analiz ba≈ülatƒ±ldƒ±...', 'info');
    
    try {
        const response = await fetch(`/api/analyze/${symbol}?interval=${interval}&limit=200`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentData = data;
            updateDashboard(data);
            showNotification('Analiz tamamlandƒ±', 'success');
        } else {
            throw new Error(data.detail || 'Analiz ba≈üarƒ±sƒ±z');
        }
        
    } catch (error) {
        console.error('Analiz hatasƒ±:', error);
        showNotification('Analiz hatasƒ±: ' + error.message, 'error');
    }
}

// ==================== DASHBOARD G√úNCELLEME ====================
function updateDashboard(data) {
    if (!data || !data.success) return;
    
    // Fiyat bilgileri
    if (data.price_data) {
        document.getElementById('currentPrice').textContent = '$' + formatNumber(data.price_data.current);
        document.getElementById('volume24h').textContent = formatVolume(data.price_data.volume_24h);
        document.getElementById('priceSourceCount').textContent = data.price_data.source_count || 0;
        document.getElementById('currentSymbol').textContent = data.symbol.replace('USDT', '/USDT');
    }
    
    // Sinyal
    if (data.signal) {
        const signal = data.signal.signal || 'NEUTRAL';
        const confidence = data.signal.confidence || 50;
        
        const badge = document.getElementById('signalBadge');
        badge.className = `signal-badge text-center signal-${signal}`;
        document.getElementById('signalText').textContent = signal.replace('_', ' ');
        
        document.getElementById('confidenceBar').style.width = confidence + '%';
        document.getElementById('confidenceText').textContent = '%' + confidence;
        document.getElementById('recommendation').textContent = data.signal.recommendation || '';
    }
    
    // Sinyal daƒüƒ±lƒ±mƒ±
    if (data.signal_distribution) {
        // Dashboard'da g√∂sterim yok ama ileride eklenebilir
    }
    
    // Teknik g√∂stergeler
    if (data.technical_indicators) {
        const tech = data.technical_indicators;
        
        // Heikin Ashi
        if (tech.ha_trend) {
            document.getElementById('haTrend').textContent = tech.ha_trend;
            document.getElementById('haRsi').textContent = tech.ha_rsi?.toFixed(1) || '‚Äî';
            document.getElementById('haStrength').textContent = tech.ha_trend_strength?.toFixed(0) + '%' || '‚Äî';
            document.getElementById('haColor').innerHTML = tech.ha_color_change === 1 ? 'üü¢' : tech.ha_color_change === -1 ? 'üî¥' : '‚ö™';
        }
        
        // Teknik g√∂sterge kartlarƒ±
        let techHtml = '';
        if (tech.rsi_value) {
            techHtml += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">RSI</span>
                    <span class="fw-bold">${tech.rsi_value.toFixed(1)}</span>
                </div>
            `;
        }
        if (tech.macd_histogram) {
            techHtml += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">MACD</span>
                    <span class="fw-bold ${tech.macd_histogram > 0 ? 'text-success' : 'text-danger'}">
                        ${tech.macd_histogram > 0 ? '+' : ''}${tech.macd_histogram.toFixed(4)}
                    </span>
                </div>
            `;
        }
        if (tech.bb_position) {
            techHtml += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Bollinger %</span>
                    <span class="fw-bold">${tech.bb_position.toFixed(1)}%</span>
                </div>
            `;
        }
        if (tech.volume_ratio) {
            techHtml += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Hacim Oranƒ±</span>
                    <span class="fw-bold">${tech.volume_ratio.toFixed(2)}x</span>
                </div>
            `;
        }
        document.getElementById('technicalIndicators').innerHTML = techHtml || '<div class="text-muted">Veri yok</div>';
    }
    
    // Patternler
    if (data.patterns && data.patterns.length > 0) {
        const patternHtml = data.patterns.slice(0, 5).map(p => `
            <span class="badge ${p.direction === 'bullish' ? 'bg-success' : p.direction === 'bearish' ? 'bg-danger' : 'bg-secondary'}">
                ${p.name}
            </span>
        `).join('');
        document.getElementById('patterns').innerHTML = patternHtml;
    }
    
    // Market yapƒ±sƒ±
    if (data.market_structure) {
        const ms = data.market_structure;
        document.getElementById('trend').textContent = ms.trend || '‚Äî';
        document.getElementById('structure').textContent = ms.structure || '‚Äî';
        document.getElementById('volatility').textContent = ms.volatility || '‚Äî';
    }
    
    // ML istatistikleri
    if (data.ml_stats) {
        const stats = data.ml_stats;
        
        document.getElementById('mlLgbm').textContent = (stats.lightgbm || 0).toFixed(1) + '%';
        document.getElementById('mlLgbmBar').style.width = (stats.lightgbm || 0) + '%';
        
        document.getElementById('mlXgboost').textContent = (stats.xgboost || 0).toFixed(1) + '%';
        document.getElementById('mlXgboostBar').style.width = (stats.xgboost || 0) + '%';
        
        document.getElementById('mlTransformer').textContent = (stats.transformer || 0).toFixed(1) + '%';
        document.getElementById('mlTransformerBar').style.width = (stats.transformer || 0) + '%';
        
        document.getElementById('mlRf').textContent = (stats.random_forest || 0).toFixed(1) + '%';
        document.getElementById('mlRfBar').style.width = (stats.random_forest || 0) + '%';
    }
    
    // Borsa istatistiklerini al ve g√ºncelle
    fetchExchangeStats();
    
    // Son g√ºncelleme zamanƒ±
    document.getElementById('lastUpdate').innerHTML = `<i class="fas fa-clock me-1"></i> ${formatTime(new Date())}`;
}

// ==================== BORSA ƒ∞STATƒ∞STƒ∞KLERƒ∞ ====================
async function fetchExchangeStats() {
    try {
        const response = await fetch('/api/exchange-stats');
        const data = await response.json();
        
        if (data.success) {
            updateExchangeStats(data.stats);
            
            // Veri havuzu bilgileri
            const totalSuccess = Object.values(data.stats).reduce((acc, s) => acc + (s.success || 0), 0);
            const totalFail = Object.values(data.stats).reduce((acc, s) => acc + (s.fail || 0), 0);
            const health = (totalSuccess / (totalSuccess + totalFail || 1)) * 100;
            
            document.getElementById('poolHealthBar').style.width = health + '%';
            document.getElementById('poolLastUpdate').innerHTML = `<i class="fas fa-clock me-1"></i> Son: ${formatTime(new Date())}`;
        }
    } catch (error) {
        console.error('Exchange stats error:', error);
    }
}

// ==================== MODEL Eƒûƒ∞Tƒ∞Mƒ∞ ====================
async function trainModels() {
    const symbol = document.getElementById('symbolSelect').value + 'USDT';
    
    showNotification('Modeller eƒüitiliyor...', 'info');
    
    try {
        const response = await fetch(`/api/train/${symbol}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            showNotification('Eƒüitim tamamlandƒ±!', 'success');
            setTimeout(analyzeSymbol, 2000);
        } else {
            showNotification('Eƒüitim ba≈üarƒ±sƒ±z', 'error');
        }
        
    } catch (error) {
        console.error('Training error:', error);
        showNotification('Eƒüitim hatasƒ±', 'error');
    }
}

// ==================== AI DEƒûERLENDƒ∞RME ====================
function evaluateAI() {
    if (!currentData) {
        showNotification('√ñnce analiz yapƒ±n', 'warning');
        return;
    }
    
    const chatDiv = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = 'mb-2 p-2 rounded';
    msg.style.background = 'rgba(59, 130, 246, 0.1)';
    
    const signal = currentData.signal?.signal || 'NEUTRAL';
    const confidence = currentData.signal?.confidence || 0;
    const price = currentData.price_data?.current || 0;
    const rsi = currentData.technical_indicators?.rsi_value || 50;
    
    let analysis = '';
    if (confidence > 70) {
        analysis = 'G√º√ßl√º sinyal, i≈ülem hacmi y√ºksek';
    } else if (confidence > 60) {
        analysis = 'Orta seviye sinyal, teyit beklenmeli';
    } else {
        analysis = 'Zayƒ±f sinyal, temkinli olunmalƒ±';
    }
    
    msg.innerHTML = `
        <div class="small">
            <i class="fas fa-robot me-2" style="color: var(--accent-primary);"></i>
            <strong>AI Analizi</strong><br>
            Sinyal: ${signal.replace('_', ' ')} (${confidence}%)<br>
            Fiyat: $${formatNumber(price)} | RSI: ${rsi.toFixed(1)}<br>
            ${analysis}<br>
            <span class="text-muted">‚ö†Ô∏è Yatƒ±rƒ±m tavsiyesi deƒüildir</span>
        </div>
    `;
    
    chatDiv.appendChild(msg);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// ==================== EVENT LISTENER'LAR ====================
document.getElementById('symbolSelect').addEventListener('change', () => {
    connectWebSocket();
    initTradingView();
    analyzeSymbol();
});

document.getElementById('intervalSelect').addEventListener('change', () => {
    initTradingView();
    analyzeSymbol();
});

// ==================== BA≈ûLANGI√á ====================
window.addEventListener('load', async () => {
    console.log('üöÄ ICTSMARTPRO v8.0 ba≈ülatƒ±lƒ±yor...');
    
    // Borsa grid'ini olu≈ütur
    renderExchangeGrid();
    
    // TradingView'i ba≈ülat
    initTradingView();
    
    // WebSocket baƒülantƒ±sƒ±
    connectWebSocket();
    
    // Backend durumunu kontrol et
    try {
        const health = await fetch('/health');
        if (health.ok) {
            document.getElementById('backendStatus').innerHTML = '<i class="fas fa-circle me-2" style="color: #10b981; font-size: 0.6rem;"></i>BAƒûLANDI';
        }
    } catch (error) {
        document.getElementById('backendStatus').innerHTML = '<i class="fas fa-circle me-2" style="color: #ef4444; font-size: 0.6rem;"></i>BAƒûLANTI YOK';
    }
    
    // ƒ∞lk analizi yap
    setTimeout(analyzeSymbol, 1000);
    
    // Borsa istatistiklerini d√ºzenli g√ºncelle
    setInterval(fetchExchangeStats, 30000);
});
</script>
</body>
</html>
